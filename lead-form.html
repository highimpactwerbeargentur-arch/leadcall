<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ihre Anfrage</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #111;
        }
        
        .subtitle {
            font-size: 15px;
            color: #666;
            margin-bottom: 24px;
        }
        
        .form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        
        .optional {
            font-weight: 400;
            color: #999;
        }
        
        input[type="text"],
        input[type="tel"],
        input[type="email"],
        select,
        textarea {
            padding: 12px 14px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
            font-family: inherit;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            border-color: #2563eb;
        }
        
        select {
            background: white;
            cursor: pointer;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: 400;
        }
        
        input[type="radio"] {
            width: 18px;
            height: 18px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            font-weight: 400;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
        }
        
        .checkbox-text {
            font-size: 14px;
            color: #555;
            line-height: 1.4;
        }
        
        .checkbox-text a {
            color: #2563eb;
            text-decoration: none;
        }
        
        button {
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background-color: #2563eb;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 8px;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #1d4ed8;
        }
        
        button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        
        .error {
            padding: 12px 16px;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #dc2626;
            font-size: 14px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .footer {
            text-align: center;
            font-size: 13px;
            color: #999;
            margin-top: 20px;
        }
        
        /* Erfolgs-Seite */
        .success {
            display: none;
            text-align: center;
        }
        
        .success.show {
            display: block;
        }
        
        .success-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: #22c55e;
            color: white;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        
        .success h1 {
            text-align: center;
            margin-bottom: 12px;
        }
        
        .success p {
            color: #333;
            margin-bottom: 8px;
        }
        
        .success .subtext {
            color: #888;
            font-size: 14px;
        }
        
        .form-container.hidden {
            display: none;
        }
        
        /* Bild-Upload */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .file-upload:hover {
            border-color: #2563eb;
        }
        
        .file-upload.dragging {
            border-color: #2563eb;
            background: #f0f7ff;
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-upload-text {
            color: #666;
            font-size: 14px;
        }
        
        .file-upload-text span {
            color: #2563eb;
            font-weight: 500;
        }
        
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .image-preview-item button {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            padding: 0;
            border-radius: 50%;
            background: #dc2626;
            color: white;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="card">
        <!-- Erfolgs-Anzeige (versteckt) -->
        <div class="success" id="success">
            <div class="success-icon">✓</div>
            <h1>Vielen Dank!</h1>
            <p>Wir haben Ihre Anfrage erhalten und melden uns schnellstmöglich bei Ihnen.</p>
            <p class="subtext">Sie können dieses Fenster jetzt schließen.</p>
        </div>
        
        <!-- Formular -->
        <div class="form-container" id="formContainer">
            <h1>Ihre Anfrage</h1>
            <p class="subtitle">Bitte teilen Sie uns kurz mit, wie wir Ihnen helfen können.</p>
            
            <div class="error" id="error"></div>
            
            <form class="form" id="leadForm">
                <div class="field">
                    <label for="name">Name *</label>
                    <input type="text" id="name" name="name" placeholder="Ihr Name" required>
                </div>
                
                <div class="field">
                    <label for="phone">Telefonnummer *</label>
                    <input type="tel" id="phone" name="phone" placeholder="+49 170 1234567" required>
                </div>
                
                <div class="field">
                    <label for="email">E-Mail <span class="optional">(optional)</span></label>
                    <input type="email" id="email" name="email" placeholder="ihre@email.de">
                </div>
                
                <div class="field">
                    <label for="company">Firma <span class="optional">(optional)</span></label>
                    <input type="text" id="company" name="company" placeholder="Firmenname">
                </div>
                
                <div class="field">
                    <label for="service_type">Um was geht es? *</label>
                    <select id="service_type" name="service_type" required>
                        <option value="">Bitte wählen...</option>
                        <option value="sanitaer">Sanitär</option>
                        <option value="heizung">Heizung</option>
                        <option value="elektro">Elektro</option>
                        <option value="renovierung">Renovierung</option>
                        <option value="beratung">Beratung</option>
                        <option value="sonstiges">Sonstiges</option>
                    </select>
                </div>
                
                <div class="field">
                    <label for="description">Beschreiben Sie kurz Ihr Anliegen</label>
                    <textarea id="description" name="description" placeholder="Was können wir für Sie tun?"></textarea>
                </div>
                
                <div class="field">
                    <label>Wie dringend ist es?</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="urgency" value="today">
                            <span>Heute noch</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="urgency" value="this_week">
                            <span>Diese Woche</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="urgency" value="flexible" checked>
                            <span>Flexibel</span>
                        </label>
                    </div>
                </div>
                
                <div class="field">
                    <label for="budget">Geschätztes Budget <span class="optional">(optional)</span></label>
                    <select id="budget" name="budget">
                        <option value="">Bitte wählen...</option>
                        <option value="under_500">Unter 500€</option>
                        <option value="500_2000">500€ - 2.000€</option>
                        <option value="2000_5000">2.000€ - 5.000€</option>
                        <option value="over_5000">Über 5.000€</option>
                        <option value="unknown">Weiß ich noch nicht</option>
                    </select>
                </div>
                
                <div class="field">
                    <label>Fotos <span class="optional">(optional, max. 3 Bilder)</span></label>
                    <div class="file-upload" id="fileUpload">
                        <input type="file" id="imageInput" accept="image/*" multiple>
                        <div class="file-upload-text">
                            <span>Bilder auswählen</span> oder hierher ziehen
                        </div>
                    </div>
                    <div class="image-preview" id="imagePreview"></div>
                </div>
                
                <div class="field">
                    <label class="checkbox-label">
                        <input type="checkbox" id="privacy" name="privacy" required>
                        <span class="checkbox-text">
                            Ich akzeptiere die <a href="/datenschutz" target="_blank">Datenschutzerklärung</a> *
                        </span>
                    </label>
                </div>
                
                <button type="submit" id="submitBtn">Anfrage absenden</button>
            </form>
        </div>
    </div>
    
    <p class="footer">Ihre Daten werden vertraulich behandelt.</p>

    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://fbkkyzvumytipjtnrjrn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZia2t5enZ1bXl0aXBqdG5yanJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzM0MTMsImV4cCI6MjA4NTI0OTQxM30.FsdSHmWuyP5QiKqGbaDG6XZJiAzaOKdsbqgrXKrfQCk';
        const TENANT_ID = '38ead1f3-74be-4db3-a61b-27f9152d2478';
        
        // URL-Parameter auslesen
        const urlParams = new URLSearchParams(window.location.search);
        const tenantId = urlParams.get('t') || urlParams.get('tenant') || TENANT_ID;
        const prefillPhone = urlParams.get('p') || urlParams.get('phone') || '';
        
        // Telefon vorausfüllen falls vorhanden
        if (prefillPhone) {
            document.getElementById('phone').value = prefillPhone;
        }
        
        // Elemente
        const form = document.getElementById('leadForm');
        const errorDiv = document.getElementById('error');
        const submitBtn = document.getElementById('submitBtn');
        const formContainer = document.getElementById('formContainer');
        const successDiv = document.getElementById('success');
        
        // Bild-Upload
        const fileUpload = document.getElementById('fileUpload');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        let selectedFiles = [];
        
        fileUpload.addEventListener('click', () => imageInput.click());
        
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('dragging');
        });
        
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('dragging');
        });
        
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('dragging');
            handleFiles(e.dataTransfer.files);
        });
        
        imageInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        function handleFiles(files) {
            for (let file of files) {
                if (selectedFiles.length >= 3) break;
                if (!file.type.startsWith('image/')) continue;
                selectedFiles.push(file);
            }
            updatePreview();
        }
        
        function updatePreview() {
            imagePreview.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'image-preview-item';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '×';
                btn.onclick = () => {
                    selectedFiles.splice(index, 1);
                    updatePreview();
                };
                
                div.appendChild(img);
                div.appendChild(btn);
                imagePreview.appendChild(div);
            });
        }
        
        // Bilder hochladen Funktion
        async function uploadImages(leadId) {
            const urls = [];
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const fileName = `${leadId}/${Date.now()}_${i}.${file.name.split('.').pop()}`;
                
                const response = await fetch(`${SUPABASE_URL}/storage/v1/object/lead-images/${fileName}`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': file.type
                    },
                    body: file
                });
                
                if (response.ok) {
                    urls.push(`${SUPABASE_URL}/storage/v1/object/public/lead-images/${fileName}`);
                }
            }
            return urls;
        }
        
        // Fehler anzeigen
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        
        // Fehler verstecken
        function hideError() {
            errorDiv.classList.remove('show');
        }
        
        // Formular absenden
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();
            
            // Button deaktivieren
            submitBtn.disabled = true;
            submitBtn.textContent = 'Wird gesendet...';
            
            try {
                // Daten sammeln
                const formData = new FormData(form);
                
                // Validierung
                if (!formData.get('name').trim()) throw new Error('Bitte geben Sie Ihren Namen ein');
                if (!formData.get('phone').trim()) throw new Error('Bitte geben Sie Ihre Telefonnummer ein');
                if (!formData.get('service_type')) throw new Error('Bitte wählen Sie eine Kategorie');
                if (!formData.get('privacy')) throw new Error('Bitte akzeptieren Sie die Datenschutzerklärung');
                
                // Telefonnummer formatieren (deutsche Nummern zu +49)
                function formatPhoneNumber(phone) {
                    let cleaned = phone.replace(/[\s\-\/\(\)]/g, ''); // Leerzeichen etc. entfernen
                    
                    if (cleaned.startsWith('0049')) {
                        cleaned = '+49' + cleaned.substring(4);
                    } else if (cleaned.startsWith('49') && !cleaned.startsWith('+')) {
                        cleaned = '+49' + cleaned.substring(2);
                    } else if (cleaned.startsWith('0')) {
                        cleaned = '+49' + cleaned.substring(1);
                    } else if (!cleaned.startsWith('+')) {
                        cleaned = '+49' + cleaned;
                    }
                    
                    return cleaned;
                }
                
                // Lead-Daten vorbereiten
                const leadData = {
                    tenant_id: tenantId,
                    name: formData.get('name').trim(),
                    phone: formatPhoneNumber(formData.get('phone').trim()),
                    email: formData.get('email').trim() || null,
                    company: formData.get('company').trim() || null,
                    service_type: formData.get('service_type'),
                    description: formData.get('description').trim() || null,
                    urgency: formData.get('urgency') || 'flexible',
                    budget: formData.get('budget') || null,
                    privacy_accepted: true,
                    privacy_accepted_at: new Date().toISOString(),
                    form_submitted_at: new Date().toISOString(),
                    status: 'new'
                };
                
                console.log('Sende Daten:', leadData);
                
                // An Supabase senden
                const response = await fetch(`${SUPABASE_URL}/rest/v1/leads`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(leadData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Fehler ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Erfolg:', result);
                
                // Bilder hochladen falls vorhanden
                if (selectedFiles.length > 0 && result[0]?.id) {
                    const imageUrls = await uploadImages(result[0].id);
                    if (imageUrls.length > 0) {
                        await fetch(`${SUPABASE_URL}/rest/v1/leads?id=eq.${result[0].id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({ image_urls: imageUrls })
                        });
                        console.log('Bilder hochgeladen:', imageUrls);
                    }
                }
                
                // E-Mail-Benachrichtigung senden
                try {
                    emailjs.init('fc6zzeTCmrKyrkxJ2');
                    await emailjs.send('service_te0rxxz', 'template_qr2bxjn', {
                        name: leadData.name,
                        phone: leadData.phone,
                        email: leadData.email || '-',
                        company: leadData.company || '-',
                        service_type: leadData.service_type,
                        urgency: leadData.urgency,
                        description: leadData.description || '-',
                        dashboard_link: 'https://leadcall-git-main-tristans-projects-7ffa8023.vercel.app'
                    });
                    console.log('E-Mail gesendet');
                } catch (emailErr) {
                    console.error('E-Mail-Fehler:', emailErr);
                }
                
                // Bestätigungs-SMS über Twilio senden
                try {
                    const TWILIO_ACCOUNT_SID = 'AC69e8a043f6049873ad18f1a84fd46e42';
                    const TWILIO_AUTH_TOKEN = 'dad41a9b13d9d8b3e96df73ddc0b58d4';
                    const TWILIO_PHONE_NUMBER = '+13135460107';
                    
                    const smsText = 'Vielen Dank für Ihre Anfrage! Wir haben alles erhalten und melden uns schnellstmöglich bei Ihnen.';
                    
                    const twilioAuth = btoa(`${TWILIO_ACCOUNT_SID}:${TWILIO_AUTH_TOKEN}`);
                    
                    await fetch(`https://api.twilio.com/2010-04-01/Accounts/${TWILIO_ACCOUNT_SID}/Messages.json`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Basic ${twilioAuth}`,
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            From: TWILIO_PHONE_NUMBER,
                            To: leadData.phone,
                            Body: smsText
                        })
                    });
                    console.log('Bestätigungs-SMS gesendet');
                } catch (smsErr) {
                    console.error('SMS-Fehler:', smsErr);
                }
                
                // Erfolgs-Seite zeigen
                formContainer.classList.add('hidden');
                successDiv.classList.add('show');
                
            } catch (err) {
                console.error('Fehler:', err);
                showError(err.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Anfrage absenden';
            }
        });
    </script>
</body>
</html>
