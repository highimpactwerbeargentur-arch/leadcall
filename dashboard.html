<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadCall24 Dashboard</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f1f5f9;min-height:100vh;color:#1e293b}

        /* LOGIN */
        .login-overlay{position:fixed;inset:0;background:#f1f5f9;display:flex;justify-content:center;align-items:center;z-index:1000}
        .login-overlay.hidden{display:none}
        .login-box{background:white;padding:32px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);width:100%;max-width:380px;text-align:center}
        .login-logo{font-size:24px;font-weight:700;color:#2563eb;margin-bottom:4px}
        .login-subtitle{color:#64748b;font-size:14px;margin-bottom:24px}
        .login-field{text-align:left;margin-bottom:16px}
        .login-field label{display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px}
        .login-input{width:100%;padding:12px 16px;font-size:15px;border:1px solid #e2e8f0;border-radius:8px;outline:none;transition:border-color .15s}
        .login-input:focus{border-color:#2563eb}
        .login-btn{width:100%;padding:12px;font-size:16px;font-weight:600;color:white;background:#2563eb;border:none;border-radius:8px;cursor:pointer;margin-top:8px}
        .login-btn:hover{background:#1d4ed8}
        .login-btn:disabled{opacity:.6;cursor:not-allowed}
        .login-error{color:#dc2626;font-size:14px;margin-bottom:16px;display:none;text-align:center}
        .login-error.show{display:block}
        .login-step{display:none}
        .login-step.active{display:block}
        .login-back{display:inline-flex;align-items:center;gap:4px;font-size:13px;color:#64748b;cursor:pointer;margin-bottom:16px;border:none;background:none}
        .login-back:hover{color:#2563eb}
        .login-welcome{font-size:16px;font-weight:600;color:#1e293b;margin-bottom:4px}
        .pw-match{font-size:12px;margin-top:4px}
        .pw-match.ok{color:#16a34a}
        .pw-match.no{color:#dc2626}
        .setup-info{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 16px;margin-bottom:20px;text-align:left}
        .setup-info p{font-size:13px;color:#1e40af;line-height:1.5}

        /* HEADER */
        .main-content{display:none}
        .main-content.show{display:block}
        .header{background:white;border-bottom:1px solid #e2e8f0;padding:0 24px;height:56px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50}
        .header-left{display:flex;align-items:center;gap:24px}
        .logo{font-size:20px;font-weight:700;color:#2563eb}
        .header-nav{display:flex;gap:2px}
        .header-nav button{padding:8px 16px;font-size:14px;font-weight:500;background:none;border:none;color:#64748b;cursor:pointer;border-radius:6px;transition:all .15s}
        .header-nav button:hover{background:#f1f5f9;color:#1e293b}
        .header-nav button.active{background:#eff6ff;color:#2563eb;font-weight:600}
        .header-right{display:flex;align-items:center;gap:10px;font-size:14px;color:#64748b}
        .header-user{display:flex;align-items:center;gap:8px}
        .header-user .user-name{font-weight:600;color:#1e293b}
        .admin-badge{display:inline-block;padding:2px 8px;background:#fef3c7;color:#b45309;border-radius:4px;font-size:11px;font-weight:700;text-transform:uppercase}
        .hdr-btn{padding:6px 12px;font-size:13px;background:none;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;color:#64748b;transition:all .15s}
        .hdr-btn:hover{border-color:#cbd5e1;color:#1e293b}
        .hdr-btn.logout:hover{border-color:#dc2626;color:#dc2626}

        /* LAYOUT */
        .container{max-width:1400px;margin:0 auto;padding:24px}
        .tab-view{display:none}
        .tab-view.active{display:block}

        /* KPI */
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px}
        .kpi-card{background:white;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
        .kpi-value{font-size:32px;font-weight:700;color:#1e293b;margin-bottom:4px}
        .kpi-label{font-size:14px;color:#64748b}
        .kpi-card.hl{background:linear-gradient(135deg,#2563eb,#1d4ed8)}
        .kpi-card.hl .kpi-value,.kpi-card.hl .kpi-label{color:white}
        .kpi-card.ok .kpi-value{color:#16a34a}
        .kpi-card.bad .kpi-value{color:#dc2626}
        .kpi-card.warn .kpi-value{color:#b45309}

        /* SECTION */
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
        .section-title{font-size:18px;font-weight:600}
        .header-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .filter-group{display:flex;gap:4px;background:white;padding:4px;border-radius:8px;border:1px solid #e2e8f0}
        .filter-btn{padding:6px 12px;font-size:13px;background:transparent;border:none;border-radius:6px;cursor:pointer;color:#64748b}
        .filter-btn:hover{background:#f1f5f9}
        .filter-btn.active{background:#2563eb;color:white}
        .sort-select{padding:8px 12px;font-size:13px;border:1px solid #e2e8f0;border-radius:8px;background:white;cursor:pointer}
        .refresh-btn{padding:8px 16px;font-size:14px;background:white;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer}
        .refresh-btn:hover{background:#f8fafc}

        /* TABLE */
        .card{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);overflow:hidden}
        table{width:100%;border-collapse:collapse}
        thead th{text-align:left;padding:14px 16px;font-size:12px;font-weight:600;text-transform:uppercase;color:#64748b;background:#f8fafc;border-bottom:1px solid #e2e8f0}
        tbody td{padding:14px 16px;font-size:14px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
        tbody tr:last-child td{border-bottom:none}
        tbody tr:hover{background:#f8fafc}
        tbody tr.clickable{cursor:pointer}

        /* BADGES */
        .badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:500}
        .b-new{background:#dbeafe;color:#1d4ed8}
        .b-contacted{background:#fef3c7;color:#b45309}
        .b-offer_sent,.b-in_progress{background:#e0e7ff;color:#4338ca}
        .b-won,.b-completed{background:#dcfce7;color:#16a34a}
        .b-lost,.b-rejected{background:#fee2e2;color:#dc2626}
        .b-bestandskunde{background:#f0fdf4;color:#166534;border:1px solid #86efac}
        .budget-badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600}
        .bg-h{background:#dcfce7;color:#16a34a}
        .bg-m{background:#fef3c7;color:#b45309}
        .bg-l{background:#f1f5f9;color:#64748b}
        .u-today{color:#dc2626;font-weight:600}
        .u-this_week{color:#b45309}
        .u-flexible{color:#64748b}
        .svc-tag{display:inline-block;padding:2px 8px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:4px;font-size:11px;color:#64748b;margin:1px}
        .has-notes{color:#2563eb;font-size:12px;margin-left:4px}
        .action-select{padding:6px 10px;font-size:13px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer}
        .time-ago{font-size:13px;color:#64748b}
        .empty-state{padding:48px;text-align:center;color:#64748b}
        .empty-state h3{margin-bottom:8px;color:#475569}
        .loading{padding:48px;text-align:center;color:#64748b}

        /* MODAL */
        .mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100;justify-content:center;align-items:center}
        .mo.show{display:flex}
        .md{background:white;border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
        .md h2{margin-bottom:16px;font-size:18px}
        .mf{margin-bottom:12px}
        .ml{font-size:12px;color:#64748b;text-transform:uppercase;margin-bottom:4px}
        .mv{font-size:15px;color:#1e293b}
        .mc{margin-top:16px;padding:10px 20px;background:#f1f5f9;border:none;border-radius:8px;cursor:pointer;font-size:14px}
        .mc:hover{background:#e2e8f0}
        .mi{width:100%;padding:10px 14px;font-size:15px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:12px;outline:none;font-family:inherit}
        .mi:focus{border-color:#2563eb}
        .mt{width:100%;padding:10px 14px;font-size:15px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:12px;outline:none;min-height:80px;resize:vertical;font-family:inherit}
        .btn{padding:10px 20px;font-size:14px;font-weight:600;color:white;background:#2563eb;border:none;border-radius:8px;cursor:pointer;margin-right:8px}
        .btn:hover{background:#1d4ed8}
        .btn:disabled{opacity:.6;cursor:not-allowed}
        .btn.sec{background:#f1f5f9;color:#1e293b}
        .btn.sec:hover{background:#e2e8f0}
        .btn.red{background:#dc2626}
        .btn.grn{background:#16a34a}
        .btn.grn:hover{background:#15803d}
        .il{display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px}

        /* SLIDE */
        .slo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;justify-content:flex-end}
        .slo.show{display:flex}
        .slp{width:520px;max-width:100%;background:white;height:100vh;overflow-y:auto;box-shadow:-4px 0 24px rgba(0,0,0,.1);animation:si .2s ease}
        @keyframes si{from{transform:translateX(100%)}to{transform:translateX(0)}}
        .sl-top{padding:20px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:white;z-index:1}
        .sl-top h2{font-size:18px}
        .cl-btn{width:32px;height:32px;background:#f1f5f9;border:none;border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;color:#64748b}
        .cl-btn:hover{background:#e2e8f0}
        .sl-body{padding:24px}
        .dg{margin-bottom:24px}
        .dg-t{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #f1f5f9}
        .dr{display:grid;grid-template-columns:130px 1fr;gap:8px;margin-bottom:8px;font-size:14px}
        .dl{color:#64748b;font-weight:500}
        .dv{color:#1e293b}
        .sl-act{padding:20px 24px;border-top:1px solid #e2e8f0;display:flex;gap:8px;position:sticky;bottom:0;background:white}
        .sl-act .btn{flex:1;text-align:center}

        /* TENANT CARDS */
        .tg{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
        .tc{background:white;border-radius:12px;padding:20px 24px;box-shadow:0 1px 3px rgba(0,0,0,.08);border:1px solid #e2e8f0}
        .tc-name{font-size:16px;font-weight:700;margin-bottom:2px}
        .tc-email{font-size:13px;color:#64748b;margin-bottom:10px}
        .tc-meta{display:flex;gap:16px;font-size:12px;color:#94a3b8;margin-bottom:12px}
        .tc-id{padding:6px 10px;background:#f8fafc;border-radius:6px;font-size:11px;color:#94a3b8;font-family:monospace;word-break:break-all;margin-bottom:12px}
        .tc-login{border-top:1px solid #f1f5f9;padding-top:12px}
        .tc-login h4{font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.3px;margin-bottom:8px}
        .tc-row{display:flex;gap:8px;align-items:end}
        .tc-row .fld{flex:1;display:flex;flex-direction:column;gap:4px}
        .tc-row .fld label{font-size:11px;color:#94a3b8;font-weight:600}
        .tc-row input{padding:8px 10px;font-size:13px;border:1px solid #e2e8f0;border-radius:6px;font-family:inherit;outline:none;width:100%}
        .tc-row input:focus{border-color:#2563eb}
        .tc-row button{padding:8px 14px;font-size:12px;font-weight:600;background:#2563eb;color:white;border:none;border-radius:6px;cursor:pointer;white-space:nowrap;height:36px}
        .pw-st{font-size:11px;margin-top:6px}
        .pw-st.set{color:#16a34a}
        .pw-st.notset{color:#b45309}
        .pw-ok{color:#16a34a;font-size:14px;text-align:center;margin-bottom:12px;display:none}
        .pw-ok.show{display:block}

        @media(max-width:768px){
            .container{padding:16px}
            .kpi-grid{grid-template-columns:repeat(2,1fr)}
            .header-nav{display:none}
            .section-header{flex-direction:column;align-items:flex-start}
            .slp{width:100%}
            .header{padding:0 16px}
            .mob-nav{display:flex;gap:2px;padding:8px 16px;background:white;border-bottom:1px solid #e2e8f0;overflow-x:auto}
            .mob-nav button{padding:8px 14px;font-size:13px;font-weight:500;background:none;border:none;color:#64748b;cursor:pointer;border-radius:6px;white-space:nowrap}
            .mob-nav button.active{background:#eff6ff;color:#2563eb;font-weight:600}
            .tc-row{flex-direction:column}
        }
        @media(min-width:769px){.mob-nav{display:none}}

        /* NEW LEAD */
        .nl-cats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .nl-cat{display:flex;align-items:center;gap:8px;padding:10px 14px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;font-size:14px;transition:all .15s}
        .nl-cat:hover{border-color:#93c5fd}
        .nl-cat input{display:none}
        .nl-cat:has(input:checked){border-color:#2563eb;background:#eff6ff}
        .nl-sub{margin-bottom:4px;padding:12px 16px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0}

        /* ANGEBOT */
        .ang-overlay{display:none;position:fixed;inset:0;background:#f1f5f9;z-index:300;overflow-y:auto}
        .ang-overlay.show{display:block}
        .ang-header{background:white;border-bottom:1px solid #e2e8f0;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1}
        .ang-header h2{font-size:18px}
        .ang-body{max-width:900px;margin:24px auto;padding:0 24px}
        .ang-section{background:white;border-radius:12px;padding:24px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
        .ang-section h3{font-size:14px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:16px}
        .ang-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
        .ang-full{margin-bottom:12px}
        .ang-label{font-size:12px;font-weight:600;color:#64748b;margin-bottom:4px}
        .ang-input{width:100%;padding:10px 14px;font-size:14px;border:1px solid #e2e8f0;border-radius:8px;outline:none;font-family:inherit}
        .ang-input:focus{border-color:#2563eb}
        .ang-table{width:100%;border-collapse:collapse;margin-top:8px}
        .ang-table th{text-align:left;padding:10px 12px;font-size:12px;font-weight:600;color:#64748b;background:#f8fafc;border-bottom:1px solid #e2e8f0}
        .ang-table td{padding:8px 12px;border-bottom:1px solid #f1f5f9}
        .ang-table input{width:100%;padding:8px 10px;font-size:14px;border:1px solid #e2e8f0;border-radius:6px;outline:none;font-family:inherit}
        .ang-table input:focus{border-color:#2563eb}
        .ang-table .col-pos{width:50px}
        .ang-table .col-desc{min-width:200px}
        .ang-table .col-num{width:80px}
        .ang-table .col-price{width:100px}
        .ang-table .col-total{width:100px;font-weight:600;text-align:right;padding-right:12px}
        .ang-table .col-del{width:40px;text-align:center}
        .ang-del{background:none;border:none;color:#dc2626;cursor:pointer;font-size:16px;padding:4px}
        .ang-del:hover{color:#b91c1c}
        .ang-add{margin-top:8px;padding:8px 16px;font-size:13px;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:8px;cursor:pointer;color:#64748b;width:100%}
        .ang-add:hover{background:#eff6ff;border-color:#93c5fd;color:#2563eb}
        .ang-totals{margin-top:16px;text-align:right}
        .ang-totals div{margin-bottom:4px;font-size:14px;color:#64748b}
        .ang-totals .ang-brutto{font-size:18px;font-weight:700;color:#1e293b}
        .ang-actions{display:flex;gap:8px;flex-wrap:wrap}
        .ang-status{margin-top:12px;padding:12px 16px;border-radius:8px;font-size:14px;display:none}
        .ang-status.show{display:block}
        .ang-status.ok{background:#dcfce7;color:#166534}
        .ang-status.err{background:#fee2e2;color:#dc2626}
    </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <div class="login-logo">LeadCall24</div>
        <div class="login-step active" id="stepUser">
            <div class="login-subtitle">Bitte melden Sie sich an</div>
            <div class="login-error" id="errUser">Benutzername nicht gefunden</div>
            <div class="login-field"><label>Benutzername</label><input type="text" class="login-input" id="inUser" placeholder="Ihr Benutzername" autocomplete="username"></div>
            <button class="login-btn" id="btnUser">Weiter</button>
        </div>
        <div class="login-step" id="stepPw">
            <button class="login-back" onclick="goStep('user')">‚Üê Zur√ºck</button>
            <div class="login-welcome" id="welcName"></div>
            <div class="login-subtitle">Bitte geben Sie Ihr Passwort ein</div>
            <div class="login-error" id="errPw">Falsches Passwort</div>
            <div class="login-field"><label>Passwort</label><input type="password" class="login-input" id="inPw" placeholder="Ihr Passwort" autocomplete="current-password"></div>
            <button class="login-btn" id="btnPw">Anmelden</button>
        </div>
        <div class="login-step" id="stepSetPw">
            <button class="login-back" onclick="goStep('user')">‚Üê Zur√ºck</button>
            <div class="login-welcome" id="setupName"></div>
            <div class="setup-info"><p>üëã Willkommen! Dies ist Ihr erster Login. Bitte legen Sie jetzt ein pers√∂nliches Passwort fest.</p></div>
            <div class="login-error" id="errSetPw"></div>
            <div class="login-field"><label>Neues Passwort</label><input type="password" class="login-input" id="inNewPw" placeholder="Mindestens 6 Zeichen"></div>
            <div class="login-field"><label>Passwort wiederholen</label><input type="password" class="login-input" id="inConfPw" placeholder="Passwort best√§tigen"><div class="pw-match" id="pwMatch1"></div></div>
            <button class="login-btn" id="btnSetPw">Passwort festlegen & anmelden</button>
        </div>
    </div>
</div>

<!-- MAIN -->
<div class="main-content" id="mainContent">
    <header class="header">
        <div class="header-left">
            <div class="logo">LeadCall24</div>
            <div class="header-nav" id="headerNav"></div>
        </div>
        <div class="header-right">
            <div class="header-user">
                <span class="user-name" id="headerTitle"></span>
                <span class="admin-badge" id="adminBadge" style="display:none">Admin</span>
            </div>
            <button class="hdr-btn" id="changePwBtn" style="display:none" onclick="openChangePw()">üîë Passwort √§ndern</button>
            <button class="hdr-btn logout" onclick="doLogout()">Abmelden</button>
        </div>
    </header>
    <div class="mob-nav" id="mobNav"></div>
    <div class="container">
        <!-- LEADS -->
        <div class="tab-view" id="tab-leads">
            <div class="kpi-grid" id="kpiGrid"></div>
            <div class="section-header"><h2 class="section-title">Alle Anfragen</h2><div class="header-actions"><button class="btn" onclick="openNewLead()" style="font-size:13px;padding:8px 16px">+ Neuer Lead</button><div class="filter-group" id="leadFG"></div><select class="sort-select" onchange="leadSort=this.value;renderLeads()"><option value="newest">Neueste zuerst</option><option value="oldest">√Ñlteste zuerst</option><option value="budget_high">Budget ‚Üì</option><option value="budget_low">Budget ‚Üë</option><option value="urgency">Dringlichkeit</option></select><select class="sort-select" id="yearFilter" onchange="lyf=this.value;renderLeads()"><option value="all">Alle Jahre</option></select><button class="refresh-btn" onclick="loadLeads()">‚Üª Aktualisieren</button><button class="btn grn" id="btnNewLead" style="display:none" onclick="openNewLead()">+ Neuer Kunde</button></div></div>
            <div class="card"><table><thead><tr><th>Kontakt</th><th>Anfrage</th><th>Dringlichkeit</th><th>Eingang</th><th>Budget</th><th>Status</th><th>Aktion</th></tr></thead><tbody id="leadsTB"><tr><td colspan="7" class="loading">L√§dt...</td></tr></tbody></table></div>
        </div>
        <!-- ONBOARDING -->
        <div class="tab-view" id="tab-onboarding">
            <div class="kpi-grid" id="obKpi"></div>
            <div class="section-header"><h2 class="section-title">Onboarding-Anfragen</h2><div class="header-actions"><div class="filter-group" id="obFG"></div><button class="refresh-btn" onclick="loadOB()">‚Üª Aktualisieren</button></div></div>
            <div class="card"><table><thead><tr><th>Status</th><th>Firma</th><th>Kontakt</th><th>Telefon</th><th>Leistungen</th><th>Eingegangen</th></tr></thead><tbody id="obTB"><tr><td colspan="6" class="loading">L√§dt...</td></tr></tbody></table></div>
        </div>
        <!-- KUNDEN -->
        <div class="tab-view" id="tab-tenants">
            <div class="section-header"><h2 class="section-title">Aktive Kunden</h2><button class="refresh-btn" onclick="loadTenants()">‚Üª Aktualisieren</button></div>
            <div class="tg" id="tenantGrid"><div class="loading">L√§dt...</div></div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div class="mo" id="mLeadDetail" onclick="if(event.target===this)this.classList.remove('show')"><div class="md" style="max-width:520px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h2 id="ldTitle">Lead</h2><button class="btn sec" style="font-size:12px;padding:6px 12px" id="ldEditBtn" onclick="toggleEdit()">‚úèÔ∏è Bearbeiten</button></div><div id="ldView"></div><div id="ldEdit" style="display:none"></div><div style="margin-top:16px;display:flex;gap:8px"><button class="btn" id="ldSaveBtn" style="display:none" onclick="saveEditLead()">Speichern</button><button class="mc" onclick="$('mLeadDetail').classList.remove('show')">Schlie√üen</button></div></div></div>
<div class="mo" id="mOffer" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>Angebot gesendet</h2><p style="color:#64748b;margin-bottom:16px">Angebotssumme?</p><input type="number" class="mi" id="offerAmt" placeholder="z.B. 2500" step="0.01"><div><button class="btn" onclick="confirmOffer()">Speichern</button><button class="btn sec" onclick="$('mOffer').classList.remove('show')">Abbrechen</button></div></div></div>
<div class="mo" id="mNotes" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>Notizen</h2><textarea class="mt" id="notesTxt" placeholder="Notizen..."></textarea><div><button class="btn" onclick="saveNotes()">Speichern</button><button class="btn sec" onclick="$('mNotes').classList.remove('show')">Abbrechen</button></div></div></div>
<div class="mo" id="mTermin" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>üìÖ Termin vereinbaren</h2><p style="color:#64748b;margin-bottom:12px">Eine E-Mail mit Ihrem Buchungslink wird an den Kunden gesendet.</p><div class="mf"><label class="il">E-Mail des Kunden</label><input type="email" class="mi" id="terminEmail" placeholder="kunde@email.de"></div><div class="mf"><label class="il">Pers√∂nliche Nachricht <span style="font-weight:400;color:#94a3b8">(optional)</span></label><textarea class="mt" id="terminMsg" placeholder="z.B. Gerne m√∂chte ich mit Ihnen einen Termin vor Ort vereinbaren..."></textarea></div><div id="terminStatus" style="margin-bottom:12px"></div><div><button class="btn" id="terminSend" onclick="sendTermin()">üìß E-Mail senden</button><button class="btn sec" onclick="$('mTermin').classList.remove('show')">Abbrechen</button></div></div></div>
<div class="mo" id="mDel" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>Lead l√∂schen?</h2><p style="color:#64748b;margin-bottom:16px">Wirklich l√∂schen?</p><div><button class="btn red" onclick="confirmDel()">Ja, l√∂schen</button><button class="btn sec" onclick="$('mDel').classList.remove('show')">Abbrechen</button></div></div></div>

<!-- NEW LEAD MODAL -->
<div class="mo" id="mNewLead" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="md" style="max-width:560px">
        <h2>Neuer Lead anlegen</h2>
        <div class="login-error" id="nlErr"></div>
        <div class="mf"><label class="il">Name *</label><input type="text" class="mi" id="nlName" placeholder="Vor- und Nachname"></div>
        <div class="mf"><label class="il">Telefon *</label><input type="tel" class="mi" id="nlPhone" placeholder="z.B. 0171 1234567"></div>
        <div class="mf"><label class="il">E-Mail <span style="font-weight:400;color:#94a3b8">(optional)</span></label><input type="email" class="mi" id="nlEmail" placeholder="E-Mail-Adresse"></div>
        <div class="mf"><label class="il">Firma <span style="font-weight:400;color:#94a3b8">(optional)</span></label><input type="text" class="mi" id="nlCompany" placeholder="Firmenname"></div>
        <div class="mf"><label class="il">Kundenart *</label>
            <div class="nl-cats" style="grid-template-columns:1fr 1fr">
                <label class="nl-cat"><input type="radio" name="nl_kundenart" value="privat"><span>üë§ Privat</span></label>
                <label class="nl-cat"><input type="radio" name="nl_kundenart" value="gewerbe"><span>üè¢ Gewerbe</span></label>
            </div>
        </div>
        <div class="mf"><label class="il">Datum der Anfrage <span style="font-weight:400;color:#94a3b8">(optional ‚Äì leer = heute)</span></label><input type="date" class="mi" id="nlDate" style="padding:10px 14px"></div>
        <div class="mf">
            <label class="il">Um was geht es? *</label>
            <div class="nl-cats" id="nlCats">
                <label class="nl-cat"><input type="radio" name="nl_cat" value="hausmeisterpflege" onchange="nlCatChange(this.value)"><span>üåø Hausmeisterpflege</span></label>
                <label class="nl-cat"><input type="radio" name="nl_cat" value="gebaeudereinigung" onchange="nlCatChange(this.value)"><span>üè¢ Geb√§udereinigung</span></label>
                <label class="nl-cat"><input type="radio" name="nl_cat" value="hausmeisterdienste" onchange="nlCatChange(this.value)"><span>üîß Hausmeisterdienste</span></label>
                <label class="nl-cat"><input type="radio" name="nl_cat" value="sonstiges" onchange="nlCatChange(this.value)"><span>üí¨ Sonstiges</span></label>
            </div>
        </div>
        <div class="nl-sub" id="nlSubHM" style="display:none">
            <div class="mf"><label class="il">Bereich</label>
                <select class="mi" id="nlSubHMSel" style="padding:10px 14px"><option value="">Bitte w√§hlen</option><option value="gruenflachenpflege">Gr√ºnfl√§chenpflege</option><option value="winterdienst">Winterdienst</option></select>
            </div>
            <div class="mf"><label class="il">Wie oft? <span style="font-weight:400;color:#94a3b8">(optional)</span></label>
                <select class="mi" id="nlFreqHM" style="padding:10px 14px"><option value="">‚Äì</option><option value="1x_woche">1√ó pro Woche</option><option value="2x_woche">2√ó pro Woche</option><option value="3x_woche">3√ó pro Woche</option><option value="4x_woche">4√ó pro Woche</option><option value="1x_monat">1√ó pro Monat</option><option value="einmalig">Einmalig</option></select>
            </div>
        </div>
        <div class="nl-sub" id="nlSubGR" style="display:none">
            <div class="mf"><label class="il">Art der Reinigung</label>
                <select class="mi" id="nlSubGRSel" style="padding:10px 14px"><option value="">Bitte w√§hlen</option><option value="grundreinigung">Grundreinigung</option><option value="glasreinigung">Glasreinigung</option><option value="baufeinreinigung">Baufeinreinigung</option><option value="solaranlagenreinigung">Solaranlagenreinigung</option><option value="unterhaltsreinigung">Unterhaltsreinigung</option></select>
            </div>
            <div class="mf"><label class="il">Gesch√§tzte Fl√§che <span style="font-weight:400;color:#94a3b8">(optional)</span></label><input type="number" class="mi" id="nlFlaeche" placeholder="z.B. 150 m¬≤"></div>
            <div class="mf"><label class="il">Wie oft? <span style="font-weight:400;color:#94a3b8">(optional)</span></label>
                <select class="mi" id="nlFreqGR" style="padding:10px 14px"><option value="">‚Äì</option><option value="1x_woche">1√ó pro Woche</option><option value="2x_woche">2√ó pro Woche</option><option value="3x_woche">3√ó pro Woche</option><option value="4x_woche">4√ó pro Woche</option><option value="1x_monat">1√ó pro Monat</option><option value="einmalig">Einmalig</option></select>
            </div>
        </div>
        <div class="nl-sub" id="nlSubHD" style="display:none">
            <div class="mf"><label class="il">Anzahl der Wohneinheiten</label><input type="number" class="mi" id="nlWE" placeholder="z.B. 12"></div>
            <div class="mf"><label class="il">Gesamtfl√§che ca. <span style="font-weight:400;color:#94a3b8">(optional)</span></label><input type="number" class="mi" id="nlFlaecheHD" placeholder="z.B. 800 m¬≤"></div>
            <div class="mf"><label class="il">Gew√ºnschter Start</label>
                <select class="mi" id="nlStart" style="padding:10px 14px"><option value="">‚Äì</option><option value="sofort">Sofort</option><option value="1_monat">Innerhalb 1 Monat</option><option value="3_monate">Innerhalb 3 Monate</option><option value="flexibel">Flexibel</option></select>
            </div>
        </div>
        <div class="mf"><label class="il">Beschreibung <span style="font-weight:400;color:#94a3b8">(optional)</span></label><textarea class="mt" id="nlDesc" placeholder="Weitere Details..."></textarea></div>
        <div><button class="btn" id="nlSave" onclick="saveNewLead()">Lead anlegen</button><button class="btn sec" onclick="$('mNewLead').classList.remove('show')">Abbrechen</button></div>
    </div>
</div>

<!-- ANGEBOT EDITOR -->
<div class="slo" id="angSlide" onclick="if(event.target===this)closeAng()">
<div class="slp" style="width:700px">
<div class="sl-top"><h2>üìÑ Angebot erstellen</h2><button class="cl-btn" onclick="closeAng()">‚úï</button></div>
<div class="sl-body">
<div class="dg">
<div class="dg-t">Kundendaten</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div><label class="il">Name</label><input class="mi" id="angName"></div>
<div><label class="il">Firma</label><input class="mi" id="angFirma"></div>
<div><label class="il">E-Mail</label><input class="mi" id="angEmail" type="email"></div>
<div><label class="il">Telefon</label><input class="mi" id="angPhone"></div>
</div>
<div style="margin-top:8px"><label class="il">Adresse</label><input class="mi" id="angAddr" placeholder="Stra√üe, PLZ Ort"></div>
</div>
<div class="dg">
<div class="dg-t">Angebotsdaten</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div><label class="il">Angebots-Nr.</label><input class="mi" id="angNr"></div>
<div><label class="il">Datum</label><input class="mi" id="angDatum" type="date"></div>
<div><label class="il">G√ºltig bis</label><input class="mi" id="angGueltig" type="date"></div>
<div><label class="il">Betreff</label><input class="mi" id="angBetreff" placeholder="z.B. Unterhaltsreinigung B√ºrogeb√§ude"></div>
</div>
</div>
<div class="dg">
<div class="dg-t">Positionen</div>
<table style="width:100%;font-size:13px;border-collapse:collapse" id="angTable">
<thead><tr style="background:#f8fafc">
<th style="padding:8px;text-align:left;width:40px">Pos</th>
<th style="padding:8px;text-align:left">Beschreibung</th>
<th style="padding:8px;text-align:right;width:60px">Menge</th>
<th style="padding:8px;text-align:left;width:60px">Einheit</th>
<th style="padding:8px;text-align:right;width:90px">Einzelpreis</th>
<th style="padding:8px;text-align:right;width:90px">Gesamt</th>
<th style="padding:8px;width:30px"></th>
</tr></thead>
<tbody id="angRows"></tbody>
</table>
<button class="btn sec" style="margin-top:8px;font-size:12px" onclick="addAngRow()">+ Position hinzuf√ºgen</button>
<div style="margin-top:16px;text-align:right;font-size:14px">
<div style="margin-bottom:4px">Netto: <strong id="angNetto">0,00 ‚Ç¨</strong></div>
<div style="margin-bottom:4px">MwSt. (19%): <span id="angMwst">0,00 ‚Ç¨</span></div>
<div style="font-size:18px;font-weight:700;color:#1e293b">Brutto: <span id="angBrutto">0,00 ‚Ç¨</span></div>
</div>
</div>
<div class="dg">
<div class="dg-t">Anmerkungen (optional)</div>
<textarea class="mt" id="angNotes" placeholder="z.B. Zahlungsbedingungen, Sonderkonditionen..."></textarea>
</div>
</div>
<div class="sl-act" style="flex-wrap:wrap">
<button class="btn" onclick="genAngPDF('download')">üíæ PDF herunterladen</button>
<button class="btn grn" onclick="genAngPDF('send')">üìß PDF per E-Mail senden</button>
<button class="btn sec" onclick="closeAng()">Abbrechen</button>
</div>
</div>
</div>

<!-- Onboarding detail slide -->
<div class="slo" id="obSlide" onclick="if(event.target===this)closeOB()"><div class="slp"><div class="sl-top"><h2 id="obSlTitle">Details</h2><button class="cl-btn" onclick="closeOB()">‚úï</button></div><div class="sl-body" id="obSlBody"></div><div class="sl-act" id="obSlAct"></div></div></div>

<!-- Activate -->
<div class="mo" id="mActivate" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>Kunde aktivieren</h2><p style="color:#64748b;margin-bottom:16px">Lege einen Benutzernamen fest. Der Kunde erstellt sein Passwort beim ersten Login selbst.</p><div class="mf"><label class="il">Benutzername</label><input type="text" class="mi" id="actUser" placeholder="z.B. mueller-sanitaer" autocomplete="off"><div style="font-size:12px;color:#94a3b8;margin-top:-8px">Kleinbuchstaben, keine Leerzeichen</div></div><div><button class="btn grn" onclick="confirmActivate()">Aktivieren</button><button class="btn sec" onclick="$('mActivate').classList.remove('show')">Abbrechen</button></div></div></div>

<!-- CHANGE PASSWORD (f√ºr eingeloggte Kunden) -->

<!-- NEW LEAD MODAL -->
<div class="mo" id="mNewLead" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="md" style="max-width:520px;max-height:90vh;overflow-y:auto">
        <h2>Neuen Kunden eintragen</h2>
        <div class="login-error" id="nlErr"></div>
        <div class="mf"><label class="il">Name *</label><input type="text" class="mi" id="nlName" placeholder="Vor- und Nachname"></div>
        <div class="mf"><label class="il">Telefon *</label><input type="tel" class="mi" id="nlPhone" placeholder="z.B. 0171 1234567"></div>
        <div class="mf"><label class="il">E-Mail</label><input type="email" class="mi" id="nlEmail" placeholder="optional"></div>
        <div class="mf"><label class="il">Firma</label><input type="text" class="mi" id="nlCompany" placeholder="optional"></div>
        <div class="mf">
            <label class="il">Kategorie *</label>
            <select class="mi" id="nlCategory" onchange="nlCatChange()">
                <option value="">Bitte w√§hlen...</option>
                <option value="hausmeisterpflege">üåø Hausmeisterpflege</option>
                <option value="gebaeudereinigung">üè¢ Geb√§udereinigung</option>
                <option value="hausmeisterdienste">üîß Hausmeisterdienste</option>
                <option value="sonstiges">üí¨ Sonstiges</option>
            </select>
        </div>
        <div id="nlSubHMP" style="display:none" class="mf">
            <label class="il">Leistung</label>
            <select class="mi" id="nlSubHMP_sel">
                <option value="">Bitte w√§hlen...</option>
                <option value="gruenflachenpflege">Gr√ºnfl√§chenpflege</option>
                <option value="winterdienst">Winterdienst</option>
            </select>
        </div>
        <div id="nlSubGR" style="display:none" class="mf">
            <label class="il">Leistung</label>
            <select class="mi" id="nlSubGR_sel">
                <option value="">Bitte w√§hlen...</option>
                <option value="grundreinigung">Grundreinigung</option>
                <option value="glasreinigung">Glasreinigung</option>
                <option value="baufeinreinigung">Baufeinreinigung</option>
                <option value="solaranlagenreinigung">Solaranlagenreinigung</option>
                <option value="unterhaltsreinigung">Unterhaltsreinigung</option>
            </select>
        </div>
        <div id="nlFlaeche" style="display:none" class="mf">
            <label class="il">Fl√§che in m¬≤</label>
            <input type="number" class="mi" id="nlQm" placeholder="z.B. 150">
        </div>
        <div id="nlFreq" style="display:none" class="mf">
            <label class="il">Frequenz</label>
            <select class="mi" id="nlFreq_sel">
                <option value="">Bitte w√§hlen...</option>
                <option value="1x_woche">1√ó pro Woche</option>
                <option value="2x_woche">2√ó pro Woche</option>
                <option value="3x_woche">3√ó pro Woche</option>
                <option value="4x_woche">4√ó pro Woche</option>
                <option value="1x_monat">1√ó pro Monat</option>
                <option value="einmalig">Einmalig</option>
            </select>
        </div>
        <div id="nlHMD" style="display:none">
            <div class="mf"><label class="il">Anzahl Wohneinheiten</label><input type="number" class="mi" id="nlWE" placeholder="z.B. 12"></div>
            <div class="mf"><label class="il">Gesamtfl√§che ca. in m¬≤</label><input type="number" class="mi" id="nlHMDqm" placeholder="z.B. 800"></div>
            <div class="mf">
                <label class="il">Gew√ºnschter Start</label>
                <select class="mi" id="nlStart">
                    <option value="">Bitte w√§hlen...</option>
                    <option value="sofort">Sofort</option>
                    <option value="1_monat">Innerhalb 1 Monat</option>
                    <option value="3_monate">Innerhalb 3 Monate</option>
                    <option value="flexibel">Flexibel</option>
                </select>
            </div>
        </div>
        <div class="mf"><label class="il">Beschreibung</label><textarea class="mt" id="nlDesc" placeholder="Weitere Details..."></textarea></div>
        <div>
            <button class="btn grn" onclick="saveNewLead()">Kunde speichern</button>
            <button class="btn sec" onclick="$('mNewLead').classList.remove('show')">Abbrechen</button>
        </div>
    </div>
</div>

<div class="mo" id="mChangePw" onclick="if(event.target===this)closeChangePw()">
    <div class="md" onclick="event.stopPropagation()">
        <h2>Passwort √§ndern</h2>
        <div class="pw-ok" id="cpwOk">‚úì Passwort erfolgreich ge√§ndert!</div>
        <div class="login-error" id="cpwErr"></div>
        <div class="mf"><label class="il">Aktuelles Passwort</label><input type="password" class="mi" id="cpwCur" placeholder="Ihr aktuelles Passwort"></div>
        <div class="mf"><label class="il">Neues Passwort</label><input type="password" class="mi" id="cpwNew" placeholder="Mindestens 6 Zeichen"></div>
        <div class="mf"><label class="il">Neues Passwort wiederholen</label><input type="password" class="mi" id="cpwConf" placeholder="Passwort best√§tigen"><div class="pw-match" id="cpwMatch"></div></div>
        <div><button class="btn" id="cpwSave" onclick="saveChangePw()">Passwort √§ndern</button><button class="btn sec" onclick="closeChangePw()">Abbrechen</button></div>
    </div>
</div>

<!-- ANGEBOT EDITOR -->
<div class="ang-overlay" id="angOverlay">
    <div class="ang-header">
        <h2>üìÑ Angebot erstellen</h2>
        <div class="ang-actions">
            <button class="btn sec" onclick="closeAngebot()">‚Üê Zur√ºck</button>
            <button class="btn" onclick="previewPDF()">üëÅ Vorschau</button>
            <button class="btn grn" onclick="downloadPDF()">‚¨á PDF Download</button>
            <button class="btn" onclick="sendAngebot()" id="angSendBtn">üìß Per E-Mail senden</button>
        </div>
    </div>
    <div class="ang-body">
        <div class="ang-status" id="angStatus"></div>
        <div class="ang-section">
            <h3>Absender</h3>
            <div class="ang-row">
                <div><div class="ang-label">Firma</div><input class="ang-input" id="angFirma" value="Hausmeisterservice Sykora"></div>
                <div><div class="ang-label">Inhaber</div><input class="ang-input" id="angInhaber" value="Markus Sykora"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">Adresse</div><input class="ang-input" id="angAdresse" value="Rosenheimer Str. 18, 85560 Ebersberg"></div>
                <div><div class="ang-label">Telefon</div><input class="ang-input" id="angTel" value="080922504830"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">E-Mail</div><input class="ang-input" id="angEmail" value="m.sykora@hausmeisterservicesykora.de"></div>
                <div><div class="ang-label">Steuernummer / USt-IdNr.</div><input class="ang-input" id="angSteuer" placeholder="z.B. DE123456789"></div>
            </div>
        </div>
        <div class="ang-section">
            <h3>Empf√§nger</h3>
            <div class="ang-row">
                <div><div class="ang-label">Name / Firma</div><input class="ang-input" id="angKunde"></div>
                <div><div class="ang-label">Ansprechpartner</div><input class="ang-input" id="angAnsprech"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">Adresse</div><input class="ang-input" id="angKAdresse" placeholder="Stra√üe, PLZ Ort"></div>
                <div><div class="ang-label">E-Mail</div><input class="ang-input" id="angKEmail"></div>
            </div>
        </div>
        <div class="ang-section">
            <h3>Angebot</h3>
            <div class="ang-row">
                <div><div class="ang-label">Angebotsnummer</div><input class="ang-input" id="angNr"></div>
                <div><div class="ang-label">Datum</div><input class="ang-input" id="angDatum" type="date"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">G√ºltig bis</div><input class="ang-input" id="angGueltig" type="date"></div>
                <div><div class="ang-label">Betreff</div><input class="ang-input" id="angBetreff" placeholder="z.B. Angebot Unterhaltsreinigung"></div>
            </div>
            <div class="ang-full"><div class="ang-label">Einleitungstext</div><textarea class="ang-input" id="angEinleitung" rows="2" style="resize:vertical">Vielen Dank f√ºr Ihre Anfrage. Gerne unterbreiten wir Ihnen folgendes Angebot:</textarea></div>
        </div>
        <div class="ang-section">
            <h3>Positionen</h3>
            <table class="ang-table">
                <thead><tr><th class="col-pos">Pos.</th><th class="col-desc">Beschreibung</th><th class="col-num">Menge</th><th class="col-num">Einheit</th><th class="col-price">Einzelpreis</th><th class="col-total">Gesamt</th><th class="col-del"></th></tr></thead>
                <tbody id="angPosTB"></tbody>
            </table>
            <button class="ang-add" onclick="addAngPos()">+ Position hinzuf√ºgen</button>
            <div class="ang-totals" id="angTotals"></div>
        </div>
        <div class="ang-section">
            <h3>Abschluss</h3>
            <div class="ang-full"><div class="ang-label">Schlusstext</div><textarea class="ang-input" id="angSchluss" rows="2" style="resize:vertical">Wir freuen uns auf Ihren Auftrag und stehen f√ºr R√ºckfragen gerne zur Verf√ºgung.</textarea></div>
            <div class="ang-row">
                <div><div class="ang-label">Zahlungsbedingung</div><input class="ang-input" id="angZahlung" value="Zahlbar innerhalb von 14 Tagen nach Rechnungsstellung"></div>
                <div><div class="ang-label">MwSt. (%)</div><input class="ang-input" id="angMwst" type="number" value="19" min="0" max="100" onchange="calcAngTotals()"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script>
const SB='https://fbkkyzvumytipjtnrjrn.supabase.co',SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZia2t5enZ1bXl0aXBqdG5yanJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzM0MTMsImV4cCI6MjA4NTI0OTQxM30.FsdSHmWuyP5QiKqGbaDG6XZJiAzaOKdsbqgrXKrfQCk';
const AU='admin',AP='leadcall2024';
const SL={new:'Neu',contacted:'Kontaktiert',offer_sent:'Angebot gesendet',won:'Gewonnen',lost:'Verloren',bestandskunde:'Bestandskunde'};
const OL={new:'Neu',in_progress:'In Bearb.',completed:'Fertig',rejected:'Abgelehnt'};
const UL={today:'Heute',this_week:'Diese Woche',flexible:'Flexibel'};
const BL={under_500:'Unter 500‚Ç¨','500_2000':'500‚Äì2.000‚Ç¨','2000_5000':'2.000‚Äì5.000‚Ç¨',over_5000:'√úber 5.000‚Ç¨',unknown:'Unbekannt'};
const BV={under_500:250,'500_2000':1250,'2000_5000':3500,over_5000:7500,unknown:0};
const SVL={sanitaer:'Sanit√§r',heizung:'Heizung',elektro:'Elektro',klima:'Klima',solar:'Solar',bad:'Bad'};
function bc(b){return(b==='over_5000'||b==='2000_5000')?'bg-h':b==='500_2000'?'bg-m':'bg-l';}
function $(id){return document.getElementById(id);}

let isAdmin=false,tid=null,tname='',tpw='';
let leads=[],obReqs=[],tenants=[];
let lf='all',ls='newest',of='all',lyf='all';
let curLead=null,curOb=null,pendT=null;

const H={'apikey':SK,'Authorization':`Bearer ${SK}`};
const JH={...H,'Content-Type':'application/json'};
async function sG(t,q=''){return(await fetch(`${SB}/rest/v1/${t}?${q}`,{headers:H})).json();}
async function sU(t,id,d){return(await fetch(`${SB}/rest/v1/${t}?id=eq.${id}`,{method:'PATCH',headers:{...JH,'Prefer':'return=representation'},body:JSON.stringify(d)})).json();}
async function sI(t,d){return(await fetch(`${SB}/rest/v1/${t}`,{method:'POST',headers:{...JH,'Prefer':'return=representation'},body:JSON.stringify(d)})).json();}
async function sD(t,id){return(await fetch(`${SB}/rest/v1/${t}?id=eq.${id}`,{method:'DELETE',headers:H})).ok;}

// ===== LOGIN =====
function goStep(s){
    document.querySelectorAll('.login-step').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.login-error').forEach(x=>x.classList.remove('show'));
    if(s==='user'){$('stepUser').classList.add('active');$('inUser').focus();}
    else if(s==='pw'){$('stepPw').classList.add('active');$('inPw').value='';$('inPw').focus();}
    else{$('stepSetPw').classList.add('active');$('inNewPw').value='';$('inConfPw').value='';$('pwMatch1').textContent='';$('inNewPw').focus();}
}

$('btnUser').onclick=chkUser;$('inUser').onkeydown=e=>{if(e.key==='Enter')chkUser();};
async function chkUser(){
    const u=$('inUser').value.trim().toLowerCase();if(!u)return;
    const b=$('btnUser');b.disabled=true;b.textContent='Pr√ºfe...';$('errUser').classList.remove('show');
    if(u===AU){$('welcName').textContent='Admin-Zugang';pendT=null;goStep('pw');b.disabled=false;b.textContent='Weiter';return;}
    try{
        const r=await sG('tenants',`username=eq.${encodeURIComponent(u)}`);
        if(r.length){pendT=r[0];if(r[0].password){$('welcName').textContent=r[0].name;goStep('pw');}else{$('setupName').textContent=`Willkommen, ${r[0].name}!`;goStep('set');}}
        else $('errUser').classList.add('show');
    }catch(e){$('errUser').textContent='Verbindungsfehler.';$('errUser').classList.add('show');}
    b.disabled=false;b.textContent='Weiter';
}

$('btnPw').onclick=chkPw;$('inPw').onkeydown=e=>{if(e.key==='Enter')chkPw();};
async function chkPw(){
    const pw=$('inPw').value;if(!pw)return;
    const b=$('btnPw');b.disabled=true;b.textContent='Pr√ºfe...';$('errPw').classList.remove('show');
    if(!pendT&&pw===AP){isAdmin=true;sessionStorage.setItem('lc_r','admin');showApp();b.disabled=false;b.textContent='Anmelden';return;}
    if(pendT&&pendT.password===pw){isAdmin=false;tid=pendT.id;tname=pendT.name;tpw=pw;sessionStorage.setItem('lc_r','tenant');sessionStorage.setItem('lc_t',tid);sessionStorage.setItem('lc_n',tname);sessionStorage.setItem('lc_p',pw);showApp();b.disabled=false;b.textContent='Anmelden';return;}
    $('errPw').classList.add('show');b.disabled=false;b.textContent='Anmelden';
}

$('inConfPw').oninput=function(){const p1=$('inNewPw').value,p2=this.value,m=$('pwMatch1');if(!p2){m.textContent='';return;}m.textContent=p1===p2?'‚úì Passw√∂rter stimmen √ºberein':'‚úó Stimmen nicht √ºberein';m.className='pw-match '+(p1===p2?'ok':'no');};
$('btnSetPw').onclick=setPw;$('inConfPw').onkeydown=e=>{if(e.key==='Enter')setPw();};
async function setPw(){
    const p1=$('inNewPw').value,p2=$('inConfPw').value,err=$('errSetPw');err.classList.remove('show');
    if(p1.length<6){err.textContent='Mindestens 6 Zeichen.';err.classList.add('show');return;}
    if(p1!==p2){err.textContent='Passw√∂rter stimmen nicht √ºberein.';err.classList.add('show');return;}
    if(!pendT)return;
    const b=$('btnSetPw');b.disabled=true;b.textContent='Wird gespeichert...';
    try{await sU('tenants',pendT.id,{password:p1});isAdmin=false;tid=pendT.id;tname=pendT.name;tpw=p1;sessionStorage.setItem('lc_r','tenant');sessionStorage.setItem('lc_t',tid);sessionStorage.setItem('lc_n',tname);sessionStorage.setItem('lc_p',p1);showApp();}
    catch(e){err.textContent='Fehler.';err.classList.add('show');}
    b.disabled=false;b.textContent='Passwort festlegen & anmelden';
}

function doLogout(){sessionStorage.clear();location.reload();}
function chkSession(){const r=sessionStorage.getItem('lc_r');if(r==='admin'){isAdmin=true;showApp();}else if(r==='tenant'){tid=sessionStorage.getItem('lc_t');tname=sessionStorage.getItem('lc_n');tpw=sessionStorage.getItem('lc_p')||'';if(tid){isAdmin=false;showApp();}}}

// ===== CHANGE PASSWORD (tenant) =====
function openChangePw(){$('cpwCur').value='';$('cpwNew').value='';$('cpwConf').value='';$('cpwMatch').textContent='';$('cpwErr').classList.remove('show');$('cpwOk').classList.remove('show');$('cpwSave').disabled=false;$('mChangePw').classList.add('show');}
function closeChangePw(){$('mChangePw').classList.remove('show');}
$('cpwConf').oninput=function(){const p1=$('cpwNew').value,p2=this.value,m=$('cpwMatch');if(!p2){m.textContent='';return;}m.textContent=p1===p2?'‚úì Stimmen √ºberein':'‚úó Stimmen nicht √ºberein';m.className='pw-match '+(p1===p2?'ok':'no');};
async function saveChangePw(){
    const cur=$('cpwCur').value,p1=$('cpwNew').value,p2=$('cpwConf').value,err=$('cpwErr'),ok=$('cpwOk');
    err.classList.remove('show');ok.classList.remove('show');
    if(cur!==tpw){err.textContent='Aktuelles Passwort ist falsch.';err.classList.add('show');return;}
    if(p1.length<6){err.textContent='Neues Passwort: mindestens 6 Zeichen.';err.classList.add('show');return;}
    if(p1!==p2){err.textContent='Neue Passw√∂rter stimmen nicht √ºberein.';err.classList.add('show');return;}
    if(p1===cur){err.textContent='Neues Passwort muss sich unterscheiden.';err.classList.add('show');return;}
    const b=$('cpwSave');b.disabled=true;b.textContent='Speichert...';
    try{
        await sU('tenants',tid,{password:p1});
        tpw=p1;sessionStorage.setItem('lc_p',p1);
        ok.classList.add('show');
        $('cpwCur').value='';$('cpwNew').value='';$('cpwConf').value='';$('cpwMatch').textContent='';
        setTimeout(closeChangePw,1500);
    }catch(e){err.textContent='Fehler beim Speichern.';err.classList.add('show');}
    b.disabled=false;b.textContent='Passwort √§ndern';
}

// ===== APP =====
function showApp(){
    $('loginOverlay').classList.add('hidden');$('mainContent').classList.add('show');
    if(isAdmin){$('headerTitle').textContent='Admin';$('adminBadge').style.display='';$('changePwBtn').style.display='none';buildNav(['onboarding','leads','tenants'],['Onboarding','Alle Leads','Kunden']);switchTab('onboarding');loadOB();loadLeads();loadTenants();}
    else{$('headerTitle').textContent=tname;$('adminBadge').style.display='none';$('changePwBtn').style.display='';$('btnNewLead').style.display='';buildNav(['leads'],['Anfragen']);switchTab('leads');loadLeads();}
}
function buildNav(tabs,labels){const n=$('headerNav'),m=$('mobNav');n.innerHTML='';m.innerHTML='';tabs.forEach((t,i)=>{const b=document.createElement('button');b.textContent=labels[i];b.dataset.tab=t;b.onclick=()=>switchTab(t);n.appendChild(b);const b2=b.cloneNode(true);b2.onclick=()=>switchTab(t);m.appendChild(b2);});}
function switchTab(t){document.querySelectorAll('.tab-view').forEach(x=>x.classList.remove('active'));$(`tab-${t}`).classList.add('active');document.querySelectorAll('.header-nav button,.mob-nav button').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));}

// ===== LEADS =====
function buildLF(){$('leadFG').innerHTML=[['all','Alle'],['new','Neu'],['offer_sent','Angebot'],['won','Gewonnen'],['bestandskunde','Bestandskunde'],['lost','Verloren']].map(([v,l])=>`<button class="filter-btn${lf===v?' active':''}" onclick="lf='${v}';buildLF();renderLeads()">${l}</button>`).join('');}
async function loadLeads(){buildLF();try{leads=await sG('leads',isAdmin?'order=created_at.desc':`tenant_id=eq.${tid}&order=created_at.desc`);buildYF();renderKpis();renderLeads();}catch(e){$('leadsTB').innerHTML=`<tr><td colspan="7" class="empty-state">Fehler: ${e.message}</td></tr>`;}}
function buildYF(){const yrs=[...new Set(leads.map(l=>new Date(l.created_at).getFullYear()))].sort((a,b)=>b-a);const sel=$('yearFilter');sel.innerHTML='<option value="all">Alle Jahre</option>'+yrs.map(y=>`<option value="${y}"${lyf==y?' selected':''}>${y}</option>`).join('');}
function renderKpis(){const a=new Date(Date.now()-30*864e5),r=leads.filter(l=>new Date(l.created_at)>=a),nw=r.filter(l=>l.status==='new').length,of=r.filter(l=>l.offer_sent_at).length,wo=r.filter(l=>l.status==='won').length,lo=r.filter(l=>l.status==='lost').length,wO=r.filter(l=>l.offer_sent_at&&l.created_at);let avg='-';if(wO.length){const t=wO.reduce((s,l)=>s+(new Date(l.offer_sent_at)-new Date(l.created_at))/36e5,0)/wO.length;avg=t<24?`${Math.round(t)}h`:`${Math.round(t/24)}d`;}const cv=r.length?Math.round(wo/r.length*100):0;$('kpiGrid').innerHTML=`<div class="kpi-card hl"><div class="kpi-value">${nw}</div><div class="kpi-label">Neue Leads</div></div><div class="kpi-card"><div class="kpi-value">${of}</div><div class="kpi-label">Angebote</div></div><div class="kpi-card ok"><div class="kpi-value">${wo}</div><div class="kpi-label">Gewonnen</div></div><div class="kpi-card bad"><div class="kpi-value">${lo}</div><div class="kpi-label">Verloren</div></div><div class="kpi-card"><div class="kpi-value">${avg}</div><div class="kpi-label">‚åÄ Antwortzeit</div></div><div class="kpi-card"><div class="kpi-value">${cv}%</div><div class="kpi-label">Conversion</div></div>`;}
function sortL(l){const s=[...l];switch(ls){case 'newest':s.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));break;case 'oldest':s.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));break;case 'budget_high':s.sort((a,b)=>(BV[b.budget]||0)-(BV[a.budget]||0));break;case 'budget_low':s.sort((a,b)=>(BV[a.budget]||0)-(BV[b.budget]||0));break;case 'urgency':const o={today:0,this_week:1,flexible:2};s.sort((a,b)=>(o[a.urgency]??3)-(o[b.urgency]??3));break;}return s;}
function renderLeads(){const tb=$('leadsTB');let f=lf==='all'?leads:leads.filter(l=>l.status===lf);if(lyf!=='all')f=f.filter(l=>new Date(l.created_at).getFullYear()==lyf);f=sortL(f);if(!f.length){tb.innerHTML='<tr><td colspan="7" class="empty-state"><h3>Keine Anfragen</h3></td></tr>';return;}tb.innerHTML=f.map(l=>`<tr class="clickable" onclick="showLD('${l.id}')"><td><div style="font-weight:600">${esc(l.name||'Unbekannt')}${l.notes?'<span class="has-notes">üìù</span>':''}</div><div style="font-size:13px;color:#64748b">${esc(l.phone||'-')}</div></td><td><div>${esc(l.service_type||'-')}</div>${l.company?`<div style="font-size:13px;color:#64748b">${esc(l.company)}</div>`:''}${l.offer_amount?`<div style="font-size:13px;color:#16a34a;font-weight:600">${parseFloat(l.offer_amount).toLocaleString('de-DE')} ‚Ç¨</div>`:''}</td><td><span class="u-${l.urgency||'flexible'}">${UL[l.urgency]||'Flexibel'}</span></td><td><span class="time-ago">${timeAgo(l.created_at)}</span></td><td><span class="budget-badge ${bc(l.budget)}">${BL[l.budget]||'Unbekannt'}</span></td><td><span class="badge b-${l.status}">${SL[l.status]||l.status}</span></td><td onclick="event.stopPropagation()"><select class="action-select" onchange="doLA('${l.id}',this.value);this.value=''"><option value="">Aktion...</option><option value="contacted">‚Üí Kontaktiert</option><option value="offer_sent">‚Üí Angebot</option><option value="won">‚Üí Gewonnen ‚úì</option><option value="bestandskunde">‚Üí Bestandskunde ‚òÖ</option><option value="lost">‚Üí Verloren ‚úó</option><option value="termin">üìÖ Termin vereinbaren</option><option value="angebot">üìÑ Angebot schreiben</option><option value="notes">üìù Notizen</option><option value="delete">üóë L√∂schen</option></select></td></tr>`).join('');}
function doLA(id,a){if(!a)return;curLead=id;if(a==='offer_sent'){$('offerAmt').value='';$('mOffer').classList.add('show');}else if(a==='notes'){const l=leads.find(x=>x.id===id);$('notesTxt').value=l?.notes||'';$('mNotes').classList.add('show');}else if(a==='delete')$('mDel').classList.add('show');else if(a==='termin'){const l=leads.find(x=>x.id===id);$('terminEmail').value=l?.email||'';$('terminMsg').value='';$('terminStatus').innerHTML='';$('terminSend').disabled=false;$('terminSend').textContent='üìß E-Mail senden';$('mTermin').classList.add('show');}else if(a==='angebot'){openAngebot(id);}else updLS(id,a);}
async function updLS(id,s,x={}){const d={status:s,updated_at:new Date().toISOString(),...x};if(s==='offer_sent'&&!x.offer_sent_at)d.offer_sent_at=new Date().toISOString();else if(s==='won'||s==='lost'||s==='bestandskunde')d.closed_at=new Date().toISOString();await sU('leads',id,d);loadLeads();}
async function confirmOffer(){const a=$('offerAmt').value;await updLS(curLead,'offer_sent',{offer_amount:a?parseFloat(a):null,offer_sent_at:new Date().toISOString()});$('mOffer').classList.remove('show');}
async function saveNotes(){await sU('leads',curLead,{notes:$('notesTxt').value,updated_at:new Date().toISOString()});loadLeads();$('mNotes').classList.remove('show');}
async function confirmDel(){await sD('leads',curLead);loadLeads();$('mDel').classList.remove('show');}
function showLD(id){const l=leads.find(x=>x.id===id);if(!l)return;curLead=id;$('ldTitle').textContent=l.name||'Lead';
$('ldView').style.display='';$('ldEdit').style.display='none';$('ldSaveBtn').style.display='none';$('ldEditBtn').textContent='‚úèÔ∏è Bearbeiten';
$('ldView').innerHTML=`<div class="mf"><div class="ml">Name</div><div class="mv">${esc(l.name||'-')}</div></div><div class="mf"><div class="ml">Telefon</div><div class="mv"><a href="tel:${l.phone}">${esc(l.phone||'-')}</a></div></div>${l.email?`<div class="mf"><div class="ml">E-Mail</div><div class="mv"><a href="mailto:${l.email}">${esc(l.email)}</a></div></div>`:''}${l.company?`<div class="mf"><div class="ml">Firma</div><div class="mv">${esc(l.company)}</div></div>`:''}<div class="mf"><div class="ml">Anfrage</div><div class="mv">${esc(l.service_type||'-')}</div></div>${l.description?`<div class="mf"><div class="ml">Beschreibung</div><div class="mv">${esc(l.description)}</div></div>`:''}<div class="mf"><div class="ml">Status</div><div class="mv"><span class="badge b-${l.status}">${SL[l.status]||l.status}</span></div></div><div class="mf"><div class="ml">Eingegangen</div><div class="mv">${new Date(l.created_at).toLocaleString('de-DE')}</div></div>${l.offer_amount?`<div class="mf"><div class="ml">Angebotssumme</div><div class="mv" style="color:#16a34a;font-weight:600">${parseFloat(l.offer_amount).toLocaleString('de-DE')} ‚Ç¨</div></div>`:''} ${l.notes?`<div class="mf"><div class="ml">Notizen</div><div class="mv">${esc(l.notes)}</div></div>`:''}${l.image_urls&&l.image_urls.length?`<div class="mf"><div class="ml">Bilder</div><div class="mv" style="display:flex;gap:8px;flex-wrap:wrap">${l.image_urls.map(u=>`<a href="${u}" target="_blank"><img src="${u}" style="width:100px;height:100px;object-fit:cover;border-radius:6px"></a>`).join('')}</div></div>`:''}`;
$('ldEdit').innerHTML=`<div class="mf"><label class="il">Name</label><input type="text" class="mi" id="edName" value="${esc(l.name||'')}"></div><div class="mf"><label class="il">Telefon</label><input type="tel" class="mi" id="edPhone" value="${esc(l.phone||'')}"></div><div class="mf"><label class="il">E-Mail</label><input type="email" class="mi" id="edEmail" value="${esc(l.email||'')}"></div><div class="mf"><label class="il">Firma</label><input type="text" class="mi" id="edCompany" value="${esc(l.company||'')}"></div><div class="mf"><label class="il">Anfrage / Leistung</label><input type="text" class="mi" id="edService" value="${esc(l.service_type||'')}"></div><div class="mf"><label class="il">Beschreibung</label><textarea class="mt" id="edDesc">${esc(l.description||'')}</textarea></div><div class="mf"><label class="il">Status</label><select class="mi" id="edStatus" style="padding:10px 14px"><option value="new"${l.status==='new'?' selected':''}>Neu</option><option value="contacted"${l.status==='contacted'?' selected':''}>Kontaktiert</option><option value="offer_sent"${l.status==='offer_sent'?' selected':''}>Angebot gesendet</option><option value="won"${l.status==='won'?' selected':''}>Gewonnen</option><option value="bestandskunde"${l.status==='bestandskunde'?' selected':''}>Bestandskunde</option><option value="lost"${l.status==='lost'?' selected':''}>Verloren</option></select></div><div class="mf"><label class="il">Angebotssumme (‚Ç¨)</label><input type="number" class="mi" id="edOffer" value="${l.offer_amount||''}" step="0.01" placeholder="z.B. 2500"></div><div class="mf"><label class="il">Notizen</label><textarea class="mt" id="edNotes">${esc(l.notes||'')}</textarea></div>`;
$('mLeadDetail').classList.add('show');}
function toggleEdit(){const v=$('ldView'),e=$('ldEdit'),s=$('ldSaveBtn'),b=$('ldEditBtn');if(e.style.display==='none'){v.style.display='none';e.style.display='';s.style.display='';b.textContent='üëÅ Ansicht';}else{v.style.display='';e.style.display='none';s.style.display='none';b.textContent='‚úèÔ∏è Bearbeiten';}}
async function saveEditLead(){const b=$('ldSaveBtn');b.disabled=true;b.textContent='Speichert...';try{const d={name:$('edName').value.trim(),phone:$('edPhone').value.trim(),email:$('edEmail').value.trim()||null,company:$('edCompany').value.trim()||null,service_type:$('edService').value.trim(),description:$('edDesc').value.trim()||null,status:$('edStatus').value,offer_amount:$('edOffer').value?parseFloat($('edOffer').value):null,notes:$('edNotes').value.trim()||null,updated_at:new Date().toISOString()};await sU('leads',curLead,d);$('mLeadDetail').classList.remove('show');loadLeads();}catch(e){alert('Fehler: '+e.message);}b.disabled=false;b.textContent='Speichern';}

// ===== ONBOARDING =====
function buildOF(){$('obFG').innerHTML=[['all','Alle'],['new','Neu'],['in_progress','In Bearb.'],['completed','Fertig']].map(([v,l])=>`<button class="filter-btn${of===v?' active':''}" onclick="of='${v}';buildOF();renderOB()">${l}</button>`).join('');}
async function loadOB(){buildOF();try{obReqs=await sG('onboarding_requests','order=created_at.desc');renderOBK();renderOB();}catch(e){$('obTB').innerHTML=`<tr><td colspan="6" class="empty-state">Fehler: ${e.message}</td></tr>`;}}
function renderOBK(){const t=obReqs.length,n=obReqs.filter(r=>r.status==='new').length,p=obReqs.filter(r=>r.status==='in_progress').length,d=obReqs.filter(r=>r.status==='completed').length;$('obKpi').innerHTML=`<div class="kpi-card hl"><div class="kpi-value">${t}</div><div class="kpi-label">Gesamt</div></div><div class="kpi-card warn"><div class="kpi-value">${n}</div><div class="kpi-label">Neu</div></div><div class="kpi-card"><div class="kpi-value">${p}</div><div class="kpi-label">In Bearbeitung</div></div><div class="kpi-card ok"><div class="kpi-value">${d}</div><div class="kpi-label">Abgeschlossen</div></div>`;}
function renderOB(){const tb=$('obTB');let f=of==='all'?obReqs:obReqs.filter(r=>r.status===of);if(!f.length){tb.innerHTML='<tr><td colspan="6" class="empty-state"><h3>Keine Anfragen</h3></td></tr>';return;}tb.innerHTML=f.map(r=>`<tr class="clickable" onclick="openOBD('${r.id}')"><td><span class="badge b-${r.status}">${OL[r.status]||r.status}</span></td><td style="font-weight:600">${esc(r.company)}</td><td style="color:#64748b">${esc(r.contact_name)}</td><td style="font-size:13px;color:#64748b;font-family:monospace">${esc(r.phone)}</td><td>${(r.services||[]).map(s=>`<span class="svc-tag">${SVL[s]||s}</span>`).join('')}</td><td style="font-size:13px;color:#64748b">${fmtD(r.created_at)}</td></tr>`).join('');}
function openOBD(id){const r=obReqs.find(x=>x.id===id);if(!r)return;curOb=r;$('obSlTitle').textContent=r.company;$('obSlBody').innerHTML=`<div class="dg"><div class="dg-t">Firmendaten</div><div class="dr"><span class="dl">Firma</span><span class="dv">${esc(r.company)}</span></div><div class="dr"><span class="dl">Kontakt</span><span class="dv">${esc(r.contact_name)}${r.position?' ¬∑ '+esc(r.position):''}</span></div><div class="dr"><span class="dl">Telefon</span><span class="dv">${esc(r.phone)}</span></div><div class="dr"><span class="dl">E-Mail</span><span class="dv">${esc(r.email)}</span></div>${r.address?`<div class="dr"><span class="dl">Adresse</span><span class="dv">${esc(r.address)}</span></div>`:''}</div><div class="dg"><div class="dg-t">Leistungen</div><div class="dr"><span class="dl">Bereiche</span><span class="dv">${(r.services||[]).map(s=>`<span class="svc-tag">${SVL[s]||s}</span>`).join('')}</span></div>${r.services_other?`<div class="dr"><span class="dl">Weitere</span><span class="dv">${esc(r.services_other)}</span></div>`:''}</div><div class="dg"><div class="dg-t">Telefonie</div><div class="dr"><span class="dl">Setup</span><span class="dv">${r.phone_setup==='redirect'?'Eigene Nummer (Umleitung)':'Neue Nummer'}</span></div>${r.device?`<div class="dr"><span class="dl">Ger√§t</span><span class="dv">${r.device==='iphone'?'iPhone':'Android'}</span></div>`:''}${r.greeting?`<div class="dr"><span class="dl">Begr√º√üung</span><span class="dv">${esc(r.greeting)}</span></div>`:''}</div>${(r.subdomain||r.notes)?`<div class="dg"><div class="dg-t">Extras</div>${r.subdomain?`<div class="dr"><span class="dl">Subdomain</span><span class="dv">${esc(r.subdomain)}.leadcall24.de</span></div>`:''}${r.notes?`<div class="dr"><span class="dl">Anmerkungen</span><span class="dv">${esc(r.notes)}</span></div>`:''}</div>`:''}<div class="dg"><div class="dg-t">Status</div><div class="dr"><span class="dl">Aktuell</span><span class="dv"><span class="badge b-${r.status}">${OL[r.status]}</span></span></div><div class="dr"><span class="dl">Eingegangen</span><span class="dv">${fmtDT(r.created_at)}</span></div>${r.tenant_id?`<div class="dr"><span class="dl">Tenant ID</span><span class="dv" style="font-family:monospace;font-size:12px">${r.tenant_id}</span></div>`:''}</div>`;let a='';if(r.status==='new')a=`<button class="btn" onclick="updOBS('in_progress')">Bearbeitung starten</button><button class="btn red" onclick="updOBS('rejected')">Ablehnen</button>`;else if(r.status==='in_progress')a=`<button class="btn grn" onclick="startAct()">Als Kunde aktivieren</button><button class="btn sec" onclick="updOBS('new')">Zur√ºck auf Neu</button>`;else if(r.status==='rejected')a=`<button class="btn sec" onclick="updOBS('new')">Reaktivieren</button>`;else a=`<button class="btn sec" onclick="closeOB()">Schlie√üen</button>`;$('obSlAct').innerHTML=a;$('obSlide').classList.add('show');}
function closeOB(){$('obSlide').classList.remove('show');curOb=null;}
async function updOBS(s){if(!curOb)return;await sU('onboarding_requests',curOb.id,{status:s});closeOB();loadOB();}
function startAct(){if(!curOb)return;const s=curOb.company.toLowerCase().replace(/[√§√Ñ]/g,'ae').replace(/[√∂√ñ]/g,'oe').replace(/[√º√ú]/g,'ue').replace(/[√ü]/g,'ss').replace(/[^a-z0-9]/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');$('actUser').value=s;$('mActivate').classList.add('show');}
async function confirmActivate(){if(!curOb)return;const u=$('actUser').value.trim().toLowerCase();if(!u){alert('Benutzername eingeben.');return;}if(/\s/.test(u)){alert('Keine Leerzeichen.');return;}const ex=await sG('tenants',`username=eq.${encodeURIComponent(u)}`);if(ex.length){alert('Benutzername vergeben!');return;}const r=curOb,ts=await sI('tenants',{name:r.company,phone:r.phone,email:r.email,username:u,password:null});if(ts&&ts.length){await sU('onboarding_requests',r.id,{status:'completed',tenant_id:ts[0].id});$('mActivate').classList.remove('show');closeOB();alert(`‚úÖ Kunde aktiviert!\n\nBenutzername: ${u}\n\nDer Kunde erstellt sein Passwort beim ersten Login selbst.`);loadOB();loadTenants();}else alert('Fehler.');}

// ===== TENANTS =====
async function loadTenants(){try{tenants=await sG('tenants','order=created_at.desc');const lds=await sG('leads','select=tenant_id');const c={};lds.forEach(l=>{c[l.tenant_id]=(c[l.tenant_id]||0)+1;});const g=$('tenantGrid');if(!tenants.length){g.innerHTML='<div class="empty-state"><h3>Noch keine Kunden</h3></div>';return;}g.innerHTML=tenants.map(t=>`<div class="tc"><div class="tc-name">${esc(t.name)}</div><div class="tc-email">${esc(t.email||'-')}</div><div class="tc-meta"><span>üìû ${esc(t.phone||'-')}</span><span>üìã ${c[t.id]||0} Leads</span><span>üìÖ ${fmtD(t.created_at)}</span></div><div class="tc-id">ID: ${t.id}</div><div class="tc-login"><h4>Login-Daten</h4><div class="tc-row"><div class="fld"><label>Benutzername</label><input type="text" value="${esc(t.username||'')}" id="u-${t.id}"></div><div class="fld"><label>Passwort</label><input type="text" value="${esc(t.password||'')}" placeholder="${t.password?'':'Wird vom Kunden gesetzt'}" id="p-${t.id}"></div><button onclick="saveTL('${t.id}')">Speichern</button></div><div class="pw-st ${t.password?'set':'notset'}">${t.password?'‚úì Passwort gesetzt':'‚è≥ Wartet auf ersten Login'}</div></div></div>`).join('');}catch(e){$('tenantGrid').innerHTML=`<div class="empty-state">Fehler: ${e.message}</div>`;}}
async function saveTL(id){const u=$(`u-${id}`).value.trim().toLowerCase(),p=$(`p-${id}`).value.trim();if(!u){alert('Benutzername eingeben.');return;}const ex=await sG('tenants',`username=eq.${encodeURIComponent(u)}&id=neq.${id}`);if(ex.length){alert('Benutzername vergeben!');return;}const d={username:u};if(p)d.password=p;await sU('tenants',id,d);alert('Gespeichert!');loadTenants();}

// ===== NEW LEAD =====
function openNewLead(){
    $('nlErr').classList.remove('show');
    $('nlName').value='';$('nlPhone').value='';$('nlEmail').value='';$('nlCompany').value='';
    $('nlCategory').value='';$('nlDesc').value='';
    $('nlSubHMP').style.display='none';$('nlSubGR').style.display='none';
    $('nlFlaeche').style.display='none';$('nlFreq').style.display='none';$('nlHMD').style.display='none';
    $('mNewLead').classList.add('show');
}
function nlCatChange(){
    var c=$('nlCategory').value;
    $('nlSubHMP').style.display=c==='hausmeisterpflege'?'block':'none';
    $('nlSubGR').style.display=c==='gebaeudereinigung'?'block':'none';
    $('nlFlaeche').style.display=(c==='gebaeudereinigung')?'block':'none';
    $('nlFreq').style.display=(c==='hausmeisterpflege'||c==='gebaeudereinigung')?'block':'none';
    $('nlHMD').style.display=c==='hausmeisterdienste'?'block':'none';
}
async function saveNewLead(){
    var nm=$('nlName').value.trim(),ph=$('nlPhone').value.trim(),cat=$('nlCategory').value;
    if(!nm){$('nlErr').textContent='Bitte Name eingeben';$('nlErr').classList.add('show');return;}
    if(!ph){$('nlErr').textContent='Bitte Telefon eingeben';$('nlErr').classList.add('show');return;}
    if(!cat){$('nlErr').textContent='Bitte Kategorie w√§hlen';$('nlErr').classList.add('show');return;}
    var st=cat;
    if(cat==='hausmeisterpflege'){var sub=$('nlSubHMP_sel').value;if(sub)st+=' / '+sub;}
    if(cat==='gebaeudereinigung'){var sub=$('nlSubGR_sel').value;if(sub)st+=' / '+sub;var qm=$('nlQm').value;if(qm)st+=' ('+qm+' m¬≤)';}
    if(cat==='hausmeisterpflege'||cat==='gebaeudereinigung'){
        var fr=$('nlFreq_sel').value;
        if(fr){var fm={'1x_woche':'1√ó/Woche','2x_woche':'2√ó/Woche','3x_woche':'3√ó/Woche','4x_woche':'4√ó/Woche','1x_monat':'1√ó/Monat','einmalig':'Einmalig'};st+=' ‚Äì '+(fm[fr]||fr);}
    }
    if(cat==='hausmeisterdienste'){
        var we=$('nlWE').value,hqm=$('nlHMDqm').value,start=$('nlStart').value;
        if(we)st+=' / '+we+' WE';if(hqm)st+=' ('+hqm+' m¬≤)';
        if(start){var sm={'sofort':'Sofort','1_monat':'Innerhalb 1 Monat','3_monate':'Innerhalb 3 Monate','flexibel':'Flexibel'};st+=' ‚Äì Start: '+(sm[start]||start);}
    }
    var pf=ph.replace(/[\s\-\/\(\)]/g,'');
    if(pf.startsWith('0049'))pf='+49'+pf.substring(4);
    else if(pf.startsWith('49')&&!pf.startsWith('+'))pf='+49'+pf.substring(2);
    else if(pf.startsWith('0'))pf='+49'+pf.substring(1);
    else if(!pf.startsWith('+'))pf='+49'+pf;
    var ld={tenant_id:tid,name:nm,phone:pf,email:$('nlEmail').value.trim()||null,company:$('nlCompany').value.trim()||null,service_type:st,description:$('nlDesc').value.trim()||null,urgency:'flexible',budget:null,privacy_accepted:true,privacy_accepted_at:new Date().toISOString(),form_submitted_at:new Date().toISOString(),status:'new'};
    try{await sI('leads',ld);$('mNewLead').classList.remove('show');loadLeads();}catch(e){$('nlErr').textContent='Fehler: '+e.message;$('nlErr').classList.add('show');}
}

// ===== HELPERS =====
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function timeAgo(d){if(!d)return'-';const s=Math.floor((Date.now()-new Date(d))/1000);if(s<60)return'Gerade eben';if(s<3600)return`vor ${Math.floor(s/60)} Min.`;if(s<86400)return`vor ${Math.floor(s/3600)} Std.`;if(s<604800)return`vor ${Math.floor(s/86400)} Tagen`;return new Date(d).toLocaleDateString('de-DE');}
function fmtD(i){if(!i)return'‚Äì';return new Date(i).toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit'});}
function fmtDT(i){if(!i)return'‚Äì';const d=new Date(i);return d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit'})+' ¬∑ '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});}
setInterval(()=>{if(sessionStorage.getItem('lc_r'))loadLeads();},30000);

// ===== NEW LEAD =====
function openNewLead(){
    $('nlName').value='';$('nlPhone').value='';$('nlEmail').value='';$('nlCompany').value='';$('nlDesc').value='';$('nlDate').value='';
    document.querySelectorAll('input[name="nl_cat"]').forEach(r=>r.checked=false);
    document.querySelectorAll('input[name="nl_kundenart"]').forEach(r=>r.checked=false);
    document.querySelectorAll('.nl-sub').forEach(el=>el.style.display='none');
    $('nlErr').classList.remove('show');$('nlSave').disabled=false;$('nlSave').textContent='Lead anlegen';
    $('mNewLead').classList.add('show');
}
function nlCatChange(v){
    document.querySelectorAll('.nl-sub').forEach(el=>el.style.display='none');
    if(v==='hausmeisterpflege')$('nlSubHM').style.display='';
    else if(v==='gebaeudereinigung')$('nlSubGR').style.display='';
    else if(v==='hausmeisterdienste')$('nlSubHD').style.display='';
}
async function saveNewLead(){
    const err=$('nlErr');err.classList.remove('show');
    const name=$('nlName').value.trim(),phone=$('nlPhone').value.trim();
    const cat=document.querySelector('input[name="nl_cat"]:checked');
    const kundenart=document.querySelector('input[name="nl_kundenart"]:checked');
    if(!name){err.textContent='Bitte Name eingeben.';err.classList.add('show');return;}
    if(!phone){err.textContent='Bitte Telefonnummer eingeben.';err.classList.add('show');return;}
    if(!kundenart){err.textContent='Bitte Kundenart w√§hlen (Privat/Gewerbe).';err.classList.add('show');return;}
    if(!cat){err.textContent='Bitte Kategorie w√§hlen.';err.classList.add('show');return;}
    let svc=(kundenart.value==='gewerbe'?'Gewerbe':'Privat')+' ‚Äì '+cat.value;
    const freqMap={'1x_woche':'1√ó/Woche','2x_woche':'2√ó/Woche','3x_woche':'3√ó/Woche','4x_woche':'4√ó/Woche','1x_monat':'1√ó/Monat','einmalig':'Einmalig'};
    const startMap={'sofort':'Sofort','1_monat':'Innerhalb 1 Monat','3_monate':'Innerhalb 3 Monate','flexibel':'Flexibel'};
    if(cat.value==='hausmeisterpflege'){
        const sub=$('nlSubHMSel').value;if(sub)svc+=' / '+sub;
        const fr=$('nlFreqHM').value;if(fr)svc+=' ‚Äì '+(freqMap[fr]||fr);
    }else if(cat.value==='gebaeudereinigung'){
        const sub=$('nlSubGRSel').value;if(sub)svc+=' / '+sub;
        const fl=$('nlFlaeche').value;if(fl)svc+=' ('+fl+' m¬≤)';
        const fr=$('nlFreqGR').value;if(fr)svc+=' ‚Äì '+(freqMap[fr]||fr);
    }else if(cat.value==='hausmeisterdienste'){
        const we=$('nlWE').value;if(we)svc+=' / '+we+' WE';
        const fl=$('nlFlaecheHD').value;if(fl)svc+=' ('+fl+' m¬≤)';
        const st=$('nlStart').value;if(st)svc+=' ‚Äì Start: '+(startMap[st]||st);
    }
    let fPhone=phone.replace(/[\s\-\/\(\)]/g,'');
    if(fPhone.startsWith('0049'))fPhone='+49'+fPhone.substring(4);
    else if(fPhone.startsWith('49')&&!fPhone.startsWith('+'))fPhone='+49'+fPhone.substring(2);
    else if(fPhone.startsWith('0'))fPhone='+49'+fPhone.substring(1);
    else if(!fPhone.startsWith('+'))fPhone='+49'+fPhone;
    const b=$('nlSave');b.disabled=true;b.textContent='Wird gespeichert...';
    try{
        const tID=isAdmin?null:tid;
        const customDate=$('nlDate').value;
        const createdAt=customDate?new Date(customDate+'T12:00:00').toISOString():new Date().toISOString();
        const d={tenant_id:tID||tid,name:name,phone:fPhone,email:$('nlEmail').value.trim()||null,company:$('nlCompany').value.trim()||null,service_type:svc,description:$('nlDesc').value.trim()||null,status:'new',privacy_accepted:true,privacy_accepted_at:new Date().toISOString(),created_at:createdAt};
        await sI('leads',d);
        $('mNewLead').classList.remove('show');loadLeads();
    }catch(e){err.textContent='Fehler: '+e.message;err.classList.add('show');}
    b.disabled=false;b.textContent='Lead anlegen';
}

// ===== ANGEBOT =====
let angRowCount=0;
function openAngebot(id){
    const l=leads.find(x=>x.id===id);
    $('angName').value=l?.name||'';
    $('angFirma').value=l?.company||'';
    $('angEmail').value=l?.email||'';
    $('angPhone').value=l?.phone||'';
    $('angAddr').value='';
    const today=new Date().toISOString().split('T')[0];
    const in30=new Date(Date.now()+30*864e5).toISOString().split('T')[0];
    $('angDatum').value=today;
    $('angGueltig').value=in30;
    $('angNr').value='ANG-'+Date.now().toString(36).toUpperCase();
    $('angBetreff').value=l?.service_type||'';
    $('angNotes').value='Zahlbar innerhalb von 14 Tagen nach Rechnungsstellung.\nDieses Angebot ist freibleibend.';
    angRowCount=0;
    $('angRows').innerHTML='';
    addAngRow();
    calcAng();
    $('angSlide').classList.add('show');
}
function closeAng(){$('angSlide').classList.remove('show');}
function addAngRow(){
    angRowCount++;
    const tr=document.createElement('tr');
    tr.id='angR'+angRowCount;
    tr.innerHTML='<td style="padding:6px"><span class="ang-pos">'+angRowCount+'</span></td><td style="padding:6px"><input style="width:100%;padding:6px;border:1px solid #e2e8f0;border-radius:4px;font-size:13px" class="ang-desc" placeholder="Beschreibung"></td><td style="padding:6px"><input type="number" style="width:100%;padding:6px;border:1px solid #e2e8f0;border-radius:4px;font-size:13px;text-align:right" class="ang-qty" value="1" min="0" step="any" oninput="calcAng()"></td><td style="padding:6px"><select style="padding:6px;border:1px solid #e2e8f0;border-radius:4px;font-size:12px" class="ang-unit"><option>Stk.</option><option>Std.</option><option>m¬≤</option><option>pauschal</option><option>Monat</option></select></td><td style="padding:6px"><input type="number" style="width:100%;padding:6px;border:1px solid #e2e8f0;border-radius:4px;font-size:13px;text-align:right" class="ang-price" value="0" min="0" step="0.01" oninput="calcAng()"></td><td style="padding:6px;text-align:right;font-weight:600" class="ang-total">0,00</td><td style="padding:6px"><button onclick="this.closest(\'tr\').remove();reNumAng();calcAng()" style="background:none;border:none;cursor:pointer;color:#dc2626;font-size:16px">‚úï</button></td>';
    $('angRows').appendChild(tr);
}
function reNumAng(){document.querySelectorAll('#angRows tr').forEach((tr,i)=>{tr.querySelector('.ang-pos').textContent=i+1;});}
function calcAng(){
    let total=0;
    document.querySelectorAll('#angRows tr').forEach(tr=>{
        const q=parseFloat(tr.querySelector('.ang-qty').value)||0;
        const p=parseFloat(tr.querySelector('.ang-price').value)||0;
        const t=q*p;total+=t;
        tr.querySelector('.ang-total').textContent=t.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
    });
    const mwst=total*0.19;
    $('angNetto').textContent=total.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+' \u20ac';
    $('angMwst').textContent=mwst.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+' \u20ac';
    $('angBrutto').textContent=(total+mwst).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+' \u20ac';
}
async function genAngPDF(mode){
    const{jsPDF}=window.jspdf;
    const doc=new jsPDF();
    const blue=[37,99,235];
    const gray=[100,116,139];
    const dark=[30,41,59];
    // Header
    doc.setFontSize(20);doc.setTextColor(...blue);doc.setFont('helvetica','bold');
    doc.text('Hausmeisterservice Sykora',14,22);
    doc.setFontSize(9);doc.setTextColor(...gray);doc.setFont('helvetica','normal');
    doc.text('Markus Sykora \u00b7 Rosenheimer Str. 18 \u00b7 85560 Ebersberg',14,28);
    doc.text('Tel.: 08092 2504830 \u00b7 E-Mail: m.sykora@hausmeisterservicesykora.de',14,33);
    doc.setDrawColor(226,232,240);doc.line(14,37,196,37);
    // Angebot title
    doc.setFontSize(16);doc.setTextColor(...dark);doc.setFont('helvetica','bold');
    doc.text('ANGEBOT',14,48);
    doc.setFontSize(10);doc.setFont('helvetica','normal');
    doc.setTextColor(...gray);
    doc.text('Nr.: '+$('angNr').value,14,54);
    doc.text('Datum: '+formatDateDE($('angDatum').value),14,59);
    doc.text('G\u00fcltig bis: '+formatDateDE($('angGueltig').value),14,64);
    // Kunde
    doc.setFontSize(10);doc.setTextColor(...dark);doc.setFont('helvetica','bold');
    doc.text('Kunde:',120,48);doc.setFont('helvetica','normal');
    let ky=53;
    if($('angFirma').value){doc.text($('angFirma').value,120,ky);ky+=5;}
    if($('angName').value){doc.text($('angName').value,120,ky);ky+=5;}
    if($('angAddr').value){doc.text($('angAddr').value,120,ky);ky+=5;}
    if($('angPhone').value){doc.text('Tel.: '+$('angPhone').value,120,ky);ky+=5;}
    if($('angEmail').value){doc.text($('angEmail').value,120,ky);ky+=5;}
    // Betreff
    if($('angBetreff').value){doc.setFont('helvetica','bold');doc.setTextColor(...dark);doc.text('Betr.: '+$('angBetreff').value,14,78);doc.setFont('helvetica','normal');}
    // Table
    const rows=[];
    document.querySelectorAll('#angRows tr').forEach((tr,i)=>{
        const desc=tr.querySelector('.ang-desc').value||'';
        const qty=tr.querySelector('.ang-qty').value||'0';
        const unit=tr.querySelector('.ang-unit').value||'';
        const price=parseFloat(tr.querySelector('.ang-price').value)||0;
        const total=parseFloat(qty)*price;
        rows.push([(i+1).toString(),desc,qty,unit,price.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac',total.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac']);
    });
    doc.autoTable({startY:84,head:[['Pos','Beschreibung','Menge','Einheit','Einzelpreis','Gesamt']],body:rows,styles:{fontSize:9,cellPadding:4},headStyles:{fillColor:blue,textColor:[255,255,255],fontStyle:'bold'},columnStyles:{0:{cellWidth:15},2:{halign:'right',cellWidth:18},3:{cellWidth:20},4:{halign:'right',cellWidth:28},5:{halign:'right',cellWidth:28}},alternateRowStyles:{fillColor:[248,250,252]}});
    // Totals
    let ty=doc.lastAutoTable.finalY+10;
    let netto=0;
    document.querySelectorAll('#angRows tr').forEach(tr=>{const q=parseFloat(tr.querySelector('.ang-qty').value)||0;const p=parseFloat(tr.querySelector('.ang-price').value)||0;netto+=q*p;});
    const mwst=netto*0.19;const brutto=netto+mwst;
    doc.setFontSize(10);doc.setTextColor(...dark);
    doc.text('Netto:',150,ty,{align:'right'});doc.text(netto.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac',192,ty,{align:'right'});ty+=6;
    doc.text('MwSt. (19%):',150,ty,{align:'right'});doc.text(mwst.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac',192,ty,{align:'right'});ty+=6;
    doc.setDrawColor(226,232,240);doc.line(130,ty-2,196,ty-2);ty+=2;
    doc.setFont('helvetica','bold');doc.setFontSize(12);
    doc.text('Brutto:',150,ty,{align:'right'});doc.text(brutto.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac',192,ty,{align:'right'});
    // Notes
    if($('angNotes').value){ty+=14;doc.setFontSize(9);doc.setFont('helvetica','normal');doc.setTextColor(...gray);const lines=doc.splitTextToSize($('angNotes').value,170);doc.text(lines,14,ty);}
    // Footer
    doc.setFontSize(7);doc.setTextColor(...gray);doc.setFont('helvetica','normal');
    doc.text('Hausmeisterservice Sykora \u00b7 Markus Sykora \u00b7 Rosenheimer Str. 18 \u00b7 85560 Ebersberg \u00b7 m.sykora@hausmeisterservicesykora.de',105,287,{align:'center'});
    if(mode==='download'){
        doc.save('Angebot_'+$('angNr').value+'.pdf');
        if(curLead){await sU('leads',curLead,{offer_amount:netto,offer_sent_at:new Date().toISOString(),status:'offer_sent',updated_at:new Date().toISOString()});loadLeads();}
    }else if(mode==='send'){
        const email=$('angEmail').value.trim();
        if(!email){alert('Bitte E-Mail-Adresse des Kunden eingeben.');return;}
        try{
            const blob=doc.output('blob');
            const fname='Angebot_'+$('angNr').value+'_'+Date.now()+'.pdf';
            const res=await fetch(SB+'/storage/v1/object/angebote/'+fname,{method:'POST',headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/pdf'},body:blob});
            if(!res.ok)throw new Error('Upload fehlgeschlagen');
            const pdfUrl=SB+'/storage/v1/object/public/angebote/'+fname;
            emailjs.init('fc6zzeTCmrKyrkxJ2');
            await emailjs.send('service_te0rxxz','template_oyi750j',{
                to_email:email,
                kunde_name:$('angName').value||'',
                firma_name:'Hausmeisterservice Sykora',
                nachricht:'Im Anhang finden Sie unser Angebot '+$('angNr').value+'. Sie k\u00f6nnen das Angebot hier herunterladen:\n\n'+pdfUrl+'\n\nBei Fragen stehen wir Ihnen gerne zur Verf\u00fcgung.',
                booking_link:pdfUrl
            });
            alert('\u2705 Angebot wurde per E-Mail an '+email+' gesendet!');
            if(curLead){await sU('leads',curLead,{offer_amount:netto,offer_sent_at:new Date().toISOString(),status:'offer_sent',updated_at:new Date().toISOString()});loadLeads();}
            closeAng();
        }catch(e){alert('Fehler: '+e.message);}
    }
}
function formatDateDE(d){if(!d)return'-';const p=d.split('-');return p[2]+'.'+p[1]+'.'+p[0];}

// ===== ANGEBOT =====
let angPositionen=[];
let angLeadId=null;
function openAngebot(id){
    const l=leads.find(x=>x.id===id);angLeadId=id;
    $('angKunde').value=l?(l.company||l.name||''):'';
    $('angAnsprech').value=l?l.name||'':'';
    $('angKEmail').value=l?l.email||'':'';
    $('angKAdresse').value='';
    $('angBetreff').value=l?'Angebot '+((l.service_type||'').split(' / ')[0]||''):'';
    const now=new Date();
    $('angNr').value='ANG-'+now.getFullYear()+'-'+(Math.floor(Math.random()*9000)+1000);
    $('angDatum').value=now.toISOString().split('T')[0];
    const bis=new Date(now.getTime()+30*864e5);
    $('angGueltig').value=bis.toISOString().split('T')[0];
    angPositionen=[{pos:1,desc:'',menge:1,einheit:'Stk.',preis:0}];
    renderAngPos();
    $('angStatus').className='ang-status';$('angStatus').textContent='';
    $('angOverlay').classList.add('show');
}
function closeAngebot(){$('angOverlay').classList.remove('show');}
function addAngPos(){angPositionen.push({pos:angPositionen.length+1,desc:'',menge:1,einheit:'Stk.',preis:0});renderAngPos();}
function delAngPos(i){angPositionen.splice(i,1);angPositionen.forEach((p,j)=>p.pos=j+1);renderAngPos();}
function renderAngPos(){
    const tb=$('angPosTB');
    tb.innerHTML=angPositionen.map((p,i)=>'<tr><td class="col-pos"><input value="'+p.pos+'" readonly style="background:#f8fafc;text-align:center"></td><td class="col-desc"><input value="'+esc(p.desc)+'" oninput="angPositionen['+i+'].desc=this.value" placeholder="Beschreibung..."></td><td class="col-num"><input type="number" value="'+p.menge+'" min="0" step="0.01" oninput="angPositionen['+i+'].menge=parseFloat(this.value)||0;calcAngTotals()"></td><td class="col-num"><input value="'+esc(p.einheit)+'" oninput="angPositionen['+i+'].einheit=this.value"></td><td class="col-price"><input type="number" value="'+p.preis+'" min="0" step="0.01" oninput="angPositionen['+i+'].preis=parseFloat(this.value)||0;calcAngTotals()"></td><td class="col-total">'+((p.menge*p.preis).toFixed(2).replace('.',','))+' \u20ac</td><td class="col-del">'+(angPositionen.length>1?'<button class="ang-del" onclick="delAngPos('+i+')">\u2715</button>':'')+'</td></tr>').join('');
    calcAngTotals();
}
function calcAngTotals(){
    const netto=angPositionen.reduce((s,p)=>s+p.menge*p.preis,0);
    const mwst=parseFloat($('angMwst').value)||19;
    const steuer=netto*mwst/100;
    const brutto=netto+steuer;
    $('angTotals').innerHTML='<div>Netto: '+netto.toFixed(2).replace('.',',')+' \u20ac</div><div>MwSt. ('+mwst+'%): '+steuer.toFixed(2).replace('.',',')+' \u20ac</div><div class="ang-brutto">Brutto: '+brutto.toFixed(2).replace('.',',')+' \u20ac</div>';
}
function buildAngPDF(){
    const{jsPDF}=window.jspdf;const doc=new jsPDF();const w=doc.internal.pageSize.getWidth();
    const firma=$('angFirma').value,inhaber=$('angInhaber').value,adresse=$('angAdresse').value,tel=$('angTel').value,email=$('angEmail').value,steuer=$('angSteuer').value;
    const kunde=$('angKunde').value,ansprech=$('angAnsprech').value,kadresse=$('angKAdresse').value;
    const nr=$('angNr').value,datum=$('angDatum').value,gueltig=$('angGueltig').value,betreff=$('angBetreff').value;
    const einleitung=$('angEinleitung').value,schluss=$('angSchluss').value,zahlung=$('angZahlung').value;
    const mwstRate=parseFloat($('angMwst').value)||19;
    // Header
    doc.setFontSize(20);doc.setTextColor(37,99,235);doc.text(firma,20,25);
    doc.setFontSize(9);doc.setTextColor(100);doc.text(inhaber+' | '+adresse,20,32);doc.text('Tel: '+tel+' | E-Mail: '+email+(steuer?' | '+steuer:''),20,37);
    doc.setDrawColor(226,232,240);doc.line(20,42,w-20,42);
    // Empfaenger
    let y=52;doc.setFontSize(10);doc.setTextColor(100);doc.text('An:',20,y);
    doc.setFontSize(11);doc.setTextColor(30);y+=6;doc.text(kunde,20,y);if(ansprech&&ansprech!==kunde){y+=5;doc.text(ansprech,20,y);}if(kadresse){y+=5;doc.text(kadresse,20,y);}
    // Angebotsdaten rechts
    doc.setFontSize(9);doc.setTextColor(100);
    doc.text('Angebots-Nr:',w-80,52);doc.text(nr,w-40,52);
    doc.text('Datum:',w-80,58);doc.text(datum?new Date(datum).toLocaleDateString('de-DE'):'',w-40,58);
    doc.text('G\u00fcltig bis:',w-80,64);doc.text(gueltig?new Date(gueltig).toLocaleDateString('de-DE'):'',w-40,64);
    // Betreff
    y+=16;doc.setFontSize(13);doc.setTextColor(30);doc.setFont(undefined,'bold');doc.text(betreff||'Angebot',20,y);
    doc.setFont(undefined,'normal');
    // Einleitung
    if(einleitung){y+=8;doc.setFontSize(10);doc.setTextColor(80);var lines=doc.splitTextToSize(einleitung,w-40);doc.text(lines,20,y);y+=lines.length*5;}
    // Tabelle
    y+=8;doc.setFillColor(248,250,252);doc.rect(20,y-4,w-40,8,'F');
    doc.setFontSize(8);doc.setTextColor(100);doc.setFont(undefined,'bold');
    doc.text('Pos.',22,y+1);doc.text('Beschreibung',38,y+1);doc.text('Menge',110,y+1);doc.text('Einheit',128,y+1);doc.text('Einzelpreis',150,y+1);doc.text('Gesamt',175,y+1);
    doc.setFont(undefined,'normal');doc.setDrawColor(226,232,240);doc.line(20,y+4,w-20,y+4);y+=10;
    doc.setFontSize(9);doc.setTextColor(30);
    var netto=0;
    angPositionen.forEach(function(p){
        var total=p.menge*p.preis;netto+=total;
        doc.text(String(p.pos),24,y);
        var descLines=doc.splitTextToSize(p.desc||'',68);doc.text(descLines,38,y);
        doc.text(String(p.menge),114,y);doc.text(p.einheit,128,y);
        doc.text(p.preis.toFixed(2).replace('.',',')+' \u20ac',150,y);
        doc.text(total.toFixed(2).replace('.',',')+' \u20ac',175,y);
        y+=Math.max(descLines.length*5,7);
        if(y>265){doc.addPage();y=20;}
    });
    // Summen
    doc.line(20,y,w-20,y);y+=8;
    doc.setFontSize(9);doc.setTextColor(100);doc.text('Netto:',150,y);doc.text(netto.toFixed(2).replace('.',',')+' \u20ac',175,y);
    y+=6;var steuerBetrag=netto*mwstRate/100;doc.text('MwSt. ('+mwstRate+'%):',150,y);doc.text(steuerBetrag.toFixed(2).replace('.',',')+' \u20ac',175,y);
    y+=7;doc.setFontSize(11);doc.setTextColor(30);doc.setFont(undefined,'bold');doc.text('Gesamt:',150,y);doc.text((netto+steuerBetrag).toFixed(2).replace('.',',')+' \u20ac',175,y);
    doc.setFont(undefined,'normal');
    // Schluss
    if(schluss){y+=14;doc.setFontSize(10);doc.setTextColor(80);var sl=doc.splitTextToSize(schluss,w-40);doc.text(sl,20,y);y+=sl.length*5;}
    if(zahlung){y+=8;doc.setFontSize(9);doc.setTextColor(100);doc.text(zahlung,20,y);}
    // Footer
    doc.setFontSize(7);doc.setTextColor(150);doc.text(firma+' | '+inhaber+' | '+adresse+' | Tel: '+tel+' | '+email,w/2,287,{align:'center'});
    return doc;
}
function previewPDF(){var doc=buildAngPDF();window.open(doc.output('bloburl'),'_blank');}
function downloadPDF(){var doc=buildAngPDF();doc.save(($('angNr').value||'Angebot')+'.pdf');}
async function sendAngebot(){
    var kemail=$('angKEmail').value.trim();
    var st=$('angStatus');
    if(!kemail){st.className='ang-status show err';st.textContent='Bitte E-Mail-Adresse des Kunden eintragen.';return;}
    var b=$('angSendBtn');b.disabled=true;b.textContent='Wird gesendet...';st.className='ang-status';st.textContent='';
    try{
        var doc=buildAngPDF();
        var blob=doc.output('blob');
        var filename=($('angNr').value||'Angebot')+'.pdf';
        var formData=new FormData();formData.append('',blob,filename);
        var upRes=await fetch(SB+'/storage/v1/object/angebote/'+encodeURIComponent(filename),{method:'POST',headers:{'Authorization':'Bearer '+SK},body:blob});
        if(!upRes.ok){var upBody=await upRes.json();if(upBody.error==='Duplicate'){await fetch(SB+'/storage/v1/object/angebote/'+encodeURIComponent(filename),{method:'PUT',headers:{'Authorization':'Bearer '+SK},body:blob});}}
        var pdfUrl=SB+'/storage/v1/object/public/angebote/'+encodeURIComponent(filename);
        emailjs.init('fc6zzeTCmrKyrkxJ2');
        await emailjs.send('service_te0rxxz','template_oyi750j',{
            to_email:kemail,
            kunde_name:$('angAnsprech').value||$('angKunde').value,
            firma_name:$('angFirma').value,
            nachricht:'Anbei erhalten Sie unser Angebot '+($('angNr').value)+'. Sie k\u00f6nnen es hier herunterladen:',
            booking_link:pdfUrl
        });
        if(angLeadId){
            var netto=angPositionen.reduce(function(s,p){return s+p.menge*p.preis},0);
            await sU('leads',angLeadId,{status:'offer_sent',offer_amount:netto,offer_sent_at:new Date().toISOString(),updated_at:new Date().toISOString()});
        }
        st.className='ang-status show ok';st.textContent='\u2713 Angebot erfolgreich an '+kemail+' gesendet!';
        setTimeout(function(){closeAngebot();loadLeads();},2000);
    }catch(e){st.className='ang-status show err';st.textContent='Fehler: '+e.message;}
    b.disabled=false;b.textContent='\ud83d\udce7 Per E-Mail senden';
}

// ===== TERMIN =====
const BOOKING_LINK = 'https://calendar.app.google/h2duMnoPvg3dCjPNA';
async function sendTermin(){
    const email=$('terminEmail').value.trim();
    const msg=$('terminMsg').value.trim();
    const st=$('terminStatus');
    if(!email){st.innerHTML='<span style="color:#dc2626">Bitte E-Mail eingeben.</span>';return;}
    const l=leads.find(x=>x.id===curLead);
    const b=$('terminSend');b.disabled=true;b.textContent='Wird gesendet...';
    try{
        emailjs.init('fc6zzeTCmrKyrkxJ2');
        await emailjs.send('service_te0rxxz','template_oyi750j',{
            to_email:email,
            kunde_name:l?.name||'',
            firma_name:tname||'Hausmeisterservice Sykora',
            nachricht:msg||'Gerne m√∂chten wir mit Ihnen einen Termin vereinbaren.',
            booking_link:BOOKING_LINK
        });
        st.innerHTML='<span style="color:#16a34a">‚úì E-Mail erfolgreich gesendet!</span>';
        if(curLead){await sU('leads',curLead,{status:'contacted',notes:(l?.notes?l.notes+'\n':'')+'['+new Date().toLocaleDateString('de-DE')+'] Termineinladung gesendet an '+email,updated_at:new Date().toISOString()});}
        setTimeout(()=>{$('mTermin').classList.remove('show');loadLeads();},1500);
    }catch(e){st.innerHTML='<span style="color:#dc2626">Fehler: '+e.message+'</span>';}
    b.disabled=false;b.textContent='üìß E-Mail senden';
}

chkSession();
</script>
</body>
</html>
