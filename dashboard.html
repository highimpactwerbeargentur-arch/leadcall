<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadCall24 Dashboard</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f1f5f9;min-height:100vh;color:#1e293b}

        /* LOGIN */
        .login-overlay{position:fixed;inset:0;background:#f1f5f9;display:flex;justify-content:center;align-items:center;z-index:1000}
        .login-overlay.hidden{display:none}
        .login-box{background:white;padding:32px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);width:100%;max-width:380px;text-align:center}
        .login-logo{font-size:24px;font-weight:700;color:#2563eb;margin-bottom:4px}
        .login-subtitle{color:#64748b;font-size:14px;margin-bottom:24px}
        .login-field{text-align:left;margin-bottom:16px}
        .login-field label{display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px}
        .login-input{width:100%;padding:12px 16px;font-size:15px;border:1px solid #e2e8f0;border-radius:8px;outline:none;transition:border-color .15s}
        .login-input:focus{border-color:#2563eb}
        .login-btn{width:100%;padding:12px;font-size:16px;font-weight:600;color:white;background:#2563eb;border:none;border-radius:8px;cursor:pointer;margin-top:8px}
        .login-btn:hover{background:#1d4ed8}
        .login-btn:disabled{opacity:.6;cursor:not-allowed}
        .login-error{color:#dc2626;font-size:14px;margin-bottom:16px;display:none;text-align:center}
        .login-error.show{display:block}
        .login-step{display:none}
        .login-step.active{display:block}
        .login-back{display:inline-flex;align-items:center;gap:4px;font-size:13px;color:#64748b;cursor:pointer;margin-bottom:16px;border:none;background:none}
        .login-back:hover{color:#2563eb}
        .login-welcome{font-size:16px;font-weight:600;color:#1e293b;margin-bottom:4px}
        .pw-match{font-size:12px;margin-top:4px}
        .pw-match.ok{color:#16a34a}
        .pw-match.no{color:#dc2626}
        .setup-info{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 16px;margin-bottom:20px;text-align:left}
        .setup-info p{font-size:13px;color:#1e40af;line-height:1.5}

        /* HEADER */
        .main-content{display:none}
        .main-content.show{display:block}
        .header{background:white;border-bottom:1px solid #e2e8f0;padding:0 24px;height:56px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50}
        .header-left{display:flex;align-items:center;gap:24px}
        .logo{font-size:20px;font-weight:700;color:#2563eb}
        .header-nav{display:flex;gap:2px}
        .header-nav button{padding:8px 16px;font-size:14px;font-weight:500;background:none;border:none;color:#64748b;cursor:pointer;border-radius:6px;transition:all .15s}
        .header-nav button:hover{background:#f1f5f9;color:#1e293b}
        .header-nav button.active{background:#eff6ff;color:#2563eb;font-weight:600}
        .header-right{display:flex;align-items:center;gap:10px;font-size:14px;color:#64748b}
        .header-user{display:flex;align-items:center;gap:8px}
        .header-user .user-name{font-weight:600;color:#1e293b}
        .admin-badge{display:inline-block;padding:2px 8px;background:#fef3c7;color:#b45309;border-radius:4px;font-size:11px;font-weight:700;text-transform:uppercase}
        .hdr-btn{padding:6px 12px;font-size:13px;background:none;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;color:#64748b;transition:all .15s}
        .hdr-btn:hover{border-color:#cbd5e1;color:#1e293b}
        .hdr-btn.logout:hover{border-color:#dc2626;color:#dc2626}

        /* LAYOUT */
        .container{max-width:1400px;margin:0 auto;padding:24px}
        .tab-view{display:none}
        .tab-view.active{display:block}

        /* KPI */
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px}
        .kpi-card{background:white;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
        .kpi-value{font-size:32px;font-weight:700;color:#1e293b;margin-bottom:4px}
        .kpi-label{font-size:14px;color:#64748b}
        .kpi-card.hl{background:linear-gradient(135deg,#2563eb,#1d4ed8)}
        .kpi-card.hl .kpi-value,.kpi-card.hl .kpi-label{color:white}
        .kpi-card.ok .kpi-value{color:#16a34a}
        .kpi-card.bad .kpi-value{color:#dc2626}
        .kpi-card.warn .kpi-value{color:#b45309}

        /* SECTION */
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
        .section-title{font-size:18px;font-weight:600}
        .header-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .filter-group{display:flex;gap:4px;background:white;padding:4px;border-radius:8px;border:1px solid #e2e8f0}
        .filter-btn{padding:6px 12px;font-size:13px;background:transparent;border:none;border-radius:6px;cursor:pointer;color:#64748b}
        .filter-btn:hover{background:#f1f5f9}
        .filter-btn.active{background:#2563eb;color:white}
        .sort-select{padding:8px 12px;font-size:13px;border:1px solid #e2e8f0;border-radius:8px;background:white;cursor:pointer}
        .refresh-btn{padding:8px 16px;font-size:14px;background:white;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer}
        .refresh-btn:hover{background:#f8fafc}

        /* TABLE */
        .card{background:white;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);overflow:hidden}
        table{width:100%;border-collapse:collapse}
        thead th{text-align:left;padding:14px 16px;font-size:12px;font-weight:600;text-transform:uppercase;color:#64748b;background:#f8fafc;border-bottom:1px solid #e2e8f0}
        tbody td{padding:14px 16px;font-size:14px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
        tbody tr:last-child td{border-bottom:none}
        tbody tr:hover{background:#f8fafc}
        tbody tr.clickable{cursor:pointer}

        /* BADGES */
        .badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:500}
        .b-new{background:#dbeafe;color:#1d4ed8}
        .b-contacted{background:#fef3c7;color:#b45309}
        .b-offer_sent,.b-in_progress{background:#e0e7ff;color:#4338ca}
        .b-won,.b-completed{background:#dcfce7;color:#16a34a}
        .b-lost,.b-rejected{background:#fee2e2;color:#dc2626}
        .b-bestandskunde{background:#f0fdf4;color:#166534;border:1px solid #86efac}
        .budget-badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600}
        .bg-h{background:#dcfce7;color:#16a34a}
        .bg-m{background:#fef3c7;color:#b45309}
        .bg-l{background:#f1f5f9;color:#64748b}
        .u-today{color:#dc2626;font-weight:600}
        .u-this_week{color:#b45309}
        .u-flexible{color:#64748b}
        .svc-tag{display:inline-block;padding:2px 8px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:4px;font-size:11px;color:#64748b;margin:1px}
        .has-notes{color:#2563eb;font-size:12px;margin-left:4px}
        .action-select{padding:6px 10px;font-size:13px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer}
        .time-ago{font-size:13px;color:#64748b}
        .empty-state{padding:48px;text-align:center;color:#64748b}
        .empty-state h3{margin-bottom:8px;color:#475569}
        .loading{padding:48px;text-align:center;color:#64748b}

        /* MODAL */
        .mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:100;justify-content:center;align-items:center}
        .mo.show{display:flex}
        .md{background:white;border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
        .md h2{margin-bottom:16px;font-size:18px}
        .mf{margin-bottom:12px}
        .ml{font-size:12px;color:#64748b;text-transform:uppercase;margin-bottom:4px}
        .mv{font-size:15px;color:#1e293b}
        .mc{margin-top:16px;padding:10px 20px;background:#f1f5f9;border:none;border-radius:8px;cursor:pointer;font-size:14px}
        .mc:hover{background:#e2e8f0}
        .mi{width:100%;padding:10px 14px;font-size:15px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:12px;outline:none;font-family:inherit}
        .mi:focus{border-color:#2563eb}
        .mt{width:100%;padding:10px 14px;font-size:15px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:12px;outline:none;min-height:80px;resize:vertical;font-family:inherit}
        .btn{padding:10px 20px;font-size:14px;font-weight:600;color:white;background:#2563eb;border:none;border-radius:8px;cursor:pointer;margin-right:8px}
        .btn:hover{background:#1d4ed8}
        .btn:disabled{opacity:.6;cursor:not-allowed}
        .btn.sec{background:#f1f5f9;color:#1e293b}
        .btn.sec:hover{background:#e2e8f0}
        .btn.red{background:#dc2626}
        .btn.grn{background:#16a34a}
        .btn.grn:hover{background:#15803d}
        .il{display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px}

        /* SLIDE */
        .slo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;justify-content:flex-end}
        .slo.show{display:flex}
        .slp{width:520px;max-width:100%;background:white;height:100vh;overflow-y:auto;box-shadow:-4px 0 24px rgba(0,0,0,.1);animation:si .2s ease}
        @keyframes si{from{transform:translateX(100%)}to{transform:translateX(0)}}
        .sl-top{padding:20px 24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:white;z-index:1}
        .sl-top h2{font-size:18px}
        .cl-btn{width:32px;height:32px;background:#f1f5f9;border:none;border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;color:#64748b}
        .cl-btn:hover{background:#e2e8f0}
        .sl-body{padding:24px}
        .dg{margin-bottom:24px}
        .dg-t{font-size:11px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #f1f5f9}
        .dr{display:grid;grid-template-columns:130px 1fr;gap:8px;margin-bottom:8px;font-size:14px}
        .dl{color:#64748b;font-weight:500}
        .dv{color:#1e293b}
        .sl-act{padding:20px 24px;border-top:1px solid #e2e8f0;display:flex;gap:8px;position:sticky;bottom:0;background:white}
        .sl-act .btn{flex:1;text-align:center}

        /* TENANT CARDS */
        .tg{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
        .tc{background:white;border-radius:12px;padding:20px 24px;box-shadow:0 1px 3px rgba(0,0,0,.08);border:1px solid #e2e8f0}
        .tc-name{font-size:16px;font-weight:700;margin-bottom:2px}
        .tc-email{font-size:13px;color:#64748b;margin-bottom:10px}
        .tc-meta{display:flex;gap:16px;font-size:12px;color:#94a3b8;margin-bottom:12px}
        .tc-id{padding:6px 10px;background:#f8fafc;border-radius:6px;font-size:11px;color:#94a3b8;font-family:monospace;word-break:break-all;margin-bottom:12px}
        .tc-login{border-top:1px solid #f1f5f9;padding-top:12px}
        .tc-login h4{font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.3px;margin-bottom:8px}
        .tc-row{display:flex;gap:8px;align-items:end}
        .tc-row .fld{flex:1;display:flex;flex-direction:column;gap:4px}
        .tc-row .fld label{font-size:11px;color:#94a3b8;font-weight:600}
        .tc-row input{padding:8px 10px;font-size:13px;border:1px solid #e2e8f0;border-radius:6px;font-family:inherit;outline:none;width:100%}
        .tc-row input:focus{border-color:#2563eb}
        .tc-row button{padding:8px 14px;font-size:12px;font-weight:600;background:#2563eb;color:white;border:none;border-radius:6px;cursor:pointer;white-space:nowrap;height:36px}
        .pw-st{font-size:11px;margin-top:6px}
        .pw-st.set{color:#16a34a}
        .pw-st.notset{color:#b45309}
        .pw-ok{color:#16a34a;font-size:14px;text-align:center;margin-bottom:12px;display:none}
        .pw-ok.show{display:block}

        @media(max-width:768px){
            .container{padding:16px}
            .kpi-grid{grid-template-columns:repeat(2,1fr)}
            .header-nav{display:none}
            .section-header{flex-direction:column;align-items:flex-start}
            .slp{width:100%}
            .header{padding:0 16px}
            .mob-nav{display:flex;gap:2px;padding:8px 16px;background:white;border-bottom:1px solid #e2e8f0;overflow-x:auto}
            .mob-nav button{padding:8px 14px;font-size:13px;font-weight:500;background:none;border:none;color:#64748b;cursor:pointer;border-radius:6px;white-space:nowrap}
            .mob-nav button.active{background:#eff6ff;color:#2563eb;font-weight:600}
            .tc-row{flex-direction:column}
        }
        @media(min-width:769px){.mob-nav{display:none}}

        /* NEW LEAD */
        .nl-cats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .nl-cat{display:flex;align-items:center;gap:8px;padding:10px 14px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;font-size:14px;transition:all .15s}
        .nl-cat:hover{border-color:#93c5fd}
        .nl-cat input{display:none}
        .nl-cat:has(input:checked){border-color:#2563eb;background:#eff6ff}
        .nl-sub{margin-bottom:4px;padding:12px 16px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0}

        /* ANGEBOT */
        .ang-overlay{display:none;position:fixed;inset:0;background:#f1f5f9;z-index:300;overflow-y:auto}
        .ang-overlay.show{display:block}
        .ang-header{background:white;border-bottom:1px solid #e2e8f0;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1}
        .ang-header h2{font-size:18px}
        .ang-body{max-width:900px;margin:24px auto;padding:0 24px}
        .ang-section{background:white;border-radius:12px;padding:24px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
        .ang-section h3{font-size:14px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:16px}
        .ang-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
        .ang-full{margin-bottom:12px}
        .ang-label{font-size:12px;font-weight:600;color:#64748b;margin-bottom:4px}
        .ang-input{width:100%;padding:10px 14px;font-size:14px;border:1px solid #e2e8f0;border-radius:8px;outline:none;font-family:inherit}
        .ang-input:focus{border-color:#2563eb}
        .ang-table{width:100%;border-collapse:collapse;margin-top:8px}
        .ang-table th{text-align:left;padding:10px 12px;font-size:12px;font-weight:600;color:#64748b;background:#f8fafc;border-bottom:1px solid #e2e8f0}
        .ang-table td{padding:8px 12px;border-bottom:1px solid #f1f5f9}
        .ang-table input{width:100%;padding:8px 10px;font-size:14px;border:1px solid #e2e8f0;border-radius:6px;outline:none;font-family:inherit}
        .ang-table input:focus{border-color:#2563eb}
        .ang-table .col-pos{width:50px}
        .ang-table .col-desc{min-width:200px}
        .ang-table .col-num{width:80px}
        .ang-table .col-price{width:100px}
        .ang-table .col-total{width:100px;font-weight:600;text-align:right;padding-right:12px}
        .ang-table .col-del{width:40px;text-align:center}
        .ang-del{background:none;border:none;color:#dc2626;cursor:pointer;font-size:16px;padding:4px}
        .ang-del:hover{color:#b91c1c}
        .ang-add{margin-top:8px;padding:8px 16px;font-size:13px;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:8px;cursor:pointer;color:#64748b;width:100%}
        .ang-add:hover{background:#eff6ff;border-color:#93c5fd;color:#2563eb}
        .ang-totals{margin-top:16px;text-align:right}
        .ang-totals div{margin-bottom:4px;font-size:14px;color:#64748b}
        .ang-totals .ang-brutto{font-size:18px;font-weight:700;color:#1e293b}
        .ang-actions{display:flex;gap:8px;flex-wrap:wrap}
        .ang-status{margin-top:12px;padding:12px 16px;border-radius:8px;font-size:14px;display:none}
        .ang-status.show{display:block}
        .ang-status.ok{background:#dcfce7;color:#166534}
        .ang-status.err{background:#fee2e2;color:#dc2626}
    </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <div class="login-logo">LeadCall24</div>
        <div class="login-step active" id="stepUser">
            <div class="login-subtitle">Bitte melden Sie sich an</div>
            <div class="login-error" id="errUser">Benutzername nicht gefunden</div>
            <div class="login-field"><label>Benutzername</label><input type="text" class="login-input" id="inUser" placeholder="Ihr Benutzername" autocomplete="username"></div>
            <button class="login-btn" id="btnUser">Weiter</button>
        </div>
        <div class="login-step" id="stepPw">
            <button class="login-back" onclick="goStep('user')">‚Üê Zur√ºck</button>
            <div class="login-welcome" id="welcName"></div>
            <div class="login-subtitle">Bitte geben Sie Ihr Passwort ein</div>
            <div class="login-error" id="errPw">Falsches Passwort</div>
            <div class="login-field"><label>Passwort</label><input type="password" class="login-input" id="inPw" placeholder="Ihr Passwort" autocomplete="current-password"></div>
            <button class="login-btn" id="btnPw">Anmelden</button>
        </div>
        <div class="login-step" id="stepSetPw">
            <button class="login-back" onclick="goStep('user')">‚Üê Zur√ºck</button>
            <div class="login-welcome" id="setupName"></div>
            <div class="setup-info"><p>üëã Willkommen! Dies ist Ihr erster Login. Bitte legen Sie jetzt ein pers√∂nliches Passwort fest.</p></div>
            <div class="login-error" id="errSetPw"></div>
            <div class="login-field"><label>Neues Passwort</label><input type="password" class="login-input" id="inNewPw" placeholder="Mindestens 6 Zeichen"></div>
            <div class="login-field"><label>Passwort wiederholen</label><input type="password" class="login-input" id="inConfPw" placeholder="Passwort best√§tigen"><div class="pw-match" id="pwMatch1"></div></div>
            <button class="login-btn" id="btnSetPw">Passwort festlegen & anmelden</button>
        </div>
    </div>
</div>

<!-- MAIN -->
<div class="main-content" id="mainContent">
    <header class="header">
        <div class="header-left">
            <div class="logo">LeadCall24</div>
            <div class="header-nav" id="headerNav"></div>
        </div>
        <div class="header-right">
            <div class="header-user">
                <span class="user-name" id="headerTitle"></span>
                <span class="admin-badge" id="adminBadge" style="display:none">Admin</span>
            </div>
            <button class="hdr-btn" id="changePwBtn" style="display:none" onclick="openChangePw()">üîë Passwort √§ndern</button>
            <button class="hdr-btn logout" onclick="doLogout()">Abmelden</button>
        </div>
    </header>
    <div class="mob-nav" id="mobNav"></div>
    <div class="container">
        <!-- LEADS -->
        <div class="tab-view" id="tab-leads">
            <div class="kpi-grid" id="kpiGrid"></div>
            <div class="section-header"><h2 class="section-title">Alle Anfragen</h2><div class="header-actions"><button class="btn" onclick="openNewLead()" style="font-size:13px;padding:8px 16px">+ Neuer Lead</button><div class="filter-group" id="leadFG"></div><select class="sort-select" onchange="leadSort=this.value;renderLeads()"><option value="newest">Neueste zuerst</option><option value="oldest">√Ñlteste zuerst</option><option value="budget_high">Budget ‚Üì</option><option value="budget_low">Budget ‚Üë</option><option value="urgency">Dringlichkeit</option></select><select class="sort-select" id="yearFilter" onchange="lyf=this.value;renderLeads()"><option value="all">Alle Jahre</option></select><button class="refresh-btn" onclick="loadLeads()">‚Üª Aktualisieren</button><button class="btn grn" id="btnNewLead" style="display:none" onclick="openNewLead()">+ Neuer Kunde</button></div></div>
            <div class="card"><table><thead><tr><th>Kontakt</th><th>Anfrage</th><th>Dringlichkeit</th><th>Eingang</th><th>Budget</th><th>Status</th><th>Aktion</th></tr></thead><tbody id="leadsTB"><tr><td colspan="7" class="loading">L√§dt...</td></tr></tbody></table></div>
        </div>
        <!-- ONBOARDING -->
        <div class="tab-view" id="tab-onboarding">
            <div class="kpi-grid" id="obKpi"></div>
            <div class="section-header"><h2 class="section-title">Onboarding-Anfragen</h2><div class="header-actions"><div class="filter-group" id="obFG"></div><button class="refresh-btn" onclick="loadOB()">‚Üª Aktualisieren</button></div></div>
            <div class="card"><table><thead><tr><th>Status</th><th>Firma</th><th>Kontakt</th><th>Telefon</th><th>Leistungen</th><th>Eingegangen</th></tr></thead><tbody id="obTB"><tr><td colspan="6" class="loading">L√§dt...</td></tr></tbody></table></div>
        </div>
        <!-- KUNDEN -->
        <div class="tab-view" id="tab-tenants">
            <div class="section-header"><h2 class="section-title">Aktive Kunden</h2><button class="refresh-btn" onclick="loadTenants()">‚Üª Aktualisieren</button></div>
            <div class="tg" id="tenantGrid"><div class="loading">L√§dt...</div></div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div class="mo" id="mLeadDetail" onclick="if(event.target===this)this.classList.remove('show')"><div class="md" style="max-width:520px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h2 id="ldTitle">Lead</h2><button class="btn sec" style="font-size:12px;padding:6px 12px" id="ldEditBtn" onclick="toggleEdit()">‚úèÔ∏è Bearbeiten</button></div><div id="ldView"></div><div id="ldEdit" style="display:none"></div><div style="margin-top:16px;display:flex;gap:8px"><button class="btn" id="ldSaveBtn" style="display:none" onclick="saveEditLead()">Speichern</button><button class="mc" onclick="$('mLeadDetail').classList.remove('show')">Schlie√üen</button></div></div></div>
<div class="mo" id="mOffer" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>Angebot gesendet</h2><p style="color:#64748b;margin-bottom:16px">Angebotssumme?</p><input type="number" class="mi" id="offerAmt" placeholder="z.B. 2500" step="0.01"><div><button class="btn" onclick="confirmOffer()">Speichern</button><button class="btn sec" onclick="$('mOffer').classList.remove('show')">Abbrechen</button></div></div></div>
<div class="mo" id="mNotes" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>Notizen</h2><textarea class="mt" id="notesTxt" placeholder="Notizen..."></textarea><div><button class="btn" onclick="saveNotes()">Speichern</button><button class="btn sec" onclick="$('mNotes').classList.remove('show')">Abbrechen</button></div></div></div>
<div class="mo" id="mTermin" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>üìÖ Termin vereinbaren</h2><p style="color:#64748b;margin-bottom:12px">Eine E-Mail mit Ihrem Buchungslink wird an den Kunden gesendet.</p><div class="mf"><label class="il">E-Mail des Kunden</label><input type="email" class="mi" id="terminEmail" placeholder="kunde@email.de"></div><div class="mf"><label class="il">Pers√∂nliche Nachricht <span style="font-weight:400;color:#94a3b8">(optional)</span></label><textarea class="mt" id="terminMsg" placeholder="z.B. Gerne m√∂chte ich mit Ihnen einen Termin vor Ort vereinbaren..."></textarea></div><div id="terminStatus" style="margin-bottom:12px"></div><div><button class="btn" id="terminSend" onclick="sendTermin()">üìß E-Mail senden</button><button class="btn sec" onclick="$('mTermin').classList.remove('show')">Abbrechen</button></div></div></div>
<div class="mo" id="mDel" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>Lead l√∂schen?</h2><p style="color:#64748b;margin-bottom:16px">Wirklich l√∂schen?</p><div><button class="btn red" onclick="confirmDel()">Ja, l√∂schen</button><button class="btn sec" onclick="$('mDel').classList.remove('show')">Abbrechen</button></div></div></div>

<!-- FOLLOW-UP MODAL -->
<div class="mo" id="mFollowUp" onclick="if(event.target===this)this.classList.remove('show')">
<div class="md" style="max-width:560px">
<h2>üìß Angebots-Follow-Up</h2>
<p style="color:#64748b;margin-bottom:16px">Senden Sie eine Nachfass-E-Mail zum versendeten Angebot.</p>
<div class="mf"><label class="il">E-Mail des Kunden</label><input type="email" class="mi" id="fuEmail" placeholder="kunde@email.de"></div>
<div class="mf"><label class="il">Betreff</label><input type="text" class="mi" id="fuBetreff" placeholder="z.B. Nachfrage zu unserem Angebot"></div>
<div class="mf"><label class="il">Nachricht</label><textarea class="mt" id="fuMsg" rows="8" style="min-height:160px"></textarea></div>
<div class="mf">
<label class="il">Anhang <span style="font-weight:400;color:#94a3b8">(optional, z.B. aktualisiertes Angebot)</span></label>
<input type="file" id="fuFile" class="mi" style="padding:8px" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
<div id="fuFileName" style="font-size:13px;color:#64748b;margin-top:4px"></div>
</div>
<div id="fuStatus" style="margin-bottom:12px"></div>
<div><button class="btn" id="fuSend" onclick="sendFollowUp()">üìß Follow-Up senden</button><button class="btn sec" onclick="$('mFollowUp').classList.remove('show')">Abbrechen</button></div>
</div>
</div>

<!-- BEWERTUNG MODAL -->
<div class="mo" id="mBewertung" onclick="if(event.target===this)this.classList.remove('show')">
<div class="md" style="max-width:560px">
<h2>‚≠ê Zufriedenheits-E-Mail</h2>
<p style="color:#64748b;margin-bottom:16px">Bitten Sie den Kunden um eine Google-Bewertung.</p>
<div class="mf"><label class="il">E-Mail des Kunden</label><input type="email" class="mi" id="bewEmail" placeholder="kunde@email.de"></div>
<div class="mf"><label class="il">Nachricht</label><textarea class="mt" id="bewMsg" rows="8" style="min-height:160px"></textarea></div>
<div id="bewStatus" style="margin-bottom:12px"></div>
<div><button class="btn" id="bewSend" onclick="sendBewertung()">‚≠ê Bewertungs-E-Mail senden</button><button class="btn sec" onclick="$('mBewertung').classList.remove('show')">Abbrechen</button></div>
</div>
</div>

<!-- NEW LEAD MODAL -->
<div class="mo" id="mNewLead" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="md" style="max-width:560px">
        <h2>Neuer Lead anlegen</h2>
        <div class="login-error" id="nlErr"></div>
        <div class="mf"><label class="il">Name *</label><input type="text" class="mi" id="nlName" placeholder="Vor- und Nachname"></div>
        <div class="mf"><label class="il">Telefon *</label><input type="tel" class="mi" id="nlPhone" placeholder="z.B. 0171 1234567"></div>
        <div class="mf"><label class="il">E-Mail <span style="font-weight:400;color:#94a3b8">(optional)</span></label><input type="email" class="mi" id="nlEmail" placeholder="E-Mail-Adresse"></div>
        <div class="mf"><label class="il">Firma <span style="font-weight:400;color:#94a3b8">(optional)</span></label><input type="text" class="mi" id="nlCompany" placeholder="Firmenname"></div>
        <div class="mf"><label class="il">Kundenart *</label>
            <div class="nl-cats" style="grid-template-columns:1fr 1fr">
                <label class="nl-cat"><input type="radio" name="nl_kundenart" value="privat"><span>üë§ Privat</span></label>
                <label class="nl-cat"><input type="radio" name="nl_kundenart" value="gewerbe"><span>üè¢ Gewerbe</span></label>
            </div>
        </div>
        <div class="mf"><label class="il">Datum der Anfrage <span style="font-weight:400;color:#94a3b8">(optional ‚Äì leer = heute)</span></label><input type="date" class="mi" id="nlDate" style="padding:10px 14px"></div>
        <div class="mf">
            <label class="il">Um was geht es? *</label>
            <div class="nl-cats" id="nlCats">
                <label class="nl-cat"><input type="radio" name="nl_cat" value="hausmeisterpflege" onchange="nlCatChange(this.value)"><span>üåø Hausmeisterpflege</span></label>
                <label class="nl-cat"><input type="radio" name="nl_cat" value="gebaeudereinigung" onchange="nlCatChange(this.value)"><span>üè¢ Geb√§udereinigung</span></label>
                <label class="nl-cat"><input type="radio" name="nl_cat" value="hausmeisterdienste" onchange="nlCatChange(this.value)"><span>üîß Hausmeisterdienste</span></label>
                <label class="nl-cat"><input type="radio" name="nl_cat" value="sonstiges" onchange="nlCatChange(this.value)"><span>üí¨ Sonstiges</span></label>
            </div>
        </div>
        <div class="nl-sub" id="nlSubHM" style="display:none">
            <div class="mf"><label class="il">Bereich</label>
                <select class="mi" id="nlSubHMSel" style="padding:10px 14px"><option value="">Bitte w√§hlen</option><option value="gruenflachenpflege">Gr√ºnfl√§chenpflege</option><option value="winterdienst">Winterdienst</option></select>
            </div>
            <div class="mf"><label class="il">Wie oft? <span style="font-weight:400;color:#94a3b8">(optional)</span></label>
                <select class="mi" id="nlFreqHM" style="padding:10px 14px"><option value="">‚Äì</option><option value="1x_woche">1√ó pro Woche</option><option value="2x_woche">2√ó pro Woche</option><option value="3x_woche">3√ó pro Woche</option><option value="4x_woche">4√ó pro Woche</option><option value="1x_monat">1√ó pro Monat</option><option value="einmalig">Einmalig</option></select>
            </div>
        </div>
        <div class="nl-sub" id="nlSubGR" style="display:none">
            <div class="mf"><label class="il">Art der Reinigung</label>
                <select class="mi" id="nlSubGRSel" style="padding:10px 14px"><option value="">Bitte w√§hlen</option><option value="grundreinigung">Grundreinigung</option><option value="glasreinigung">Glasreinigung</option><option value="baufeinreinigung">Baufeinreinigung</option><option value="solaranlagenreinigung">Solaranlagenreinigung</option><option value="unterhaltsreinigung">Unterhaltsreinigung</option></select>
            </div>
            <div class="mf"><label class="il">Gesch√§tzte Fl√§che <span style="font-weight:400;color:#94a3b8">(optional)</span></label><input type="number" class="mi" id="nlFlaeche" placeholder="z.B. 150 m¬≤"></div>
            <div class="mf"><label class="il">Wie oft? <span style="font-weight:400;color:#94a3b8">(optional)</span></label>
                <select class="mi" id="nlFreqGR" style="padding:10px 14px"><option value="">‚Äì</option><option value="1x_woche">1√ó pro Woche</option><option value="2x_woche">2√ó pro Woche</option><option value="3x_woche">3√ó pro Woche</option><option value="4x_woche">4√ó pro Woche</option><option value="1x_monat">1√ó pro Monat</option><option value="einmalig">Einmalig</option></select>
            </div>
        </div>
        <div class="nl-sub" id="nlSubHD" style="display:none">
            <div class="mf"><label class="il">Anzahl der Wohneinheiten</label><input type="number" class="mi" id="nlWE" placeholder="z.B. 12"></div>
            <div class="mf"><label class="il">Gesamtfl√§che ca. <span style="font-weight:400;color:#94a3b8">(optional)</span></label><input type="number" class="mi" id="nlFlaecheHD" placeholder="z.B. 800 m¬≤"></div>
            <div class="mf"><label class="il">Gew√ºnschter Start</label>
                <select class="mi" id="nlStart" style="padding:10px 14px"><option value="">‚Äì</option><option value="sofort">Sofort</option><option value="1_monat">Innerhalb 1 Monat</option><option value="3_monate">Innerhalb 3 Monate</option><option value="flexibel">Flexibel</option></select>
            </div>
        </div>
        <div class="mf"><label class="il">Beschreibung <span style="font-weight:400;color:#94a3b8">(optional)</span></label><textarea class="mt" id="nlDesc" placeholder="Weitere Details..."></textarea></div>
        <div><button class="btn" id="nlSave" onclick="saveNewLead()">Lead anlegen</button><button class="btn sec" onclick="$('mNewLead').classList.remove('show')">Abbrechen</button></div>
    </div>
</div>

<!-- ANGEBOT EDITOR -->
<div class="slo" id="angSlide" onclick="if(event.target===this)closeAng()">
<div class="slp" style="width:700px">
<div class="sl-top"><h2>üìÑ Angebot erstellen</h2><button class="cl-btn" onclick="closeAng()">‚úï</button></div>
<div class="sl-body">
<div class="dg">
<div class="dg-t">Kundendaten</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div><label class="il">Name</label><input class="mi" id="angName"></div>
<div><label class="il">Firma</label><input class="mi" id="angFirma"></div>
<div><label class="il">E-Mail</label><input class="mi" id="angEmail" type="email"></div>
<div><label class="il">Telefon</label><input class="mi" id="angPhone"></div>
</div>
<div style="margin-top:8px"><label class="il">Adresse</label><input class="mi" id="angAddr" placeholder="Stra√üe, PLZ Ort"></div>
</div>
<div class="dg">
<div class="dg-t">Angebotsdaten</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div><label class="il">Angebots-Nr.</label><input class="mi" id="angNr"></div>
<div><label class="il">Datum</label><input class="mi" id="angDatum" type="date"></div>
<div><label class="il">G√ºltig bis</label><input class="mi" id="angGueltig" type="date"></div>
<div><label class="il">Betreff</label><input class="mi" id="angBetreff" placeholder="z.B. Unterhaltsreinigung B√ºrogeb√§ude"></div>
</div>
</div>
<div class="dg">
<div class="dg-t">Positionen</div>
<table style="width:100%;font-size:13px;border-collapse:collapse" id="angTable">
<thead><tr style="background:#f8fafc">
<th style="padding:8px;text-align:left;width:40px">Pos</th>
<th style="padding:8px;text-align:left">Beschreibung</th>
<th style="padding:8px;text-align:right;width:60px">Menge</th>
<th style="padding:8px;text-align:left;width:60px">Einheit</th>
<th style="padding:8px;text-align:right;width:90px">Einzelpreis</th>
<th style="padding:8px;text-align:right;width:90px">Gesamt</th>
<th style="padding:8px;width:30px"></th>
</tr></thead>
<tbody id="angRows"></tbody>
</table>
<button class="btn sec" style="margin-top:8px;font-size:12px" onclick="addAngRow()">+ Position hinzuf√ºgen</button>
<div style="margin-top:16px;text-align:right;font-size:14px">
<div style="margin-bottom:4px">Netto: <strong id="angNetto">0,00 ‚Ç¨</strong></div>
<div style="margin-bottom:4px">MwSt. (19%): <span id="angMwst">0,00 ‚Ç¨</span></div>
<div style="font-size:18px;font-weight:700;color:#1e293b">Brutto: <span id="angBrutto">0,00 ‚Ç¨</span></div>
</div>
</div>
<div class="dg">
<div class="dg-t">Anmerkungen (optional)</div>
<textarea class="mt" id="angNotes" placeholder="z.B. Zahlungsbedingungen, Sonderkonditionen..."></textarea>
</div>
</div>
<div class="sl-act" style="flex-wrap:wrap">
<button class="btn" onclick="genAngPDF('download')">üíæ PDF herunterladen</button>
<button class="btn grn" onclick="genAngPDF('send')">üìß PDF per E-Mail senden</button>
<button class="btn sec" onclick="closeAng()">Abbrechen</button>
</div>
</div>
</div>

<!-- Onboarding detail slide -->
<div class="slo" id="obSlide" onclick="if(event.target===this)closeOB()"><div class="slp"><div class="sl-top"><h2 id="obSlTitle">Details</h2><button class="cl-btn" onclick="closeOB()">‚úï</button></div><div class="sl-body" id="obSlBody"></div><div class="sl-act" id="obSlAct"></div></div></div>

<!-- Activate -->
<div class="mo" id="mActivate" onclick="if(event.target===this)this.classList.remove('show')"><div class="md"><h2>Kunde aktivieren</h2><p style="color:#64748b;margin-bottom:16px">Lege einen Benutzernamen fest. Der Kunde erstellt sein Passwort beim ersten Login selbst.</p><div class="mf"><label class="il">Benutzername</label><input type="text" class="mi" id="actUser" placeholder="z.B. mueller-sanitaer" autocomplete="off"><div style="font-size:12px;color:#94a3b8;margin-top:-8px">Kleinbuchstaben, keine Leerzeichen</div></div><div><button class="btn grn" onclick="confirmActivate()">Aktivieren</button><button class="btn sec" onclick="$('mActivate').classList.remove('show')">Abbrechen</button></div></div></div>

<!-- CHANGE PASSWORD (f√ºr eingeloggte Kunden) -->

<!-- NEW LEAD MODAL -->
<div class="mo" id="mNewLead" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="md" style="max-width:520px;max-height:90vh;overflow-y:auto">
        <h2>Neuen Kunden eintragen</h2>
        <div class="login-error" id="nlErr"></div>
        <div class="mf"><label class="il">Name *</label><input type="text" class="mi" id="nlName" placeholder="Vor- und Nachname"></div>
        <div class="mf"><label class="il">Telefon *</label><input type="tel" class="mi" id="nlPhone" placeholder="z.B. 0171 1234567"></div>
        <div class="mf"><label class="il">E-Mail</label><input type="email" class="mi" id="nlEmail" placeholder="optional"></div>
        <div class="mf"><label class="il">Firma</label><input type="text" class="mi" id="nlCompany" placeholder="optional"></div>
        <div class="mf">
            <label class="il">Kategorie *</label>
            <select class="mi" id="nlCategory" onchange="nlCatChange()">
                <option value="">Bitte w√§hlen...</option>
                <option value="hausmeisterpflege">üåø Hausmeisterpflege</option>
                <option value="gebaeudereinigung">üè¢ Geb√§udereinigung</option>
                <option value="hausmeisterdienste">üîß Hausmeisterdienste</option>
                <option value="sonstiges">üí¨ Sonstiges</option>
            </select>
        </div>
        <div id="nlSubHMP" style="display:none" class="mf">
            <label class="il">Leistung</label>
            <select class="mi" id="nlSubHMP_sel">
                <option value="">Bitte w√§hlen...</option>
                <option value="gruenflachenpflege">Gr√ºnfl√§chenpflege</option>
                <option value="winterdienst">Winterdienst</option>
            </select>
        </div>
        <div id="nlSubGR" style="display:none" class="mf">
            <label class="il">Leistung</label>
            <select class="mi" id="nlSubGR_sel">
                <option value="">Bitte w√§hlen...</option>
                <option value="grundreinigung">Grundreinigung</option>
                <option value="glasreinigung">Glasreinigung</option>
                <option value="baufeinreinigung">Baufeinreinigung</option>
                <option value="solaranlagenreinigung">Solaranlagenreinigung</option>
                <option value="unterhaltsreinigung">Unterhaltsreinigung</option>
            </select>
        </div>
        <div id="nlFlaeche" style="display:none" class="mf">
            <label class="il">Fl√§che in m¬≤</label>
            <input type="number" class="mi" id="nlQm" placeholder="z.B. 150">
        </div>
        <div id="nlFreq" style="display:none" class="mf">
            <label class="il">Frequenz</label>
            <select class="mi" id="nlFreq_sel">
                <option value="">Bitte w√§hlen...</option>
                <option value="1x_woche">1√ó pro Woche</option>
                <option value="2x_woche">2√ó pro Woche</option>
                <option value="3x_woche">3√ó pro Woche</option>
                <option value="4x_woche">4√ó pro Woche</option>
                <option value="1x_monat">1√ó pro Monat</option>
                <option value="einmalig">Einmalig</option>
            </select>
        </div>
        <div id="nlHMD" style="display:none">
            <div class="mf"><label class="il">Anzahl Wohneinheiten</label><input type="number" class="mi" id="nlWE" placeholder="z.B. 12"></div>
            <div class="mf"><label class="il">Gesamtfl√§che ca. in m¬≤</label><input type="number" class="mi" id="nlHMDqm" placeholder="z.B. 800"></div>
            <div class="mf">
                <label class="il">Gew√ºnschter Start</label>
                <select class="mi" id="nlStart">
                    <option value="">Bitte w√§hlen...</option>
                    <option value="sofort">Sofort</option>
                    <option value="1_monat">Innerhalb 1 Monat</option>
                    <option value="3_monate">Innerhalb 3 Monate</option>
                    <option value="flexibel">Flexibel</option>
                </select>
            </div>
        </div>
        <div class="mf"><label class="il">Beschreibung</label><textarea class="mt" id="nlDesc" placeholder="Weitere Details..."></textarea></div>
        <div>
            <button class="btn grn" onclick="saveNewLead()">Kunde speichern</button>
            <button class="btn sec" onclick="$('mNewLead').classList.remove('show')">Abbrechen</button>
        </div>
    </div>
</div>

<div class="mo" id="mChangePw" onclick="if(event.target===this)closeChangePw()">
    <div class="md" onclick="event.stopPropagation()">
        <h2>Passwort √§ndern</h2>
        <div class="pw-ok" id="cpwOk">‚úì Passwort erfolgreich ge√§ndert!</div>
        <div class="login-error" id="cpwErr"></div>
        <div class="mf"><label class="il">Aktuelles Passwort</label><input type="password" class="mi" id="cpwCur" placeholder="Ihr aktuelles Passwort"></div>
        <div class="mf"><label class="il">Neues Passwort</label><input type="password" class="mi" id="cpwNew" placeholder="Mindestens 6 Zeichen"></div>
        <div class="mf"><label class="il">Neues Passwort wiederholen</label><input type="password" class="mi" id="cpwConf" placeholder="Passwort best√§tigen"><div class="pw-match" id="cpwMatch"></div></div>
        <div><button class="btn" id="cpwSave" onclick="saveChangePw()">Passwort √§ndern</button><button class="btn sec" onclick="closeChangePw()">Abbrechen</button></div>
    </div>
</div>

<!-- ANGEBOT EDITOR -->
<div class="ang-overlay" id="angOverlay">
    <div class="ang-header">
        <h2>üìÑ Angebot erstellen</h2>
        <div class="ang-actions">
            <button class="btn sec" onclick="closeAngebot()">‚Üê Zur√ºck</button>
            <button class="btn" onclick="previewPDF()">üëÅ Vorschau</button>
            <button class="btn grn" onclick="downloadPDF()">‚¨á PDF Download</button>
            <button class="btn" onclick="sendAngebot()" id="angSendBtn">üìß Per E-Mail senden</button>
        </div>
    </div>
    <div class="ang-body">
        <div class="ang-status" id="angStatus"></div>
        <div class="ang-section">
            <h3>Absender</h3>
            <div class="ang-row">
                <div><div class="ang-label">Firma</div><input class="ang-input" id="angFirma" value="Hausmeisterservice Sykora"></div>
                <div><div class="ang-label">Inhaber</div><input class="ang-input" id="angInhaber" value="Markus Sykora"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">Adresse</div><input class="ang-input" id="angAdresse" value="Rosenheimer Str. 18, 85560 Ebersberg"></div>
                <div><div class="ang-label">Telefon</div><input class="ang-input" id="angTel" value="080922504830"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">E-Mail</div><input class="ang-input" id="angEmail" value="m.sykora@hausmeisterservicesykora.de"></div>
                <div><div class="ang-label">Steuernummer / USt-IdNr.</div><input class="ang-input" id="angSteuer" placeholder="z.B. DE123456789"></div>
            </div>
        </div>
        <div class="ang-section">
            <h3>Empf√§nger</h3>
            <div class="ang-row">
                <div><div class="ang-label">Name / Firma</div><input class="ang-input" id="angKunde"></div>
                <div><div class="ang-label">Ansprechpartner</div><input class="ang-input" id="angAnsprech"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">Adresse</div><input class="ang-input" id="angKAdresse" placeholder="Stra√üe, PLZ Ort"></div>
                <div><div class="ang-label">E-Mail</div><input class="ang-input" id="angKEmail"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">Anrede</div><input class="ang-input" id="angAnrede" placeholder="z.B. Sehr geehrte Frau Muster,"></div>
                <div><div class="ang-label">Objekt-Adresse</div><input class="ang-input" id="angObjekt" placeholder="Stra√üe, PLZ Ort des Objekts"></div>
            </div>
        </div>
        <div class="ang-section">
            <h3>Angebot</h3>
            <div class="ang-row">
                <div><div class="ang-label">Angebotsnummer</div><input class="ang-input" id="angNr"></div>
                <div><div class="ang-label">Datum</div><input class="ang-input" id="angDatum" type="date"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">G√ºltig bis</div><input class="ang-input" id="angGueltig" type="date"></div>
                <div><div class="ang-label">Angebotstyp</div><select class="ang-input" id="angTyp" style="padding:10px 14px"><option value="Hausmeistert√§tigkeiten">Hausmeistert√§tigkeiten</option><option value="Geb√§udereinigung">Geb√§udereinigung</option><option value="Gr√ºnfl√§chenpflege">Gr√ºnfl√§chenpflege</option><option value="Winterdienst">Winterdienst</option><option value="Sonstiges">Sonstiges</option></select></div>
            </div>
            <div class="ang-full"><div class="ang-label">Betreff</div><input class="ang-input" id="angBetreff" placeholder="z.B. Angebot Unterhaltsreinigung"></div>
        </div>
        <div class="ang-section">
            <h3>Positionen</h3>
            <table class="ang-table">
                <thead><tr><th class="col-pos">Pos.</th><th class="col-desc">Beschreibung</th><th class="col-num">Menge</th><th class="col-num">Einheit</th><th class="col-price">Einzelpreis</th><th class="col-total">Gesamt</th><th class="col-del"></th></tr></thead>
                <tbody id="angPosTB"></tbody>
            </table>
            <button class="ang-add" onclick="addAngPos()">+ Position hinzuf√ºgen</button>
            <div class="ang-totals" id="angTotals"></div>
        </div>
        <div class="ang-section">
            <h3>Bedingungen</h3>
            <div class="ang-row">
                <div><div class="ang-label">Ausf√ºhrungszeitraum</div><input class="ang-input" id="angAusfuehrung" value="Sofort / nach Vereinbarung"></div>
                <div><div class="ang-label">Zahlungsbedingungen</div><input class="ang-input" id="angZahlung" value="Monatsrechnungen sp√§testens am letzten Tag des Monats f√§llig"></div>
            </div>
            <div class="ang-row">
                <div><div class="ang-label">Auftragsbedingungen</div><input class="ang-input" id="angAuftragsbed" value="Ein Hausmeistervertrag wird abgeschlossen"></div>
                <div><div class="ang-label">MwSt. (%)</div><input class="ang-input" id="angMwst" type="number" value="19" min="0" max="100" onchange="calcAngTotals()"></div>
            </div>
            <div class="ang-full"><div class="ang-label">Hinweis Zusatzleistungen</div><textarea class="ang-input" id="angZusatz" rows="2" style="resize:vertical">Zusatzleistungen wie Fensterreinigung und Sonderaufgaben werden nach Auftragserteilung separat abgerechnet. Verbrauchsmaterialien (Leuchtmittel, Schnittgut, Streusplitter usw.) werden gesondert abgerechnet.</textarea></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script>
const SB='https://fbkkyzvumytipjtnrjrn.supabase.co',SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZia2t5enZ1bXl0aXBqdG5yanJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzM0MTMsImV4cCI6MjA4NTI0OTQxM30.FsdSHmWuyP5QiKqGbaDG6XZJiAzaOKdsbqgrXKrfQCk';
const AU='admin',AP='leadcall2024';
const SL={new:'Neu',contacted:'Kontaktiert',offer_sent:'Angebot gesendet',won:'Gewonnen',lost:'Verloren',bestandskunde:'Bestandskunde'};
const OL={new:'Neu',in_progress:'In Bearb.',completed:'Fertig',rejected:'Abgelehnt'};
const UL={today:'Heute',this_week:'Diese Woche',flexible:'Flexibel'};
const BL={under_500:'Unter 500‚Ç¨','500_2000':'500‚Äì2.000‚Ç¨','2000_5000':'2.000‚Äì5.000‚Ç¨',over_5000:'√úber 5.000‚Ç¨',unknown:'Unbekannt'};
const BV={under_500:250,'500_2000':1250,'2000_5000':3500,over_5000:7500,unknown:0};
const SVL={sanitaer:'Sanit√§r',heizung:'Heizung',elektro:'Elektro',klima:'Klima',solar:'Solar',bad:'Bad'};
function bc(b){return(b==='over_5000'||b==='2000_5000')?'bg-h':b==='500_2000'?'bg-m':'bg-l';}
function $(id){return document.getElementById(id);}

let isAdmin=false,tid=null,tname='',tpw='';
let leads=[],obReqs=[],tenants=[];
let lf='all',ls='newest',of='all',lyf='all';
let curLead=null,curOb=null,pendT=null;

const H={'apikey':SK,'Authorization':`Bearer ${SK}`};
const JH={...H,'Content-Type':'application/json'};
async function sG(t,q=''){return(await fetch(`${SB}/rest/v1/${t}?${q}`,{headers:H})).json();}
async function sU(t,id,d){return(await fetch(`${SB}/rest/v1/${t}?id=eq.${id}`,{method:'PATCH',headers:{...JH,'Prefer':'return=representation'},body:JSON.stringify(d)})).json();}
async function sI(t,d){return(await fetch(`${SB}/rest/v1/${t}`,{method:'POST',headers:{...JH,'Prefer':'return=representation'},body:JSON.stringify(d)})).json();}
async function sD(t,id){return(await fetch(`${SB}/rest/v1/${t}?id=eq.${id}`,{method:'DELETE',headers:H})).ok;}

// ===== LOGIN =====
function goStep(s){
    document.querySelectorAll('.login-step').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.login-error').forEach(x=>x.classList.remove('show'));
    if(s==='user'){$('stepUser').classList.add('active');$('inUser').focus();}
    else if(s==='pw'){$('stepPw').classList.add('active');$('inPw').value='';$('inPw').focus();}
    else{$('stepSetPw').classList.add('active');$('inNewPw').value='';$('inConfPw').value='';$('pwMatch1').textContent='';$('inNewPw').focus();}
}

$('btnUser').onclick=chkUser;$('inUser').onkeydown=e=>{if(e.key==='Enter')chkUser();};
async function chkUser(){
    const u=$('inUser').value.trim().toLowerCase();if(!u)return;
    const b=$('btnUser');b.disabled=true;b.textContent='Pr√ºfe...';$('errUser').classList.remove('show');
    if(u===AU){$('welcName').textContent='Admin-Zugang';pendT=null;goStep('pw');b.disabled=false;b.textContent='Weiter';return;}
    try{
        const r=await sG('tenants',`username=eq.${encodeURIComponent(u)}`);
        if(r.length){pendT=r[0];if(r[0].password){$('welcName').textContent=r[0].name;goStep('pw');}else{$('setupName').textContent=`Willkommen, ${r[0].name}!`;goStep('set');}}
        else $('errUser').classList.add('show');
    }catch(e){$('errUser').textContent='Verbindungsfehler.';$('errUser').classList.add('show');}
    b.disabled=false;b.textContent='Weiter';
}

$('btnPw').onclick=chkPw;$('inPw').onkeydown=e=>{if(e.key==='Enter')chkPw();};
async function chkPw(){
    const pw=$('inPw').value;if(!pw)return;
    const b=$('btnPw');b.disabled=true;b.textContent='Pr√ºfe...';$('errPw').classList.remove('show');
    if(!pendT&&pw===AP){isAdmin=true;sessionStorage.setItem('lc_r','admin');showApp();b.disabled=false;b.textContent='Anmelden';return;}
    if(pendT&&pendT.password===pw){isAdmin=false;tid=pendT.id;tname=pendT.name;tpw=pw;sessionStorage.setItem('lc_r','tenant');sessionStorage.setItem('lc_t',tid);sessionStorage.setItem('lc_n',tname);sessionStorage.setItem('lc_p',pw);showApp();b.disabled=false;b.textContent='Anmelden';return;}
    $('errPw').classList.add('show');b.disabled=false;b.textContent='Anmelden';
}

$('inConfPw').oninput=function(){const p1=$('inNewPw').value,p2=this.value,m=$('pwMatch1');if(!p2){m.textContent='';return;}m.textContent=p1===p2?'‚úì Passw√∂rter stimmen √ºberein':'‚úó Stimmen nicht √ºberein';m.className='pw-match '+(p1===p2?'ok':'no');};
$('btnSetPw').onclick=setPw;$('inConfPw').onkeydown=e=>{if(e.key==='Enter')setPw();};
async function setPw(){
    const p1=$('inNewPw').value,p2=$('inConfPw').value,err=$('errSetPw');err.classList.remove('show');
    if(p1.length<6){err.textContent='Mindestens 6 Zeichen.';err.classList.add('show');return;}
    if(p1!==p2){err.textContent='Passw√∂rter stimmen nicht √ºberein.';err.classList.add('show');return;}
    if(!pendT)return;
    const b=$('btnSetPw');b.disabled=true;b.textContent='Wird gespeichert...';
    try{await sU('tenants',pendT.id,{password:p1});isAdmin=false;tid=pendT.id;tname=pendT.name;tpw=p1;sessionStorage.setItem('lc_r','tenant');sessionStorage.setItem('lc_t',tid);sessionStorage.setItem('lc_n',tname);sessionStorage.setItem('lc_p',p1);showApp();}
    catch(e){err.textContent='Fehler.';err.classList.add('show');}
    b.disabled=false;b.textContent='Passwort festlegen & anmelden';
}

function doLogout(){sessionStorage.clear();location.reload();}
function chkSession(){const r=sessionStorage.getItem('lc_r');if(r==='admin'){isAdmin=true;showApp();}else if(r==='tenant'){tid=sessionStorage.getItem('lc_t');tname=sessionStorage.getItem('lc_n');tpw=sessionStorage.getItem('lc_p')||'';if(tid){isAdmin=false;showApp();}}}

// ===== CHANGE PASSWORD (tenant) =====
function openChangePw(){$('cpwCur').value='';$('cpwNew').value='';$('cpwConf').value='';$('cpwMatch').textContent='';$('cpwErr').classList.remove('show');$('cpwOk').classList.remove('show');$('cpwSave').disabled=false;$('mChangePw').classList.add('show');}
function closeChangePw(){$('mChangePw').classList.remove('show');}
$('cpwConf').oninput=function(){const p1=$('cpwNew').value,p2=this.value,m=$('cpwMatch');if(!p2){m.textContent='';return;}m.textContent=p1===p2?'‚úì Stimmen √ºberein':'‚úó Stimmen nicht √ºberein';m.className='pw-match '+(p1===p2?'ok':'no');};
async function saveChangePw(){
    const cur=$('cpwCur').value,p1=$('cpwNew').value,p2=$('cpwConf').value,err=$('cpwErr'),ok=$('cpwOk');
    err.classList.remove('show');ok.classList.remove('show');
    if(cur!==tpw){err.textContent='Aktuelles Passwort ist falsch.';err.classList.add('show');return;}
    if(p1.length<6){err.textContent='Neues Passwort: mindestens 6 Zeichen.';err.classList.add('show');return;}
    if(p1!==p2){err.textContent='Neue Passw√∂rter stimmen nicht √ºberein.';err.classList.add('show');return;}
    if(p1===cur){err.textContent='Neues Passwort muss sich unterscheiden.';err.classList.add('show');return;}
    const b=$('cpwSave');b.disabled=true;b.textContent='Speichert...';
    try{
        await sU('tenants',tid,{password:p1});
        tpw=p1;sessionStorage.setItem('lc_p',p1);
        ok.classList.add('show');
        $('cpwCur').value='';$('cpwNew').value='';$('cpwConf').value='';$('cpwMatch').textContent='';
        setTimeout(closeChangePw,1500);
    }catch(e){err.textContent='Fehler beim Speichern.';err.classList.add('show');}
    b.disabled=false;b.textContent='Passwort √§ndern';
}

// ===== APP =====
function showApp(){
    $('loginOverlay').classList.add('hidden');$('mainContent').classList.add('show');
    if(isAdmin){$('headerTitle').textContent='Admin';$('adminBadge').style.display='';$('changePwBtn').style.display='none';buildNav(['onboarding','leads','tenants'],['Onboarding','Alle Leads','Kunden']);switchTab('onboarding');loadOB();loadLeads();loadTenants();}
    else{$('headerTitle').textContent=tname;$('adminBadge').style.display='none';$('changePwBtn').style.display='';$('btnNewLead').style.display='';buildNav(['leads'],['Anfragen']);switchTab('leads');loadLeads();}
}
function buildNav(tabs,labels){const n=$('headerNav'),m=$('mobNav');n.innerHTML='';m.innerHTML='';tabs.forEach((t,i)=>{const b=document.createElement('button');b.textContent=labels[i];b.dataset.tab=t;b.onclick=()=>switchTab(t);n.appendChild(b);const b2=b.cloneNode(true);b2.onclick=()=>switchTab(t);m.appendChild(b2);});}
function switchTab(t){document.querySelectorAll('.tab-view').forEach(x=>x.classList.remove('active'));$(`tab-${t}`).classList.add('active');document.querySelectorAll('.header-nav button,.mob-nav button').forEach(b=>b.classList.toggle('active',b.dataset.tab===t));}

// ===== LEADS =====
function buildLF(){$('leadFG').innerHTML=[['all','Alle'],['new','Neu'],['offer_sent','Angebot'],['won','Gewonnen'],['bestandskunde','Bestandskunde'],['lost','Verloren']].map(([v,l])=>`<button class="filter-btn${lf===v?' active':''}" onclick="lf='${v}';buildLF();renderLeads()">${l}</button>`).join('');}
async function loadLeads(){buildLF();try{leads=await sG('leads',isAdmin?'order=created_at.desc':`tenant_id=eq.${tid}&order=created_at.desc`);buildYF();renderKpis();renderLeads();}catch(e){$('leadsTB').innerHTML=`<tr><td colspan="7" class="empty-state">Fehler: ${e.message}</td></tr>`;}}
function buildYF(){const yrs=[...new Set(leads.map(l=>new Date(l.created_at).getFullYear()))].sort((a,b)=>b-a);const sel=$('yearFilter');sel.innerHTML='<option value="all">Alle Jahre</option>'+yrs.map(y=>`<option value="${y}"${lyf==y?' selected':''}>${y}</option>`).join('');}
function renderKpis(){const a=new Date(Date.now()-30*864e5),r=leads.filter(l=>new Date(l.created_at)>=a),nw=r.filter(l=>l.status==='new').length,of=r.filter(l=>l.offer_sent_at).length,wo=r.filter(l=>l.status==='won').length,lo=r.filter(l=>l.status==='lost').length,wO=r.filter(l=>l.offer_sent_at&&l.created_at);let avg='-';if(wO.length){const t=wO.reduce((s,l)=>s+(new Date(l.offer_sent_at)-new Date(l.created_at))/36e5,0)/wO.length;avg=t<24?`${Math.round(t)}h`:`${Math.round(t/24)}d`;}const cv=r.length?Math.round(wo/r.length*100):0;$('kpiGrid').innerHTML=`<div class="kpi-card hl"><div class="kpi-value">${nw}</div><div class="kpi-label">Neue Leads</div></div><div class="kpi-card"><div class="kpi-value">${of}</div><div class="kpi-label">Angebote</div></div><div class="kpi-card ok"><div class="kpi-value">${wo}</div><div class="kpi-label">Gewonnen</div></div><div class="kpi-card bad"><div class="kpi-value">${lo}</div><div class="kpi-label">Verloren</div></div><div class="kpi-card"><div class="kpi-value">${avg}</div><div class="kpi-label">‚åÄ Antwortzeit</div></div><div class="kpi-card"><div class="kpi-value">${cv}%</div><div class="kpi-label">Conversion</div></div>`;}
function sortL(l){const s=[...l];switch(ls){case 'newest':s.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));break;case 'oldest':s.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));break;case 'budget_high':s.sort((a,b)=>(BV[b.budget]||0)-(BV[a.budget]||0));break;case 'budget_low':s.sort((a,b)=>(BV[a.budget]||0)-(BV[b.budget]||0));break;case 'urgency':const o={today:0,this_week:1,flexible:2};s.sort((a,b)=>(o[a.urgency]??3)-(o[b.urgency]??3));break;}return s;}
function renderLeads(){const tb=$('leadsTB');let f=lf==='all'?leads:leads.filter(l=>l.status===lf);if(lyf!=='all')f=f.filter(l=>new Date(l.created_at).getFullYear()==lyf);f=sortL(f);if(!f.length){tb.innerHTML='<tr><td colspan="7" class="empty-state"><h3>Keine Anfragen</h3></td></tr>';return;}tb.innerHTML=f.map(l=>`<tr class="clickable" onclick="showLD('${l.id}')"><td><div style="font-weight:600">${esc(l.name||'Unbekannt')}${l.notes?'<span class="has-notes">üìù</span>':''}</div><div style="font-size:13px;color:#64748b">${esc(l.phone||'-')}</div></td><td><div>${esc(l.service_type||'-')}</div>${l.company?`<div style="font-size:13px;color:#64748b">${esc(l.company)}</div>`:''}${l.offer_amount?`<div style="font-size:13px;color:#16a34a;font-weight:600">${parseFloat(l.offer_amount).toLocaleString('de-DE')} ‚Ç¨</div>`:''}</td><td><span class="u-${l.urgency||'flexible'}">${UL[l.urgency]||'Flexibel'}</span></td><td><span class="time-ago">${timeAgo(l.created_at)}</span></td><td><span class="budget-badge ${bc(l.budget)}">${BL[l.budget]||'Unbekannt'}</span></td><td><span class="badge b-${l.status}">${SL[l.status]||l.status}</span></td><td onclick="event.stopPropagation()"><select class="action-select" onchange="doLA('${l.id}',this.value);this.value=''"><option value="">Aktion...</option><option value="contacted">‚Üí Kontaktiert</option><option value="offer_sent">‚Üí Angebot</option><option value="won">‚Üí Gewonnen ‚úì</option><option value="bestandskunde">‚Üí Bestandskunde ‚òÖ</option><option value="lost">‚Üí Verloren ‚úó</option><option value="termin">üìÖ Termin vereinbaren</option><option value="angebot">üìÑ Angebot schreiben</option>${l.status==='offer_sent'?'<option value="followup">üìß Follow-Up senden</option>':''}<option value="bewertung">‚≠ê Bewertung anfragen</option><option value="notes">üìù Notizen</option><option value="delete">üóë L√∂schen</option></select></td></tr>`).join('');}
function doLA(id,a){if(!a)return;curLead=id;if(a==='offer_sent'){$('offerAmt').value='';$('mOffer').classList.add('show');}else if(a==='notes'){const l=leads.find(x=>x.id===id);$('notesTxt').value=l?.notes||'';$('mNotes').classList.add('show');}else if(a==='delete')$('mDel').classList.add('show');else if(a==='termin'){const l=leads.find(x=>x.id===id);$('terminEmail').value=l?.email||'';$('terminMsg').value='';$('terminStatus').innerHTML='';$('terminSend').disabled=false;$('terminSend').textContent='üìß E-Mail senden';$('mTermin').classList.add('show');}else if(a==='angebot'){openAngebot(id);}else if(a==='followup'){openFollowUp(id);}else if(a==='bewertung'){openBewertung(id);}else updLS(id,a);}
async function updLS(id,s,x={}){const d={status:s,updated_at:new Date().toISOString(),...x};if(s==='offer_sent'&&!x.offer_sent_at)d.offer_sent_at=new Date().toISOString();else if(s==='won'||s==='lost'||s==='bestandskunde')d.closed_at=new Date().toISOString();await sU('leads',id,d);loadLeads();}
async function confirmOffer(){const a=$('offerAmt').value;await updLS(curLead,'offer_sent',{offer_amount:a?parseFloat(a):null,offer_sent_at:new Date().toISOString()});$('mOffer').classList.remove('show');}
async function saveNotes(){await sU('leads',curLead,{notes:$('notesTxt').value,updated_at:new Date().toISOString()});loadLeads();$('mNotes').classList.remove('show');}
async function confirmDel(){await sD('leads',curLead);loadLeads();$('mDel').classList.remove('show');}
function showLD(id){const l=leads.find(x=>x.id===id);if(!l)return;curLead=id;$('ldTitle').textContent=l.name||'Lead';
$('ldView').style.display='';$('ldEdit').style.display='none';$('ldSaveBtn').style.display='none';$('ldEditBtn').textContent='‚úèÔ∏è Bearbeiten';
$('ldView').innerHTML=`<div class="mf"><div class="ml">Name</div><div class="mv">${esc(l.name||'-')}</div></div><div class="mf"><div class="ml">Telefon</div><div class="mv"><a href="tel:${l.phone}">${esc(l.phone||'-')}</a></div></div>${l.email?`<div class="mf"><div class="ml">E-Mail</div><div class="mv"><a href="mailto:${l.email}">${esc(l.email)}</a></div></div>`:''}${l.company?`<div class="mf"><div class="ml">Firma</div><div class="mv">${esc(l.company)}</div></div>`:''}<div class="mf"><div class="ml">Anfrage</div><div class="mv">${esc(l.service_type||'-')}</div></div>${l.description?`<div class="mf"><div class="ml">Beschreibung</div><div class="mv">${esc(l.description)}</div></div>`:''}<div class="mf"><div class="ml">Status</div><div class="mv"><span class="badge b-${l.status}">${SL[l.status]||l.status}</span></div></div><div class="mf"><div class="ml">Eingegangen</div><div class="mv">${new Date(l.created_at).toLocaleString('de-DE')}</div></div>${l.offer_amount?`<div class="mf"><div class="ml">Angebotssumme</div><div class="mv" style="color:#16a34a;font-weight:600">${parseFloat(l.offer_amount).toLocaleString('de-DE')} ‚Ç¨</div></div>`:''} ${l.notes?`<div class="mf"><div class="ml">Notizen</div><div class="mv">${esc(l.notes)}</div></div>`:''}${l.image_urls&&l.image_urls.length?`<div class="mf"><div class="ml">Bilder</div><div class="mv" style="display:flex;gap:8px;flex-wrap:wrap">${l.image_urls.map(u=>`<a href="${u}" target="_blank"><img src="${u}" style="width:100px;height:100px;object-fit:cover;border-radius:6px"></a>`).join('')}</div></div>`:''}`;
$('ldEdit').innerHTML=`<div class="mf"><label class="il">Name</label><input type="text" class="mi" id="edName" value="${esc(l.name||'')}"></div><div class="mf"><label class="il">Telefon</label><input type="tel" class="mi" id="edPhone" value="${esc(l.phone||'')}"></div><div class="mf"><label class="il">E-Mail</label><input type="email" class="mi" id="edEmail" value="${esc(l.email||'')}"></div><div class="mf"><label class="il">Firma</label><input type="text" class="mi" id="edCompany" value="${esc(l.company||'')}"></div><div class="mf"><label class="il">Anfrage / Leistung</label><input type="text" class="mi" id="edService" value="${esc(l.service_type||'')}"></div><div class="mf"><label class="il">Beschreibung</label><textarea class="mt" id="edDesc">${esc(l.description||'')}</textarea></div><div class="mf"><label class="il">Status</label><select class="mi" id="edStatus" style="padding:10px 14px"><option value="new"${l.status==='new'?' selected':''}>Neu</option><option value="contacted"${l.status==='contacted'?' selected':''}>Kontaktiert</option><option value="offer_sent"${l.status==='offer_sent'?' selected':''}>Angebot gesendet</option><option value="won"${l.status==='won'?' selected':''}>Gewonnen</option><option value="bestandskunde"${l.status==='bestandskunde'?' selected':''}>Bestandskunde</option><option value="lost"${l.status==='lost'?' selected':''}>Verloren</option></select></div><div class="mf"><label class="il">Angebotssumme (‚Ç¨)</label><input type="number" class="mi" id="edOffer" value="${l.offer_amount||''}" step="0.01" placeholder="z.B. 2500"></div><div class="mf"><label class="il">Notizen</label><textarea class="mt" id="edNotes">${esc(l.notes||'')}</textarea></div>`;
$('mLeadDetail').classList.add('show');}
function toggleEdit(){const v=$('ldView'),e=$('ldEdit'),s=$('ldSaveBtn'),b=$('ldEditBtn');if(e.style.display==='none'){v.style.display='none';e.style.display='';s.style.display='';b.textContent='üëÅ Ansicht';}else{v.style.display='';e.style.display='none';s.style.display='none';b.textContent='‚úèÔ∏è Bearbeiten';}}
async function saveEditLead(){const b=$('ldSaveBtn');b.disabled=true;b.textContent='Speichert...';try{const d={name:$('edName').value.trim(),phone:$('edPhone').value.trim(),email:$('edEmail').value.trim()||null,company:$('edCompany').value.trim()||null,service_type:$('edService').value.trim(),description:$('edDesc').value.trim()||null,status:$('edStatus').value,offer_amount:$('edOffer').value?parseFloat($('edOffer').value):null,notes:$('edNotes').value.trim()||null,updated_at:new Date().toISOString()};await sU('leads',curLead,d);$('mLeadDetail').classList.remove('show');loadLeads();}catch(e){alert('Fehler: '+e.message);}b.disabled=false;b.textContent='Speichern';}

// ===== ONBOARDING =====
function buildOF(){$('obFG').innerHTML=[['all','Alle'],['new','Neu'],['in_progress','In Bearb.'],['completed','Fertig']].map(([v,l])=>`<button class="filter-btn${of===v?' active':''}" onclick="of='${v}';buildOF();renderOB()">${l}</button>`).join('');}
async function loadOB(){buildOF();try{obReqs=await sG('onboarding_requests','order=created_at.desc');renderOBK();renderOB();}catch(e){$('obTB').innerHTML=`<tr><td colspan="6" class="empty-state">Fehler: ${e.message}</td></tr>`;}}
function renderOBK(){const t=obReqs.length,n=obReqs.filter(r=>r.status==='new').length,p=obReqs.filter(r=>r.status==='in_progress').length,d=obReqs.filter(r=>r.status==='completed').length;$('obKpi').innerHTML=`<div class="kpi-card hl"><div class="kpi-value">${t}</div><div class="kpi-label">Gesamt</div></div><div class="kpi-card warn"><div class="kpi-value">${n}</div><div class="kpi-label">Neu</div></div><div class="kpi-card"><div class="kpi-value">${p}</div><div class="kpi-label">In Bearbeitung</div></div><div class="kpi-card ok"><div class="kpi-value">${d}</div><div class="kpi-label">Abgeschlossen</div></div>`;}
function renderOB(){const tb=$('obTB');let f=of==='all'?obReqs:obReqs.filter(r=>r.status===of);if(!f.length){tb.innerHTML='<tr><td colspan="6" class="empty-state"><h3>Keine Anfragen</h3></td></tr>';return;}tb.innerHTML=f.map(r=>`<tr class="clickable" onclick="openOBD('${r.id}')"><td><span class="badge b-${r.status}">${OL[r.status]||r.status}</span></td><td style="font-weight:600">${esc(r.company)}</td><td style="color:#64748b">${esc(r.contact_name)}</td><td style="font-size:13px;color:#64748b;font-family:monospace">${esc(r.phone)}</td><td>${(r.services||[]).map(s=>`<span class="svc-tag">${SVL[s]||s}</span>`).join('')}</td><td style="font-size:13px;color:#64748b">${fmtD(r.created_at)}</td></tr>`).join('');}
function openOBD(id){const r=obReqs.find(x=>x.id===id);if(!r)return;curOb=r;$('obSlTitle').textContent=r.company;$('obSlBody').innerHTML=`<div class="dg"><div class="dg-t">Firmendaten</div><div class="dr"><span class="dl">Firma</span><span class="dv">${esc(r.company)}</span></div><div class="dr"><span class="dl">Kontakt</span><span class="dv">${esc(r.contact_name)}${r.position?' ¬∑ '+esc(r.position):''}</span></div><div class="dr"><span class="dl">Telefon</span><span class="dv">${esc(r.phone)}</span></div><div class="dr"><span class="dl">E-Mail</span><span class="dv">${esc(r.email)}</span></div>${r.address?`<div class="dr"><span class="dl">Adresse</span><span class="dv">${esc(r.address)}</span></div>`:''}</div><div class="dg"><div class="dg-t">Leistungen</div><div class="dr"><span class="dl">Bereiche</span><span class="dv">${(r.services||[]).map(s=>`<span class="svc-tag">${SVL[s]||s}</span>`).join('')}</span></div>${r.services_other?`<div class="dr"><span class="dl">Weitere</span><span class="dv">${esc(r.services_other)}</span></div>`:''}</div><div class="dg"><div class="dg-t">Telefonie</div><div class="dr"><span class="dl">Setup</span><span class="dv">${r.phone_setup==='redirect'?'Eigene Nummer (Umleitung)':'Neue Nummer'}</span></div>${r.device?`<div class="dr"><span class="dl">Ger√§t</span><span class="dv">${r.device==='iphone'?'iPhone':'Android'}</span></div>`:''}${r.greeting?`<div class="dr"><span class="dl">Begr√º√üung</span><span class="dv">${esc(r.greeting)}</span></div>`:''}</div>${(r.subdomain||r.notes)?`<div class="dg"><div class="dg-t">Extras</div>${r.subdomain?`<div class="dr"><span class="dl">Subdomain</span><span class="dv">${esc(r.subdomain)}.leadcall24.de</span></div>`:''}${r.notes?`<div class="dr"><span class="dl">Anmerkungen</span><span class="dv">${esc(r.notes)}</span></div>`:''}</div>`:''}<div class="dg"><div class="dg-t">Status</div><div class="dr"><span class="dl">Aktuell</span><span class="dv"><span class="badge b-${r.status}">${OL[r.status]}</span></span></div><div class="dr"><span class="dl">Eingegangen</span><span class="dv">${fmtDT(r.created_at)}</span></div>${r.tenant_id?`<div class="dr"><span class="dl">Tenant ID</span><span class="dv" style="font-family:monospace;font-size:12px">${r.tenant_id}</span></div>`:''}</div>`;let a='';if(r.status==='new')a=`<button class="btn" onclick="updOBS('in_progress')">Bearbeitung starten</button><button class="btn red" onclick="updOBS('rejected')">Ablehnen</button>`;else if(r.status==='in_progress')a=`<button class="btn grn" onclick="startAct()">Als Kunde aktivieren</button><button class="btn sec" onclick="updOBS('new')">Zur√ºck auf Neu</button>`;else if(r.status==='rejected')a=`<button class="btn sec" onclick="updOBS('new')">Reaktivieren</button>`;else a=`<button class="btn sec" onclick="closeOB()">Schlie√üen</button>`;$('obSlAct').innerHTML=a;$('obSlide').classList.add('show');}
function closeOB(){$('obSlide').classList.remove('show');curOb=null;}
async function updOBS(s){if(!curOb)return;await sU('onboarding_requests',curOb.id,{status:s});closeOB();loadOB();}
function startAct(){if(!curOb)return;const s=curOb.company.toLowerCase().replace(/[√§√Ñ]/g,'ae').replace(/[√∂√ñ]/g,'oe').replace(/[√º√ú]/g,'ue').replace(/[√ü]/g,'ss').replace(/[^a-z0-9]/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');$('actUser').value=s;$('mActivate').classList.add('show');}
async function confirmActivate(){if(!curOb)return;const u=$('actUser').value.trim().toLowerCase();if(!u){alert('Benutzername eingeben.');return;}if(/\s/.test(u)){alert('Keine Leerzeichen.');return;}const ex=await sG('tenants',`username=eq.${encodeURIComponent(u)}`);if(ex.length){alert('Benutzername vergeben!');return;}const r=curOb,ts=await sI('tenants',{name:r.company,phone:r.phone,email:r.email,username:u,password:null});if(ts&&ts.length){await sU('onboarding_requests',r.id,{status:'completed',tenant_id:ts[0].id});$('mActivate').classList.remove('show');closeOB();alert(`‚úÖ Kunde aktiviert!\n\nBenutzername: ${u}\n\nDer Kunde erstellt sein Passwort beim ersten Login selbst.`);loadOB();loadTenants();}else alert('Fehler.');}

// ===== TENANTS =====
async function loadTenants(){try{tenants=await sG('tenants','order=created_at.desc');const lds=await sG('leads','select=tenant_id');const c={};lds.forEach(l=>{c[l.tenant_id]=(c[l.tenant_id]||0)+1;});const g=$('tenantGrid');if(!tenants.length){g.innerHTML='<div class="empty-state"><h3>Noch keine Kunden</h3></div>';return;}g.innerHTML=tenants.map(t=>`<div class="tc"><div class="tc-name">${esc(t.name)}</div><div class="tc-email">${esc(t.email||'-')}</div><div class="tc-meta"><span>üìû ${esc(t.phone||'-')}</span><span>üìã ${c[t.id]||0} Leads</span><span>üìÖ ${fmtD(t.created_at)}</span></div><div class="tc-id">ID: ${t.id}</div><div class="tc-login"><h4>Login-Daten</h4><div class="tc-row"><div class="fld"><label>Benutzername</label><input type="text" value="${esc(t.username||'')}" id="u-${t.id}"></div><div class="fld"><label>Passwort</label><input type="text" value="${esc(t.password||'')}" placeholder="${t.password?'':'Wird vom Kunden gesetzt'}" id="p-${t.id}"></div><button onclick="saveTL('${t.id}')">Speichern</button></div><div class="pw-st ${t.password?'set':'notset'}">${t.password?'‚úì Passwort gesetzt':'‚è≥ Wartet auf ersten Login'}</div></div></div>`).join('');}catch(e){$('tenantGrid').innerHTML=`<div class="empty-state">Fehler: ${e.message}</div>`;}}
async function saveTL(id){const u=$(`u-${id}`).value.trim().toLowerCase(),p=$(`p-${id}`).value.trim();if(!u){alert('Benutzername eingeben.');return;}const ex=await sG('tenants',`username=eq.${encodeURIComponent(u)}&id=neq.${id}`);if(ex.length){alert('Benutzername vergeben!');return;}const d={username:u};if(p)d.password=p;await sU('tenants',id,d);alert('Gespeichert!');loadTenants();}

// ===== NEW LEAD =====
function openNewLead(){
    $('nlErr').classList.remove('show');
    $('nlName').value='';$('nlPhone').value='';$('nlEmail').value='';$('nlCompany').value='';
    $('nlCategory').value='';$('nlDesc').value='';
    $('nlSubHMP').style.display='none';$('nlSubGR').style.display='none';
    $('nlFlaeche').style.display='none';$('nlFreq').style.display='none';$('nlHMD').style.display='none';
    $('mNewLead').classList.add('show');
}
function nlCatChange(){
    var c=$('nlCategory').value;
    $('nlSubHMP').style.display=c==='hausmeisterpflege'?'block':'none';
    $('nlSubGR').style.display=c==='gebaeudereinigung'?'block':'none';
    $('nlFlaeche').style.display=(c==='gebaeudereinigung')?'block':'none';
    $('nlFreq').style.display=(c==='hausmeisterpflege'||c==='gebaeudereinigung')?'block':'none';
    $('nlHMD').style.display=c==='hausmeisterdienste'?'block':'none';
}
async function saveNewLead(){
    var nm=$('nlName').value.trim(),ph=$('nlPhone').value.trim(),cat=$('nlCategory').value;
    if(!nm){$('nlErr').textContent='Bitte Name eingeben';$('nlErr').classList.add('show');return;}
    if(!ph){$('nlErr').textContent='Bitte Telefon eingeben';$('nlErr').classList.add('show');return;}
    if(!cat){$('nlErr').textContent='Bitte Kategorie w√§hlen';$('nlErr').classList.add('show');return;}
    var st=cat;
    if(cat==='hausmeisterpflege'){var sub=$('nlSubHMP_sel').value;if(sub)st+=' / '+sub;}
    if(cat==='gebaeudereinigung'){var sub=$('nlSubGR_sel').value;if(sub)st+=' / '+sub;var qm=$('nlQm').value;if(qm)st+=' ('+qm+' m¬≤)';}
    if(cat==='hausmeisterpflege'||cat==='gebaeudereinigung'){
        var fr=$('nlFreq_sel').value;
        if(fr){var fm={'1x_woche':'1√ó/Woche','2x_woche':'2√ó/Woche','3x_woche':'3√ó/Woche','4x_woche':'4√ó/Woche','1x_monat':'1√ó/Monat','einmalig':'Einmalig'};st+=' ‚Äì '+(fm[fr]||fr);}
    }
    if(cat==='hausmeisterdienste'){
        var we=$('nlWE').value,hqm=$('nlHMDqm').value,start=$('nlStart').value;
        if(we)st+=' / '+we+' WE';if(hqm)st+=' ('+hqm+' m¬≤)';
        if(start){var sm={'sofort':'Sofort','1_monat':'Innerhalb 1 Monat','3_monate':'Innerhalb 3 Monate','flexibel':'Flexibel'};st+=' ‚Äì Start: '+(sm[start]||start);}
    }
    var pf=ph.replace(/[\s\-\/\(\)]/g,'');
    if(pf.startsWith('0049'))pf='+49'+pf.substring(4);
    else if(pf.startsWith('49')&&!pf.startsWith('+'))pf='+49'+pf.substring(2);
    else if(pf.startsWith('0'))pf='+49'+pf.substring(1);
    else if(!pf.startsWith('+'))pf='+49'+pf;
    var ld={tenant_id:tid,name:nm,phone:pf,email:$('nlEmail').value.trim()||null,company:$('nlCompany').value.trim()||null,service_type:st,description:$('nlDesc').value.trim()||null,urgency:'flexible',budget:null,privacy_accepted:true,privacy_accepted_at:new Date().toISOString(),form_submitted_at:new Date().toISOString(),status:'new'};
    try{await sI('leads',ld);$('mNewLead').classList.remove('show');loadLeads();}catch(e){$('nlErr').textContent='Fehler: '+e.message;$('nlErr').classList.add('show');}
}

// ===== HELPERS =====
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function timeAgo(d){if(!d)return'-';const s=Math.floor((Date.now()-new Date(d))/1000);if(s<60)return'Gerade eben';if(s<3600)return`vor ${Math.floor(s/60)} Min.`;if(s<86400)return`vor ${Math.floor(s/3600)} Std.`;if(s<604800)return`vor ${Math.floor(s/86400)} Tagen`;return new Date(d).toLocaleDateString('de-DE');}
function fmtD(i){if(!i)return'‚Äì';return new Date(i).toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit'});}
function fmtDT(i){if(!i)return'‚Äì';const d=new Date(i);return d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'2-digit'})+' ¬∑ '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});}
setInterval(()=>{if(sessionStorage.getItem('lc_r'))loadLeads();},30000);

// ===== NEW LEAD =====
function openNewLead(){
    $('nlName').value='';$('nlPhone').value='';$('nlEmail').value='';$('nlCompany').value='';$('nlDesc').value='';$('nlDate').value='';
    document.querySelectorAll('input[name="nl_cat"]').forEach(r=>r.checked=false);
    document.querySelectorAll('input[name="nl_kundenart"]').forEach(r=>r.checked=false);
    document.querySelectorAll('.nl-sub').forEach(el=>el.style.display='none');
    $('nlErr').classList.remove('show');$('nlSave').disabled=false;$('nlSave').textContent='Lead anlegen';
    $('mNewLead').classList.add('show');
}
function nlCatChange(v){
    document.querySelectorAll('.nl-sub').forEach(el=>el.style.display='none');
    if(v==='hausmeisterpflege')$('nlSubHM').style.display='';
    else if(v==='gebaeudereinigung')$('nlSubGR').style.display='';
    else if(v==='hausmeisterdienste')$('nlSubHD').style.display='';
}
async function saveNewLead(){
    const err=$('nlErr');err.classList.remove('show');
    const name=$('nlName').value.trim(),phone=$('nlPhone').value.trim();
    const cat=document.querySelector('input[name="nl_cat"]:checked');
    const kundenart=document.querySelector('input[name="nl_kundenart"]:checked');
    if(!name){err.textContent='Bitte Name eingeben.';err.classList.add('show');return;}
    if(!phone){err.textContent='Bitte Telefonnummer eingeben.';err.classList.add('show');return;}
    if(!kundenart){err.textContent='Bitte Kundenart w√§hlen (Privat/Gewerbe).';err.classList.add('show');return;}
    if(!cat){err.textContent='Bitte Kategorie w√§hlen.';err.classList.add('show');return;}
    let svc=(kundenart.value==='gewerbe'?'Gewerbe':'Privat')+' ‚Äì '+cat.value;
    const freqMap={'1x_woche':'1√ó/Woche','2x_woche':'2√ó/Woche','3x_woche':'3√ó/Woche','4x_woche':'4√ó/Woche','1x_monat':'1√ó/Monat','einmalig':'Einmalig'};
    const startMap={'sofort':'Sofort','1_monat':'Innerhalb 1 Monat','3_monate':'Innerhalb 3 Monate','flexibel':'Flexibel'};
    if(cat.value==='hausmeisterpflege'){
        const sub=$('nlSubHMSel').value;if(sub)svc+=' / '+sub;
        const fr=$('nlFreqHM').value;if(fr)svc+=' ‚Äì '+(freqMap[fr]||fr);
    }else if(cat.value==='gebaeudereinigung'){
        const sub=$('nlSubGRSel').value;if(sub)svc+=' / '+sub;
        const fl=$('nlFlaeche').value;if(fl)svc+=' ('+fl+' m¬≤)';
        const fr=$('nlFreqGR').value;if(fr)svc+=' ‚Äì '+(freqMap[fr]||fr);
    }else if(cat.value==='hausmeisterdienste'){
        const we=$('nlWE').value;if(we)svc+=' / '+we+' WE';
        const fl=$('nlFlaecheHD').value;if(fl)svc+=' ('+fl+' m¬≤)';
        const st=$('nlStart').value;if(st)svc+=' ‚Äì Start: '+(startMap[st]||st);
    }
    let fPhone=phone.replace(/[\s\-\/\(\)]/g,'');
    if(fPhone.startsWith('0049'))fPhone='+49'+fPhone.substring(4);
    else if(fPhone.startsWith('49')&&!fPhone.startsWith('+'))fPhone='+49'+fPhone.substring(2);
    else if(fPhone.startsWith('0'))fPhone='+49'+fPhone.substring(1);
    else if(!fPhone.startsWith('+'))fPhone='+49'+fPhone;
    const b=$('nlSave');b.disabled=true;b.textContent='Wird gespeichert...';
    try{
        const tID=isAdmin?null:tid;
        const customDate=$('nlDate').value;
        const createdAt=customDate?new Date(customDate+'T12:00:00').toISOString():new Date().toISOString();
        const d={tenant_id:tID||tid,name:name,phone:fPhone,email:$('nlEmail').value.trim()||null,company:$('nlCompany').value.trim()||null,service_type:svc,description:$('nlDesc').value.trim()||null,status:'new',privacy_accepted:true,privacy_accepted_at:new Date().toISOString(),created_at:createdAt};
        await sI('leads',d);
        $('mNewLead').classList.remove('show');loadLeads();
    }catch(e){err.textContent='Fehler: '+e.message;err.classList.add('show');}
    b.disabled=false;b.textContent='Lead anlegen';
}

// ===== ANGEBOT =====
let angRowCount=0;
function openAngebot(id){
    const l=leads.find(x=>x.id===id);
    $('angName').value=l?.name||'';
    $('angFirma').value=l?.company||'';
    $('angEmail').value=l?.email||'';
    $('angPhone').value=l?.phone||'';
    $('angAddr').value='';
    const today=new Date().toISOString().split('T')[0];
    const in30=new Date(Date.now()+30*864e5).toISOString().split('T')[0];
    $('angDatum').value=today;
    $('angGueltig').value=in30;
    $('angNr').value='ANG-'+Date.now().toString(36).toUpperCase();
    $('angBetreff').value=l?.service_type||'';
    $('angNotes').value='Zahlbar innerhalb von 14 Tagen nach Rechnungsstellung.\nDieses Angebot ist freibleibend.';
    angRowCount=0;
    $('angRows').innerHTML='';
    addAngRow();
    calcAng();
    $('angSlide').classList.add('show');
}
function closeAng(){$('angSlide').classList.remove('show');}
function addAngRow(){
    angRowCount++;
    const tr=document.createElement('tr');
    tr.id='angR'+angRowCount;
    tr.innerHTML='<td style="padding:6px"><span class="ang-pos">'+angRowCount+'</span></td><td style="padding:6px"><input style="width:100%;padding:6px;border:1px solid #e2e8f0;border-radius:4px;font-size:13px" class="ang-desc" placeholder="Beschreibung"></td><td style="padding:6px"><input type="number" style="width:100%;padding:6px;border:1px solid #e2e8f0;border-radius:4px;font-size:13px;text-align:right" class="ang-qty" value="1" min="0" step="any" oninput="calcAng()"></td><td style="padding:6px"><select style="padding:6px;border:1px solid #e2e8f0;border-radius:4px;font-size:12px" class="ang-unit"><option>Stk.</option><option>Std.</option><option>m¬≤</option><option>pauschal</option><option>Monat</option></select></td><td style="padding:6px"><input type="number" style="width:100%;padding:6px;border:1px solid #e2e8f0;border-radius:4px;font-size:13px;text-align:right" class="ang-price" value="0" min="0" step="0.01" oninput="calcAng()"></td><td style="padding:6px;text-align:right;font-weight:600" class="ang-total">0,00</td><td style="padding:6px"><button onclick="this.closest(\'tr\').remove();reNumAng();calcAng()" style="background:none;border:none;cursor:pointer;color:#dc2626;font-size:16px">‚úï</button></td>';
    $('angRows').appendChild(tr);
}
function reNumAng(){document.querySelectorAll('#angRows tr').forEach((tr,i)=>{tr.querySelector('.ang-pos').textContent=i+1;});}
function calcAng(){
    let total=0;
    document.querySelectorAll('#angRows tr').forEach(tr=>{
        const q=parseFloat(tr.querySelector('.ang-qty').value)||0;
        const p=parseFloat(tr.querySelector('.ang-price').value)||0;
        const t=q*p;total+=t;
        tr.querySelector('.ang-total').textContent=t.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
    });
    const mwst=total*0.19;
    $('angNetto').textContent=total.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+' \u20ac';
    $('angMwst').textContent=mwst.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+' \u20ac';
    $('angBrutto').textContent=(total+mwst).toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2})+' \u20ac';
}
async function genAngPDF(mode){
    const{jsPDF}=window.jspdf;
    const doc=new jsPDF();
    const blue=[37,99,235];
    const gray=[100,116,139];
    const dark=[30,41,59];
    // Header
    doc.setFontSize(20);doc.setTextColor(...blue);doc.setFont('helvetica','bold');
    doc.text('Hausmeisterservice Sykora',14,22);
    doc.setFontSize(9);doc.setTextColor(...gray);doc.setFont('helvetica','normal');
    doc.text('Markus Sykora \u00b7 Rosenheimer Str. 18 \u00b7 85560 Ebersberg',14,28);
    doc.text('Tel.: 08092 2504830 \u00b7 E-Mail: m.sykora@hausmeisterservicesykora.de',14,33);
    doc.setDrawColor(226,232,240);doc.line(14,37,196,37);
    // Angebot title
    doc.setFontSize(16);doc.setTextColor(...dark);doc.setFont('helvetica','bold');
    doc.text('ANGEBOT',14,48);
    doc.setFontSize(10);doc.setFont('helvetica','normal');
    doc.setTextColor(...gray);
    doc.text('Nr.: '+$('angNr').value,14,54);
    doc.text('Datum: '+formatDateDE($('angDatum').value),14,59);
    doc.text('G\u00fcltig bis: '+formatDateDE($('angGueltig').value),14,64);
    // Kunde
    doc.setFontSize(10);doc.setTextColor(...dark);doc.setFont('helvetica','bold');
    doc.text('Kunde:',120,48);doc.setFont('helvetica','normal');
    let ky=53;
    if($('angFirma').value){doc.text($('angFirma').value,120,ky);ky+=5;}
    if($('angName').value){doc.text($('angName').value,120,ky);ky+=5;}
    if($('angAddr').value){doc.text($('angAddr').value,120,ky);ky+=5;}
    if($('angPhone').value){doc.text('Tel.: '+$('angPhone').value,120,ky);ky+=5;}
    if($('angEmail').value){doc.text($('angEmail').value,120,ky);ky+=5;}
    // Betreff
    if($('angBetreff').value){doc.setFont('helvetica','bold');doc.setTextColor(...dark);doc.text('Betr.: '+$('angBetreff').value,14,78);doc.setFont('helvetica','normal');}
    // Table
    const rows=[];
    document.querySelectorAll('#angRows tr').forEach((tr,i)=>{
        const desc=tr.querySelector('.ang-desc').value||'';
        const qty=tr.querySelector('.ang-qty').value||'0';
        const unit=tr.querySelector('.ang-unit').value||'';
        const price=parseFloat(tr.querySelector('.ang-price').value)||0;
        const total=parseFloat(qty)*price;
        rows.push([(i+1).toString(),desc,qty,unit,price.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac',total.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac']);
    });
    doc.autoTable({startY:84,head:[['Pos','Beschreibung','Menge','Einheit','Einzelpreis','Gesamt']],body:rows,styles:{fontSize:9,cellPadding:4},headStyles:{fillColor:blue,textColor:[255,255,255],fontStyle:'bold'},columnStyles:{0:{cellWidth:15},2:{halign:'right',cellWidth:18},3:{cellWidth:20},4:{halign:'right',cellWidth:28},5:{halign:'right',cellWidth:28}},alternateRowStyles:{fillColor:[248,250,252]}});
    // Totals
    let ty=doc.lastAutoTable.finalY+10;
    let netto=0;
    document.querySelectorAll('#angRows tr').forEach(tr=>{const q=parseFloat(tr.querySelector('.ang-qty').value)||0;const p=parseFloat(tr.querySelector('.ang-price').value)||0;netto+=q*p;});
    const mwst=netto*0.19;const brutto=netto+mwst;
    doc.setFontSize(10);doc.setTextColor(...dark);
    doc.text('Netto:',150,ty,{align:'right'});doc.text(netto.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac',192,ty,{align:'right'});ty+=6;
    doc.text('MwSt. (19%):',150,ty,{align:'right'});doc.text(mwst.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac',192,ty,{align:'right'});ty+=6;
    doc.setDrawColor(226,232,240);doc.line(130,ty-2,196,ty-2);ty+=2;
    doc.setFont('helvetica','bold');doc.setFontSize(12);
    doc.text('Brutto:',150,ty,{align:'right'});doc.text(brutto.toLocaleString('de-DE',{minimumFractionDigits:2})+' \u20ac',192,ty,{align:'right'});
    // Notes
    if($('angNotes').value){ty+=14;doc.setFontSize(9);doc.setFont('helvetica','normal');doc.setTextColor(...gray);const lines=doc.splitTextToSize($('angNotes').value,170);doc.text(lines,14,ty);}
    // Footer
    doc.setFontSize(7);doc.setTextColor(...gray);doc.setFont('helvetica','normal');
    doc.text('Hausmeisterservice Sykora \u00b7 Markus Sykora \u00b7 Rosenheimer Str. 18 \u00b7 85560 Ebersberg \u00b7 m.sykora@hausmeisterservicesykora.de',105,287,{align:'center'});
    if(mode==='download'){
        doc.save('Angebot_'+$('angNr').value+'.pdf');
        if(curLead){await sU('leads',curLead,{offer_amount:netto,offer_sent_at:new Date().toISOString(),status:'offer_sent',updated_at:new Date().toISOString()});loadLeads();}
    }else if(mode==='send'){
        const email=$('angEmail').value.trim();
        if(!email){alert('Bitte E-Mail-Adresse des Kunden eingeben.');return;}
        try{
            const blob=doc.output('blob');
            const fname='Angebot_'+$('angNr').value+'_'+Date.now()+'.pdf';
            const res=await fetch(SB+'/storage/v1/object/angebote/'+fname,{method:'POST',headers:{'apikey':SK,'Authorization':'Bearer '+SK,'Content-Type':'application/pdf'},body:blob});
            if(!res.ok)throw new Error('Upload fehlgeschlagen');
            const pdfUrl=SB+'/storage/v1/object/public/angebote/'+fname;
            emailjs.init('fc6zzeTCmrKyrkxJ2');
            await emailjs.send('service_te0rxxz','template_oyi750j',{
                to_email:email,
                kunde_name:$('angName').value||'',
                firma_name:'Hausmeisterservice Sykora',
                nachricht:'Im Anhang finden Sie unser Angebot '+$('angNr').value+'. Sie k\u00f6nnen das Angebot hier herunterladen:\n\n'+pdfUrl+'\n\nBei Fragen stehen wir Ihnen gerne zur Verf\u00fcgung.',
                booking_link:pdfUrl
            });
            alert('\u2705 Angebot wurde per E-Mail an '+email+' gesendet!');
            if(curLead){await sU('leads',curLead,{offer_amount:netto,offer_sent_at:new Date().toISOString(),status:'offer_sent',updated_at:new Date().toISOString()});loadLeads();}
            closeAng();
        }catch(e){alert('Fehler: '+e.message);}
    }
}
function formatDateDE(d){if(!d)return'-';const p=d.split('-');return p[2]+'.'+p[1]+'.'+p[0];}

// ===== ANGEBOT =====
let angPositionen=[];
let angLeadId=null;
function openAngebot(id){
    const l=leads.find(x=>x.id===id);angLeadId=id;
    $('angKunde').value=l?(l.company||l.name||''):'';
    $('angAnsprech').value=l?l.name||'':'';
    $('angKEmail').value=l?l.email||'':'';
    $('angKAdresse').value='';
    $('angAnrede').value=l?'Sehr geehrte/r '+l.name+',':'';
    $('angObjekt').value='';
    var svcType=(l&&l.service_type)?l.service_type.split(' / ')[0].split(' ‚Äì ').pop().trim():'Hausmeistert√§tigkeiten';
    var typMap={'hausmeisterpflege':'Gr√ºnfl√§chenpflege','gebaeudereinigung':'Geb√§udereinigung','hausmeisterdienste':'Hausmeistert√§tigkeiten','winterdienst':'Winterdienst'};
    $('angTyp').value=typMap[svcType]||'Hausmeistert√§tigkeiten';
    $('angBetreff').value=l?'Angebot '+(typMap[svcType]||svcType):'';
    const now=new Date();
    $('angNr').value='ANG-'+now.getFullYear()+'-'+(Math.floor(Math.random()*9000)+1000);
    $('angDatum').value=now.toISOString().split('T')[0];
    const bis=new Date(now.getTime()+14*864e5);
    $('angGueltig').value=bis.toISOString().split('T')[0];
    angPositionen=[{pos:1,desc:'',menge:1,einheit:'mtl.',preis:0}];
    renderAngPos();
    $('angStatus').className='ang-status';$('angStatus').textContent='';
    $('angOverlay').classList.add('show');
}
function closeAngebot(){$('angOverlay').classList.remove('show');}
function addAngPos(){angPositionen.push({pos:angPositionen.length+1,desc:'',menge:1,einheit:'Stk.',preis:0});renderAngPos();}
function delAngPos(i){angPositionen.splice(i,1);angPositionen.forEach((p,j)=>p.pos=j+1);renderAngPos();}
function renderAngPos(){
    const tb=$('angPosTB');
    tb.innerHTML=angPositionen.map((p,i)=>'<tr><td class="col-pos"><input value="'+p.pos+'" readonly style="background:#f8fafc;text-align:center"></td><td class="col-desc"><input value="'+esc(p.desc)+'" oninput="angPositionen['+i+'].desc=this.value" placeholder="Beschreibung..."></td><td class="col-num"><input type="number" value="'+p.menge+'" min="0" step="0.01" oninput="angPositionen['+i+'].menge=parseFloat(this.value)||0;calcAngTotals()"></td><td class="col-num"><input value="'+esc(p.einheit)+'" oninput="angPositionen['+i+'].einheit=this.value"></td><td class="col-price"><input type="number" value="'+p.preis+'" min="0" step="0.01" oninput="angPositionen['+i+'].preis=parseFloat(this.value)||0;calcAngTotals()"></td><td class="col-total">'+((p.menge*p.preis).toFixed(2).replace('.',','))+' \u20ac</td><td class="col-del">'+(angPositionen.length>1?'<button class="ang-del" onclick="delAngPos('+i+')">\u2715</button>':'')+'</td></tr>').join('');
    calcAngTotals();
}
function calcAngTotals(){
    const netto=angPositionen.reduce((s,p)=>s+p.menge*p.preis,0);
    const mwst=parseFloat($('angMwst').value)||19;
    const steuer=netto*mwst/100;
    const brutto=netto+steuer;
    $('angTotals').innerHTML='<div>Netto: '+netto.toFixed(2).replace('.',',')+' \u20ac</div><div>MwSt. ('+mwst+'%): '+steuer.toFixed(2).replace('.',',')+' \u20ac</div><div class="ang-brutto">Brutto: '+brutto.toFixed(2).replace('.',',')+' \u20ac</div>';
}
function buildAngPDF(){
    const{jsPDF}=window.jspdf;const doc=new jsPDF();const w=doc.internal.pageSize.getWidth();const h=doc.internal.pageSize.getHeight();
    const firma=$('angFirma').value,inhaber=$('angInhaber').value,adresse=$('angAdresse').value,tel=$('angTel').value,email=$('angEmail').value,steuer=$('angSteuer').value;
    const kunde=$('angKunde').value,ansprech=$('angAnsprech').value,kadresse=$('angKAdresse').value,kemail=$('angKEmail').value;
    const anrede=$('angAnrede').value||'Sehr geehrte Damen und Herren,';
    const objekt=$('angObjekt').value;
    const nr=$('angNr').value,datum=$('angDatum').value,gueltig=$('angGueltig').value,betreff=$('angBetreff').value;
    const angTyp=$('angTyp').value;
    const zahlung=$('angZahlung').value,ausfuehrung=$('angAusfuehrung').value,auftragsbed=$('angAuftragsbed').value,zusatz=$('angZusatz').value;
    const mwstRate=parseFloat($('angMwst').value)||19;
    var netto=angPositionen.reduce(function(s,p){return s+p.menge*p.preis},0);
    var mwstBetrag=netto*mwstRate/100;
    var brutto=netto+mwstBetrag;
    var datumStr=datum?new Date(datum).toLocaleDateString('de-DE',{day:'2-digit',month:'long',year:'numeric'}):'';
    var gueltigTage=14;if(gueltig&&datum){gueltigTage=Math.round((new Date(gueltig)-new Date(datum))/(864e5*7))+'Wochen';}
    const LOGO='data:image/png;base64,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';
    function addLogo(d){try{d.addImage(LOGO,'PNG',w/2-35,12,70,18);}catch(e){d.setFontSize(14);d.setTextColor(30,80,30);d.text('Hausmeisterservice Sykora',w/2,22,{align:'center'});}}
    function addFooter(d){
        var pw=d.internal.pageSize.getWidth();var ph=d.internal.pageSize.getHeight();
        var fy=ph-22;var fs=6.5;var c1=15,c2=65,c3=120,c4=160;
        d.setDrawColor(180);d.line(c1,fy-3,pw-c1,fy-3);
        d.setFontSize(fs);d.setTextColor(100);
        d.text('Hausmeisterservice Sykora',c1,fy);d.text('Tel: 08092/25048-30',c2,fy);d.text('Ust-ID Nr.: DE322138547',c3,fy);d.text('Bankverbindung',c4,fy);
        fy+=3.5;
        d.text('Rosenheimer Str.18',c1,fy);d.text('E-Mail: info@hausmeisterservicesykora.de',c2,fy);d.text('Gerichtsstand: Ebersberg',c3,fy);d.text('IBAN: DE77 1101 0101 5729 4171 12',c4,fy);
        fy+=3.5;
        d.text('85560 Ebersberg',c1,fy);d.text('Web: www.hausmeisterservicesykora.de',c2,fy);d.text('Inhaber/-in: Markus Sykora',c3,fy);d.text('BIC: SOBKDEB2XXX',c4,fy);
        fy+=3.5;
        d.text('',c1,fy);d.text('',c2,fy);d.text('',c3,fy);d.text('Bank: Solarisbank',c4,fy);
    }

    // === SEITE 1: DECKBLATT ===
    addLogo(doc);
    doc.setFontSize(28);doc.setTextColor(30);doc.setFont(undefined,'bold');
    doc.text('Angebot',w/2,80,{align:'center'});
    doc.setFontSize(18);
    doc.text(angTyp||'Hausmeistert\u00e4tigkeiten',w/2,95,{align:'center'});
    doc.setFont(undefined,'normal');
    doc.setFontSize(14);doc.setTextColor(30);doc.setFont(undefined,'bold');
    doc.text('Kunde:',w/2,130,{align:'center'});doc.setFont(undefined,'normal');
    doc.setFontSize(12);doc.setTextColor(60);
    if(kunde)doc.text(kunde,w/2,140,{align:'center'});
    if(kadresse)doc.text(kadresse,w/2,148,{align:'center'});
    if(objekt){doc.setFont(undefined,'bold');doc.setFontSize(14);doc.setTextColor(30);doc.text('Objekt:',w/2,168,{align:'center'});doc.setFont(undefined,'normal');doc.setFontSize(12);doc.setTextColor(60);doc.text(objekt,w/2,178,{align:'center'});}
    doc.setFont(undefined,'bold');doc.setFontSize(14);doc.setTextColor(30);
    doc.text('Datum:',w/2,objekt?200:180,{align:'center'});doc.setFont(undefined,'bold');doc.setFontSize(12);doc.setTextColor(60);doc.text(datumStr,w/2,objekt?210:190,{align:'center'});

    // === SEITE 2: ANSCHREIBEN ===
    doc.addPage();addLogo(doc);
    doc.setFontSize(9);doc.setTextColor(80);
    doc.text(adresse.split(',')[0]||'',20,52);
    doc.text((adresse.split(',')[1]||'').trim(),20,58);
    doc.text('24h-Service '+tel,w-20,48,{align:'right'});
    doc.setFontSize(7);doc.setTextColor(120);
    doc.text('(kostenlos aus dem Festnetz, jederzeit erreichbar)',w-20,53,{align:'right'});
    doc.setFontSize(10);doc.setTextColor(60);
    doc.text('Ebersberg, '+datumStr,w-20,72,{align:'right'});
    var y=88;
    doc.setFontSize(12);doc.setTextColor(30);doc.setFont(undefined,'bold');
    doc.text('Angebot: '+angTyp,20,y);doc.setFont(undefined,'normal');doc.setDrawColor(30);doc.line(20,y+1,20+doc.getTextWidth('Angebot: '+angTyp),y+1);
    y+=14;doc.setFontSize(10);doc.setTextColor(30);
    doc.text(anrede,20,y);
    y+=10;doc.setTextColor(60);
    var intro='herzlichen Dank f\u00fcr Ihr Interesse an unseren T\u00e4tigkeiten.\n\nHiermit \u00fcberreiche ich Ihnen wie gew\u00fcnscht das Angebot f\u00fcr die '+angTyp+' Ihrer R\u00e4umlichkeiten.\n\nFalls Ihnen das Angebot zusagt, k\u00f6nnen Sie gerne das Feld \"Auftrag erteilen\" unterschreiben und uns eine Kopie des Dokuments zusenden.\n\nHaben Sie Fragen oder d\u00fcrfen wir das Angebot f\u00fcr Sie anpassen?';
    var introLines=doc.splitTextToSize(intro,w-40);doc.text(introLines,20,y);y+=introLines.length*5+6;
    doc.setFontSize(10);doc.setTextColor(30);doc.setFont(undefined,'bolditalic');
    doc.text('Dann kontaktieren Sie mich gerne jederzeit \u00fcber folgende Wege:',20,y);
    doc.setFont(undefined,'normal');y+=10;doc.setTextColor(60);
    doc.text('Telefon: '+tel,20,y);y+=6;
    doc.text('E-Mail: '+email,20,y);y+=10;
    doc.text('Gerne k\u00f6nnen Sie sich auch auf unserer Webseite weitere Informationen zu',20,y);y+=5;
    doc.text('unserem Unternehmen einholen.',20,y);y+=6;
    doc.setTextColor(30);doc.setFont(undefined,'bold');doc.text('Besuchen Sie daf\u00fcr: www.hausmeisterservicesykora.de',20,y);doc.setFont(undefined,'normal');
    y+=14;doc.setTextColor(60);
    var outro='Unser oberstes Ziel ist Ihre Zufriedenheit. Aus diesem Grund sind wir davon \u00fcberzeugt, Ihr bester Partner zu sein, wenn es um das Thema '+angTyp+' geht.\nWir freuen uns \u00fcber eine langanhaltende Zusammenarbeit mit Ihnen!';
    var outroLines=doc.splitTextToSize(outro,w-40);doc.text(outroLines,20,y);y+=outroLines.length*5+10;
    doc.setTextColor(60);doc.text('Gl\u00e4nzende Gr\u00fc\u00dfe',20,y);y+=8;
    doc.setTextColor(30);doc.setFont(undefined,'bold');doc.text(inhaber,20,y);doc.setFont(undefined,'normal');

    // === SEITE 3: ANGEBOTSDETAILS ===
    doc.addPage();addLogo(doc);
    y=42;doc.setFontSize(12);doc.setTextColor(30);doc.setFont(undefined,'bold');
    doc.text('Angebot: '+angTyp,20,y);doc.setFont(undefined,'normal');
    y+=10;doc.setFontSize(10);doc.setTextColor(60);
    var desc1='Wir sind f\u00fcr Sie da, damit Sie sich nie wieder Gedanken um die Sauberkeit in Ihrem Haus machen m\u00fcssen. Stattdessen k\u00f6nnen Sie sich auf das Wesentliche konzentrieren, w\u00e4hrend wir daf\u00fcr sorgen, dass Sie, Ihre Mitarbeiter, Mieter und Ihre Kunden sich in Ihren R\u00e4umlichkeiten wohlf\u00fchlen.';
    var d1Lines=doc.splitTextToSize(desc1,w-40);doc.text(d1Lines,20,y);y+=d1Lines.length*5+4;

    // Positionen
    if(angPositionen.length>1||angPositionen[0].desc){
        doc.setDrawColor(180);doc.rect(18,y-2,w-36,8+angPositionen.length*7);
        doc.setFontSize(9);doc.setTextColor(30);doc.setFont(undefined,'bold');
        var desc2='Gem\u00e4\u00df dem beigef\u00fcgten Leistungsverzeichnis bieten wir Ihnen folgende Leistungen an:';
        doc.text(desc2,20,y+4);doc.setFont(undefined,'normal');y+=12;
        doc.setFontSize(8);doc.setTextColor(100);doc.setFont(undefined,'bold');
        doc.text('Pos.',22,y);doc.text('Beschreibung',38,y);doc.text('Menge',120,y);doc.text('Einheit',138,y);doc.text('Einzelpreis',156,y);doc.text('Gesamt',178,y);
        doc.setFont(undefined,'normal');doc.line(20,y+2,w-20,y+2);y+=6;
        doc.setFontSize(9);doc.setTextColor(30);
        angPositionen.forEach(function(p){
            var total=p.menge*p.preis;
            doc.text(String(p.pos),24,y);
            var descL=doc.splitTextToSize(p.desc||'',78);doc.text(descL,38,y);
            doc.text(String(p.menge),124,y);doc.text(p.einheit,138,y);
            doc.text(p.preis.toFixed(2).replace('.',',')+' \u20ac',156,y);
            doc.text(total.toFixed(2).replace('.',',')+' \u20ac',178,y);
            y+=Math.max(descL.length*5,7);
        });
        y+=4;
    }

    // Pauschalbetrag
    doc.setFontSize(10);doc.setTextColor(60);
    var pausch='Monatlicher Pauschalbetrag:';
    doc.text(pausch,w/2,y+4,{align:'center'});
    y+=12;doc.setFontSize(14);doc.setTextColor(30);doc.setFont(undefined,'bolditalic');
    doc.text(netto.toFixed(2).replace('.',',')+' \u20ac zzgl.',w/2-12,y,{align:'center'});doc.setFontSize(10);doc.text(' gesetzlicher MwSt.',w/2+25,y);
    doc.setFont(undefined,'normal');

    // Zusatz
    if(zusatz){y+=10;doc.setFontSize(9);doc.setTextColor(80);var zLines=doc.splitTextToSize(zusatz,w-40);doc.text(zLines,20,y);y+=zLines.length*4.5;}

    // Bedingungen Box
    y+=8;doc.setDrawColor(30);doc.rect(18,y-2,w-36,46);y+=4;
    doc.setFontSize(9);doc.setTextColor(30);
    doc.setFont(undefined,'bold');doc.text('Ausf\u00fchrungszeitraum: ',22,y);doc.setFont(undefined,'normal');doc.text(ausfuehrung,22+doc.getTextWidth('Ausf\u00fchrungszeitraum: '),y);y+=10;
    doc.setFont(undefined,'bold');doc.text('Zahlungsbedingungen: ',22,y);doc.setFont(undefined,'normal');doc.text(zahlung,22+doc.getTextWidth('Zahlungsbedingungen: '),y);y+=10;
    doc.setFont(undefined,'bold');doc.text('Auftragsbedingungen: ',22,y);doc.setFont(undefined,'normal');doc.text(auftragsbed,22+doc.getTextWidth('Auftragsbedingungen: '),y);y+=10;
    doc.setFont(undefined,'bold');doc.text('G\u00fcltigkeit des Angebots: ',22,y);doc.setFont(undefined,'normal');doc.text(gueltig?Math.round((new Date(gueltig)-new Date(datum))/(864e5*7))+' Wochen':'2 Wochen',22+doc.getTextWidth('G\u00fcltigkeit des Angebots: '),y);

    // Wir freuen uns
    y+=16;doc.setFontSize(10);doc.setTextColor(60);doc.text('Wir freuen uns auf die Zusammenarbeit!',20,y);

    // Unterschrift
    y+=16;doc.setFontSize(10);doc.setTextColor(30);doc.text('Ebersberg, '+datumStr,20,y);
    doc.text('Bitte unterschrieben uns zusenden.',w/2+10,y);
    y+=10;doc.setDrawColor(180);doc.rect(w/2+10,y-2,70,30);
    doc.setFont(undefined,'bold');doc.text('Auftrag erteilen',w/2+14,y+4);doc.setFont(undefined,'normal');
    y+=20;doc.setTextColor(120);doc.setFontSize(8);
    doc.text('.........................................................................',w/2+14,y);y+=4;
    doc.text('Datum, Unterschrift und ggf. Stempel Auftraggeber',w/2+14,y);

    // Fu\u00dfzeile auf alle Seiten
    var totalPages=doc.internal.getNumberOfPages();
    for(var i=1;i<=totalPages;i++){doc.setPage(i);addFooter(doc);}

    return doc;
}

function previewPDF(){var doc=buildAngPDF();window.open(doc.output('bloburl'),'_blank');}
function downloadPDF(){var doc=buildAngPDF();doc.save(($('angNr').value||'Angebot')+'.pdf');}
async function sendAngebot(){
    var kemail=$('angKEmail').value.trim();
    var st=$('angStatus');
    if(!kemail){st.className='ang-status show err';st.textContent='Bitte E-Mail-Adresse des Kunden eintragen.';return;}
    var b=$('angSendBtn');b.disabled=true;b.textContent='Wird gesendet...';st.className='ang-status';st.textContent='';
    try{
        var doc=buildAngPDF();
        var blob=doc.output('blob');
        var filename=($('angNr').value||'Angebot')+'.pdf';
        var formData=new FormData();formData.append('',blob,filename);
        var upRes=await fetch(SB+'/storage/v1/object/angebote/'+encodeURIComponent(filename),{method:'POST',headers:{'Authorization':'Bearer '+SK},body:blob});
        if(!upRes.ok){var upBody=await upRes.json();if(upBody.error==='Duplicate'){await fetch(SB+'/storage/v1/object/angebote/'+encodeURIComponent(filename),{method:'PUT',headers:{'Authorization':'Bearer '+SK},body:blob});}}
        var pdfUrl=SB+'/storage/v1/object/public/angebote/'+encodeURIComponent(filename);
        emailjs.init('fc6zzeTCmrKyrkxJ2');
        await emailjs.send('service_te0rxxz','template_oyi750j',{
            to_email:kemail,
            kunde_name:$('angAnsprech').value||$('angKunde').value,
            firma_name:$('angFirma').value,
            nachricht:'Anbei erhalten Sie unser Angebot '+($('angNr').value)+'. Sie k\u00f6nnen es hier herunterladen:',
            booking_link:pdfUrl
        });
        if(angLeadId){
            var netto=angPositionen.reduce(function(s,p){return s+p.menge*p.preis},0);
            await sU('leads',angLeadId,{status:'offer_sent',offer_amount:netto,offer_sent_at:new Date().toISOString(),updated_at:new Date().toISOString()});
        }
        st.className='ang-status show ok';st.textContent='\u2713 Angebot erfolgreich an '+kemail+' gesendet!';
        setTimeout(function(){closeAngebot();loadLeads();},2000);
    }catch(e){st.className='ang-status show err';st.textContent='Fehler: '+e.message;}
    b.disabled=false;b.textContent='\ud83d\udce7 Per E-Mail senden';
}

// ===== TERMIN =====
const BOOKING_LINK = 'https://calendar.app.google/h2duMnoPvg3dCjPNA';
async function sendTermin(){
    const email=$('terminEmail').value.trim();
    const msg=$('terminMsg').value.trim();
    const st=$('terminStatus');
    if(!email){st.innerHTML='<span style="color:#dc2626">Bitte E-Mail eingeben.</span>';return;}
    const l=leads.find(x=>x.id===curLead);
    const b=$('terminSend');b.disabled=true;b.textContent='Wird gesendet...';
    try{
        emailjs.init('fc6zzeTCmrKyrkxJ2');
        await emailjs.send('service_te0rxxz','template_oyi750j',{
            to_email:email,
            kunde_name:l?.name||'',
            firma_name:tname||'Hausmeisterservice Sykora',
            nachricht:msg||'Gerne m√∂chten wir mit Ihnen einen Termin vereinbaren.',
            booking_link:BOOKING_LINK
        });
        st.innerHTML='<span style="color:#16a34a">‚úì E-Mail erfolgreich gesendet!</span>';
        if(curLead){await sU('leads',curLead,{status:'contacted',notes:(l?.notes?l.notes+'\n':'')+'['+new Date().toLocaleDateString('de-DE')+'] Termineinladung gesendet an '+email,updated_at:new Date().toISOString()});}
        setTimeout(()=>{$('mTermin').classList.remove('show');loadLeads();},1500);
    }catch(e){st.innerHTML='<span style="color:#dc2626">Fehler: '+e.message+'</span>';}
    b.disabled=false;b.textContent='üìß E-Mail senden';
}

// ===== BEWERTUNG =====
const GOOGLE_REVIEW_URL = 'https://search.google.com/local/writereview?placeid=ChIJZbNrxJk8fAURDeLejnl34FE';

function openBewertung(id){
    curLead=id;
    const l=leads.find(x=>x.id===id);
    $('bewEmail').value=l?.email||'';
    var name=l?.name||'';
    var anrede=name?('Sehr geehrte/r '+name+','):'Sehr geehrte Damen und Herren,';
    $('bewMsg').value=anrede+'\n\nvielen Dank, dass Sie sich f\u00fcr den Hausmeisterservice Sykora entschieden haben!\n\nWir hoffen, dass Sie mit unserer Arbeit zufrieden sind. Ihre Meinung ist uns sehr wichtig und hilft uns, unseren Service stetig zu verbessern.\n\nWir w\u00fcrden uns sehr freuen, wenn Sie sich einen kurzen Moment Zeit nehmen und uns eine Google-Bewertung hinterlassen:\n\n'+GOOGLE_REVIEW_URL+'\n\nVielen Dank f\u00fcr Ihr Vertrauen!\n\nGl\u00e4nzende Gr\u00fc\u00dfe\n'+(tname||'Hausmeisterservice Sykora');
    $('bewStatus').innerHTML='';
    $('bewSend').disabled=false;
    $('bewSend').textContent='\u2b50 Bewertungs-E-Mail senden';
    $('mBewertung').classList.add('show');
}

async function sendBewertung(){
    var email=$('bewEmail').value.trim();
    var msg=$('bewMsg').value.trim();
    var st=$('bewStatus');
    if(!email){st.innerHTML='<span style="color:#dc2626">Bitte E-Mail-Adresse eingeben.</span>';return;}
    if(!msg){st.innerHTML='<span style="color:#dc2626">Bitte Nachricht eingeben.</span>';return;}
    var b=$('bewSend');b.disabled=true;b.textContent='Wird gesendet...';st.innerHTML='';
    var l=leads.find(x=>x.id===curLead);
    try{
        emailjs.init('fc6zzeTCmrKyrkxJ2');
        await emailjs.send('service_te0rxxz','template_oyi750j',{
            to_email:email,
            kunde_name:l?.name||'',
            firma_name:tname||'Hausmeisterservice Sykora',
            nachricht:msg,
            booking_link:GOOGLE_REVIEW_URL
        });
        var noteEntry='['+new Date().toLocaleDateString('de-DE')+'] Bewertungs-E-Mail gesendet an '+email;
        if(curLead){await sU('leads',curLead,{notes:(l?.notes?l.notes+'\n':'')+noteEntry,updated_at:new Date().toISOString()});}
        st.innerHTML='<span style="color:#16a34a">\u2713 Bewertungs-E-Mail erfolgreich gesendet!</span>';
        setTimeout(function(){$('mBewertung').classList.remove('show');loadLeads();},1500);
    }catch(e){st.innerHTML='<span style="color:#dc2626">Fehler: '+e.message+'</span>';}
    b.disabled=false;b.textContent='\u2b50 Bewertungs-E-Mail senden';
}

// ===== FOLLOW-UP =====
function openFollowUp(id){
    curLead=id;
    const l=leads.find(x=>x.id===id);
    $('fuEmail').value=l?.email||'';
    $('fuBetreff').value='Nachfrage zu unserem Angebot'+(l?.offer_amount?' \u00fcber '+parseFloat(l.offer_amount).toLocaleString('de-DE')+' \u20ac':'');
    var name=l?.name||'';
    var anrede=name?('Sehr geehrte/r '+name+','):'Sehr geehrte Damen und Herren,';
    var angText=l?.service_type?(' f\u00fcr '+l.service_type):'';
    var sentDate=l?.offer_sent_at?new Date(l.offer_sent_at).toLocaleDateString('de-DE'):'';
    var sentRef=sentDate?(' vom '+sentDate):'';
    $('fuMsg').value=anrede+'\n\nvor einiger Zeit hatten wir Ihnen unser Angebot'+angText+sentRef+' zukommen lassen.\n\nGerne m\u00f6chten wir bei Ihnen nachfragen, ob Sie Fragen zu unserem Angebot haben oder ob wir dieses f\u00fcr Sie anpassen d\u00fcrfen.\n\nWir w\u00fcrden uns sehr freuen, Sie als Kunden zu gewinnen.\n\nSie erreichen uns jederzeit telefonisch unter 08092/25048-30 oder per E-Mail.\n\nGl\u00e4nzende Gr\u00fc\u00dfe\n'+(tname||'Hausmeisterservice Sykora');
    $('fuFile').value='';
    $('fuFileName').textContent='';
    $('fuStatus').innerHTML='';
    $('fuSend').disabled=false;
    $('fuSend').textContent='\ud83d\udce7 Follow-Up senden';
    $('mFollowUp').classList.add('show');
}

async function sendFollowUp(){
    var email=$('fuEmail').value.trim();
    var betreff=$('fuBetreff').value.trim();
    var msg=$('fuMsg').value.trim();
    var st=$('fuStatus');
    if(!email){st.innerHTML='<span style="color:#dc2626">Bitte E-Mail-Adresse eingeben.</span>';return;}
    if(!msg){st.innerHTML='<span style="color:#dc2626">Bitte Nachricht eingeben.</span>';return;}
    var b=$('fuSend');b.disabled=true;b.textContent='Wird gesendet...';st.innerHTML='';
    var l=leads.find(x=>x.id===curLead);
    try{
        var attachUrl='';
        var fileInput=$('fuFile');
        if(fileInput.files&&fileInput.files.length>0){
            var file=fileInput.files[0];
            var fname='followup_'+Date.now()+'_'+file.name.replace(/[^a-zA-Z0-9._-]/g,'_');
            var upRes=await fetch(SB+'/storage/v1/object/angebote/'+encodeURIComponent(fname),{method:'POST',headers:{'Authorization':'Bearer '+SK,'Content-Type':file.type},body:file});
            if(!upRes.ok){var ub=await upRes.json();if(ub.error==='Duplicate'){await fetch(SB+'/storage/v1/object/angebote/'+encodeURIComponent(fname),{method:'PUT',headers:{'Authorization':'Bearer '+SK,'Content-Type':file.type},body:file});}}
            attachUrl=SB+'/storage/v1/object/public/angebote/'+encodeURIComponent(fname);
        }
        var fullMsg=msg;
        if(attachUrl){fullMsg+='\n\nAnhang: '+attachUrl;}
        emailjs.init('fc6zzeTCmrKyrkxJ2');
        await emailjs.send('service_te0rxxz','template_oyi750j',{
            to_email:email,
            kunde_name:l?.name||'',
            firma_name:tname||'Hausmeisterservice Sykora',
            nachricht:fullMsg,
            booking_link:''
        });
        var noteEntry='['+new Date().toLocaleDateString('de-DE')+'] Follow-Up gesendet an '+email+(attachUrl?' (mit Anhang)':'');
        if(curLead){await sU('leads',curLead,{notes:(l?.notes?l.notes+'\n':'')+noteEntry,updated_at:new Date().toISOString()});}
        st.innerHTML='<span style="color:#16a34a">\u2713 Follow-Up erfolgreich gesendet!</span>';
        setTimeout(function(){$('mFollowUp').classList.remove('show');loadLeads();},1500);
    }catch(e){st.innerHTML='<span style="color:#dc2626">Fehler: '+e.message+'</span>';}
    b.disabled=false;b.textContent='\ud83d\udce7 Follow-Up senden';
}

chkSession();
</script>
</body>
</html>
